<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staff Roster Management System (With Break Times in Exports)</title>
  
  <!-- External libraries for Excel and PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* Basic page styling */
    body { 
      font-family: Arial, sans-serif; 
      padding: 20px; 
      text-align: center;
      font-size: 14px;
      background-color: #f3f4f6;
      margin: 0; 
    }
    h2 { 
      color: #1a1a1a; 
      margin-bottom: 25px; 
    }
    
    /* Styling for the date/day/staff count section */
    .date-container {
      margin: 20px 0;
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    .date-container > div {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Table styling */
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin: 20px 0;
      background: white;
    }
    th, td { 
      border: 1px solid #ddd; 
      padding: 8px; 
      text-align: center; 
    }
    th { background-color: #f4f4f4; }
    input, select { 
      padding: 4px; 
      text-align: center;
      font-size: 12px;
    }
    
    /* Button container and styles */
    .button-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 12px 0;
      align-items: center;
    }
    .button-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .roster-btn {
      background-color: #6B7280;
      color: white;
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }
    .roster-btn:hover {
      background-color: #4B5563;
    }
    .remove-btn {
      background-color: #6B7280;
      color: white;
      padding: 1px 6px;
      font-size: 11px;
      border-radius: 3px;
      border: none;
      cursor: pointer;
    }
    
    /* Misc styling for break-time container and shortfall notes */
    .break-time-container { 
      display: flex; 
      align-items: center; 
      gap: 5px;
    }
    .shortfall-note {
      color: red;
      font-weight: bold;
      font-size: 12px;
    }
    
    /* Hide the file input for import */
    #importFile {
      display: none;
    }
    
    /* Let the roster container scroll horizontally if needed */
    #rosterContainer {
      overflow-x: auto;
    }
    
    /* Slightly smaller font for inputs */
    .staff-input, .time-input, .staff-select {
      font-size: 12px;
    }
  </style>
</head>

<body>
  <h2>Staff Roster Management System (With Break Times in Exports)</h2>

  <!-- Date, Day, and Working Staff Count -->
  <div class="date-container">
    <div>
      <label for="rosterDate">Date:</label>
      <input type="date" id="rosterDate">
    </div>
    <div>
      <label for="rosterDay">Day:</label>
      <select id="rosterDay">
        <option value="Monday">Monday</option>
        <option value="Tuesday">Tuesday</option>
        <option value="Wednesday">Wednesday</option>
        <option value="Thursday">Thursday</option>
        <option value="Friday">Friday</option>
        <option value="Saturday">Saturday</option>
        <option value="Sunday">Sunday</option>
      </select>
    </div>
    <!-- Display number of working staff (attendance = "Yes") -->
    <div>
      <label>Working Staff:</label>
      <span id="staffCount">0</span>
    </div>
  </div>

  <!-- Staff Table: add/edit staff data -->
  <table id="staffTable">
    <thead>
      <tr>
        <th>Staff ID</th>
        <th>Name</th>
        <th>Break Time</th>
        <th>HHMD Eligible</th>
        <th>Attendance</th>
        <th>Lock</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Buttons for various actions -->
  <div class="button-container">
    <div class="button-row">
      <button class="roster-btn" id="addStaffBtn">Add Staff</button>
      <button class="roster-btn" id="importDataBtn">Import Data</button>
      <button class="roster-btn" id="exportDataBtn">Export Data</button>
    </div>
    <div class="button-row">
      <button class="roster-btn" id="generateRosterBtn">Generate Roster</button>
      <button class="roster-btn" id="copyTSVBtn">Copy Roster</button>
    </div>
    <div class="button-row">
      <button class="roster-btn" id="downloadExcelBtn">Excel</button>
      <button class="roster-btn" id="downloadCSVBtn">CSV</button>
      <button class="roster-btn" id="downloadPDFBtn">PDF</button>
    </div>
  </div>

  <!-- Hidden file input for importData() -->
  <input type="file" id="importFile" accept=".json" />

  <!-- Where the generated roster (editable table) is displayed -->
  <h3>Generated Roster</h3>
  <div id="rosterContainer"></div>

  <!-- Notes & Shortfalls appear here -->
  <h4>Notes & Shortfalls</h4>
  <div id="notesContainer"></div>

  <script>
    /************************************************************
     * Roster System with Download Implementation
     * 
     * This version includes code to download CSV, Excel, and PDF
     * with staff break times appended at the bottom of each file.
     ************************************************************/

    // -----------------------
    // Core Constants
    // -----------------------
    const STORAGE_KEY = 'staffListData';

    // Define the time slots for the roster
    const ROSTER_TIMES = [
      "20:00", "20:30", "21:00", "22:00", "23:00",
      "00:00", "01:00", "01:30", "02:00", "03:00",
      "04:00", "05:00", "06:00", "07:00", "07:30"
    ];

    // Define priority locations and how many staff are needed
    const PRIORITY = [
      { location: "Pass Counter", needed: 2 },
      { location: "HHMD", needed: 1 },
      { location: "Lobby", needed: 2 },
      { location: "Guard House", needed: 1 },
      { location: "Vertical Patrol", needed: 1 },
      { location: "Report Room", needed: 1 },
      { location: "Tango Papa", needed: 1 }
    ];

    // The order in which to display final roster rows
    const OUTPUT_ORDER = [
      "Pass Counter", "HHMD", "Lobby", "Guard House",
      "Vertical Patrol", "Report Room", "Tango Papa"
    ];

    // -----------------------
    // Roster System
    // -----------------------
    const rosterSystem = {
      /************************************************
       * 1) Initialization
       ************************************************/
      init: function() {
        // Pre-fill date & day
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('rosterDate').value = today;

        const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        const currentDay = days[new Date().getDay()];
        document.getElementById('rosterDay').value = currentDay;

        // Auto-update "Day" whenever "Date" changes
        document.getElementById('rosterDate').addEventListener('change', () => {
          const dateValue = document.getElementById('rosterDate').value;
          const dateObj = new Date(dateValue + 'T00:00:00');
          if (!isNaN(dateObj.getTime())) {
            const dayIndex = dateObj.getDay();
            document.getElementById('rosterDay').value = days[dayIndex];
          }
        });

        // Set up button click handlers
        document.getElementById('addStaffBtn').addEventListener('click', () => this.addStaff());
        document.getElementById('importDataBtn').addEventListener('click', () => this.importData());
        document.getElementById('exportDataBtn').addEventListener('click', () => this.exportData());
        document.getElementById('generateRosterBtn').addEventListener('click', () => this.generateRoster());
        document.getElementById('copyTSVBtn').addEventListener('click', () => this.copyTSV());
        document.getElementById('downloadExcelBtn').addEventListener('click', () => this.downloadRoster('excel'));
        document.getElementById('downloadCSVBtn').addEventListener('click', () => this.downloadRoster('csv'));
        document.getElementById('downloadPDFBtn').addEventListener('click', () => this.downloadRoster('pdf'));

        // Load staff data from localStorage (or create a blank row if none)
        this.loadStaffList();
      },

      /************************************************
       * 2) Loading & Saving Staff
       ************************************************/
      loadStaffList: function() {
        const stored = localStorage.getItem(STORAGE_KEY);
        const tbody = document.getElementById("staffTable").querySelector("tbody");

        if (stored) {
          const staffList = JSON.parse(stored);
          tbody.innerHTML = "";
          staffList.forEach(staff => {
            tbody.innerHTML += this.getStaffRowHTML(staff);
          });
        } else {
          // If no stored data, add a blank row
          this.addStaff();
        }

        this.addListenersToAllRows();
        this.updateStaffCount();
      },

      saveStaffList: function() {
        const staffList = this.getCurrentStaffList();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(staffList));
      },

      // Extract the staff data from the staff table
      getCurrentStaffList: function() {
        const rows = document.getElementById("staffTable").querySelector("tbody").rows;
        const staffList = [];
        for (let row of rows) {
          const staffData = {
            staffID: row.cells[0].querySelector("input").value.trim(),
            name: row.cells[1].querySelector("input").value.trim(),
            breakTime: (
              row.cells[2].querySelectorAll("input[type='time']")[0].value + "-" +
              row.cells[2].querySelectorAll("input[type='time']")[1].value
            ),
            hhmdEligible: row.cells[3].querySelector("select").value,
            attendance: row.cells[4].querySelector("select").value,
            locked: row.cells[5].querySelector("input[type='checkbox']").checked,
            // assigned is stored in <tr data-assigned>, if any
            assigned: row.dataset.assigned ? JSON.parse(row.dataset.assigned) : []
          };
          staffList.push(staffData);
        }
        return staffList;
      },

      /************************************************
       * 3) Staff Table Row Generation
       ************************************************/
      getStaffRowHTML: function(staff = {}) {
        // Default break time if none
        const [startVal, endVal] = staff.breakTime ? staff.breakTime.split("-") : ["21:30", "23:30"];

        return `
          <tr data-assigned='${JSON.stringify(staff.assigned || [])}'>
            <td><input type="text" value="${staff.staffID || ''}" class="staff-input"></td>
            <td><input type="text" value="${staff.name || ''}" class="staff-input"></td>
            <td>
              <div class="break-time-container">
                <input type="time" value="${startVal}" step="1800" class="time-input">
                <span>-</span>
                <input type="time" value="${endVal}" step="1800" class="time-input">
              </div>
            </td>
            <td>
              <select class="staff-select">
                <option value="Yes" ${staff.hhmdEligible==="Yes"?"selected":""}>Yes</option>
                <option value="No"  ${staff.hhmdEligible==="No" ?"selected":""}>No</option>
              </select>
            </td>
            <td>
              <select class="staff-select">
                <option value="Yes" ${staff.attendance==="Yes"?"selected":""}>Yes</option>
                <option value="No"  ${staff.attendance==="No" ?"selected":""}>No</option>
              </select>
            </td>
            <td>
              <input type="checkbox" ${staff.locked ? "checked" : ""}>
            </td>
            <td><button class="remove-btn" data-staff-id="${staff.staffID || ''}">Remove</button></td>
          </tr>
        `;
      },

      addStaff: function() {
        const tbody = document.getElementById("staffTable").querySelector("tbody");
        const newStaff = {
          staffID: "",
          name: "",
          breakTime: "21:30-23:30",
          hhmdEligible: "No",
          attendance: "Yes",
          locked: false,
          assigned: []
        };
        tbody.insertAdjacentHTML("beforeend", this.getStaffRowHTML(newStaff));
        this.addListenersToAllRows();
        this.saveStaffList();
        this.updateStaffCount();
      },

      removeRow: function(button) {
        button.closest("tr").remove();
        this.saveStaffList();
        this.updateStaffCount();
      },

      addListenersToAllRows: function() {
        const tbody = document.getElementById("staffTable").querySelector("tbody");
        const self = this;
        
        // Add event listeners to all inputs and selects in the table
        const inputs = tbody.querySelectorAll("input, select");
        inputs.forEach(inp => {
          inp.addEventListener("change", () => {
            self.saveStaffList();
            self.updateStaffCount();
          });
        });
        
        // Add event listeners to all remove buttons
        const removeButtons = tbody.querySelectorAll(".remove-btn");
        removeButtons.forEach(btn => {
          // Remove old listeners first to prevent duplicates
          btn.removeEventListener("click", btn._clickHandler);
          
          // Add new listener
          btn._clickHandler = function() {
            self.removeRow(this);
          };
          btn.addEventListener("click", btn._clickHandler);
        });
      },

      /************************************************
       * 4) Display the Count of Working Staff
       ************************************************/
      updateStaffCount: function() {
        const staffList = this.getCurrentStaffList();
        const workingCount = staffList.filter(st => st.attendance === "Yes").length;
        document.getElementById("staffCount").textContent = workingCount;
      },
      
      /************************************************
       * 5) Improved Time Handling Functions
       ************************************************/
      // Convert HH:MM to minutes for numerical comparison
      timeToMinutes: function(timeStr) {
        const [hours, minutes] = timeStr.split(":").map(Number);
        // Adjust for times after midnight (20:00 = 0 mins, 00:00 = 240 mins, 07:30 = 690 mins)
        const adjustedHours = hours < 8 ? hours + 24 : hours;
        return (adjustedHours - 20) * 60 + minutes;
      },
      
      // Check if a time slot falls within a staff's break period
      isOnBreak: function(st, slot) {
        const [bStart, bEnd] = st.breakTime.split("-");
        if (!bStart || !bEnd) return false;
        
        const slotMinutes = this.timeToMinutes(slot);
        const breakStartMinutes = this.timeToMinutes(bStart);
        const breakEndMinutes = this.timeToMinutes(bEnd);
        
        return (slotMinutes >= breakStartMinutes && slotMinutes <= breakEndMinutes);
      },
      
      // Check if assigning this time slot would create back-to-back assignments
      isBackToBack: function(st, slot, loc) {
        // Check all existing assignments
        return st.assigned.some(a => {
          if (a.location !== loc) return false;
          const slotIndex = ROSTER_TIMES.indexOf(slot);
          const assignedIndex = ROSTER_TIMES.indexOf(a.slot);
          return Math.abs(slotIndex - assignedIndex) === 1;
        });
      },
      
      // Check if assigning this time would violate the 2-hour gap rule
      violates2HourGap: function(st, slot, loc) {
        const slotMinutes = this.timeToMinutes(slot);
        return st.assigned.some(a => {
          if (a.location !== loc) return false;
          const assignedMinutes = this.timeToMinutes(a.slot);
          const timeDiff = Math.abs(slotMinutes - assignedMinutes);
          return timeDiff < 120 && timeDiff > 0;
        });
      },
      
      // Check if this would create an undesirable consecutive Lobby assignment
      isLobbyRepeat: function(st, slot) {
        const idx = ROSTER_TIMES.indexOf(slot);
        if (idx <= 0) return false;
        const prevSlot = ROSTER_TIMES[idx - 1];
        return st.assigned.some(a => a.slot === prevSlot && a.location === "Lobby");
      },

      /************************************************
       * 6) Improved Staff Eligibility Checking
       ************************************************/
      isStaffEligible: function(st, slot, loc, relaxRules = false) {
        // Basic checks that should never be relaxed
        if (st.attendance !== "Yes") return false;
        if (st.locked && !this.alreadyAssignedSlot(st, slot, loc)) return false;
        if (this.isOnBreak(st, slot)) return false;
        if (st.assigned.some(a => a.slot === slot)) return false;
        if (loc === "HHMD" && st.hhmdEligible !== "Yes") return false;
        
        // Rules that can be relaxed in critical situations
        if (!relaxRules) {
          if (loc !== "Lobby" && this.isBackToBack(st, slot, loc)) return false;
          if (this.violates2HourGap(st, slot, loc)) return false;
        }
        
        return true;
      },
      
      alreadyAssignedSlot: function(st, slot, loc) {
        return st.assigned.some(a => a.slot === slot && a.location === loc);
      },

      /************************************************
       * 7) Improved Staff Selection Logic
       ************************************************/
      pickStaffForSlot: function(staffList, slot, loc) {
        // First attempt: All rules enforced
        for (let st of staffList) {
          if (!this.isStaffEligible(st, slot, loc, false)) continue;
          if (loc === "Lobby" && this.isLobbyRepeat(st, slot)) continue;
          return st;
        }
        
        // Second attempt for Lobby: allow repeats
        if (loc === "Lobby") {
          for (let st of staffList) {
            if (!this.isStaffEligible(st, slot, loc, false)) continue;
            return st;
          }
        }
        
        // Third attempt for critical locations: relax some constraints
        if (["Pass Counter", "HHMD", "Vertical Patrol"].includes(loc)) {
          for (let st of staffList) {
            if (!this.isStaffEligible(st, slot, loc, true)) continue;
            return st;
          }
        }
        
        return null;
      },

      /************************************************
       * 8) Roster Generation
       ************************************************/
      generateRoster: function() {
        const dayValue = document.getElementById("rosterDay").value;
        const isWeekend = (dayValue === "Saturday" || dayValue === "Sunday");

        // Only staff with attendance "Yes"
        let staffList = this.getCurrentStaffList().filter(st => st.attendance === "Yes");
        if (staffList.length === 0) {
          alert("Please add staff members before generating roster.");
          return;
        }

        // Reset assigned if not locked
        staffList.forEach(st => {
          if (!st.locked) st.assigned = [];
        });

        let roster = {};
        let shortfalls = [];

        // Initialize each location in the roster object
        PRIORITY.forEach(({location}) => { roster[location] = {}; });

        // Process each priority location
        for (let p of PRIORITY) {
          let loc = p.location;
          let needed = p.needed;
          
          for (let slot of ROSTER_TIMES) {
            if (!this.locationApplies(loc, slot, isWeekend)) continue;
            if (!roster[loc][slot]) roster[loc][slot] = [];
            let assignedCount = roster[loc][slot].length;
            
            // Determine how many more staff are needed
            let stillNeeded = needed - assignedCount;
            
            // Try multiple passes
            for (let pass = 0; pass < 3; pass++) {
              for (let i = 0; i < stillNeeded; i++) {
                let chosen = null;
                
                if (pass === 0) {
                  // Full rules
                  chosen = this.pickStaffForSlot(staffList, slot, loc);
                } else if (pass === 1) {
                  // Relax back-to-back
                  for (let st of staffList) {
                    if (this.isStaffEligible(st, slot, loc, true)) {
                      chosen = st;
                      break;
                    }
                  }
                } else {
                  // Minimal checks
                  for (let st of staffList) {
                    if (
                      st.attendance === "Yes" && 
                      !this.isOnBreak(st, slot) && 
                      !st.assigned.some(a => a.slot === slot) &&
                      !(loc === "HHMD" && st.hhmdEligible !== "Yes")
                    ) {
                      chosen = st;
                      break;
                    }
                  }
                }
                
                if (chosen) {
                  roster[loc][slot].push(chosen.staffID);
                  chosen.assigned.push({ slot, location: loc });
                  assignedCount++;
                  stillNeeded--;
                } else {
                  // If we can't find anyone, break
                  break;
                }
              }
              if (stillNeeded === 0) break;
            }
            
            // Check shortfall
            if (assignedCount < needed) {
              shortfalls.push(`Shortfall: ${loc} at ${slot} has only ${assignedCount}/${needed} staff`);
              if ((loc === "Pass Counter" && assignedCount < 2) || 
                  (loc === "HHMD" && assignedCount === 0)) {
                shortfalls.push(`CRITICAL: ${loc} at ${slot} is understaffed!`);
              }
            }
          }
        }

        // Check mandatory slots
        this.checkMandatorySlots(roster, shortfalls, isWeekend);

        // Save final assignment
        window.generatedRosterData = {};
        OUTPUT_ORDER.forEach(loc => {
          window.generatedRosterData[loc] = {};
          ROSTER_TIMES.forEach(slot => {
            const assignedIDs = roster[loc][slot] || [];
            window.generatedRosterData[loc][slot] = assignedIDs.join(", ");
          });
        });

        // Sync assigned data back to staff table rows
        this.saveAssignedToRows(staffList);

        // Display the final results (as an editable table)
        this.displayRoster(window.generatedRosterData);
        this.displayNotes(shortfalls);
      },
      
      checkMandatorySlots: function(roster, shortfalls, isWeekend) {
        // Vertical Patrol mandatory time slots
        const vpTimes = ["20:30", "23:00", "01:30", "06:00"];
        for (let vpTime of vpTimes) {
          if (!roster["Vertical Patrol"][vpTime] || roster["Vertical Patrol"][vpTime].length === 0) {
            shortfalls.push(`Missing required Vertical Patrol at ${vpTime}`);
          }
        }
        
        // Report Room (weekdays only)
        if (!isWeekend) {
          const reportTimes = ["20:00", "21:00"];
          for (let rpTime of reportTimes) {
            if (!roster["Report Room"][rpTime] || roster["Report Room"][rpTime].length === 0) {
              shortfalls.push(`Missing required Report Room at ${rpTime}`);
            }
          }
        }
        
        // Tango Papa at 07:30
        if (!roster["Tango Papa"]["07:30"] || roster["Tango Papa"]["07:30"].length === 0) {
          shortfalls.push(`Missing required Tango Papa at 07:30`);
        }
      },

      locationApplies: function(loc, slot, isWeekend) {
        // Tango Papa only at 07:30
        if (loc === "Tango Papa") {
          return slot === "07:30";
        }
        // Pass Counter not needed at 07:30
        if (loc === "Pass Counter" && slot === "07:30") {
          return false;
        }
        // Vertical Patrol only at specific times
        if (loc === "Vertical Patrol") {
          return ["20:30", "23:00", "01:30", "06:00"].includes(slot);
        }
        // Report Room only on weekdays at 20:00 and 21:00
        if (loc === "Report Room") {
          if (isWeekend) return false;
          return ["20:00", "21:00"].includes(slot);
        }
        return true;
      },

      saveAssignedToRows: function(staffList) {
        const rows = document.getElementById("staffTable").querySelector("tbody").rows;
        for (let i = 0; i < rows.length; i++) {
          const staff = staffList.find(s => s.staffID === rows[i].cells[0].querySelector("input").value.trim());
          if (staff) {
            rows[i].dataset.assigned = JSON.stringify(staff.assigned);
          }
        }
        this.saveStaffList();
      },

      /************************************************
       * 9) Displaying the Generated Roster (Editable)
       ************************************************/
      displayRoster: function(roster) {
        const container = document.getElementById("rosterContainer");
        let tableHTML = `<table id="editableRoster"><thead><tr><th>Location</th>`;

        ROSTER_TIMES.forEach(slot => {
          tableHTML += `<th>${slot}</th>`;
        });
        tableHTML += `</tr></thead><tbody>`;

        const isWeekend = ["Saturday", "Sunday"].includes(document.getElementById("rosterDay").value);

        OUTPUT_ORDER.forEach(loc => {
          tableHTML += `<tr data-loc="${loc}"><td>${loc}</td>`;
          ROSTER_TIMES.forEach(slot => {
            const applies = this.locationApplies(loc, slot, isWeekend);
            const cellText = applies ? (roster[loc]?.[slot] || "") : "";
            tableHTML += `
              <td contenteditable="true"
                  data-slot="${slot}"
                  style="min-width:80px; ${!applies ? 'background-color:#f8f8f8;' : ''}">
                ${cellText}
              </td>`;
          });
          tableHTML += `</tr>`;
        });

        tableHTML += `</tbody></table>`;
        container.innerHTML = tableHTML;

        // Add a "Save Edits" button below the roster
        container.insertAdjacentHTML("beforeend", 
          `<button class="roster-btn" id="saveEditsBtn">Save Edits</button>`
        );
        
        // Add click handler for the save button
        document.getElementById("saveEditsBtn").addEventListener("click", () => this.saveEditedRoster());
      },

      displayNotes: function(shortfalls) {
        const notesContainer = document.getElementById("notesContainer");
        if (!shortfalls.length) {
          notesContainer.innerHTML = `<div>No shortfalls detected.</div>`;
        } else {
          notesContainer.innerHTML = shortfalls.map(note => `<div class="shortfall-note">${note}</div>`).join("");
        }
      },

      /************************************************
       * 10) Gathering Data for Exports
       ************************************************/
      // Get the data from the #editableRoster table as a 2D array
      getEditableRosterData: function() {
        const rosterTable = document.getElementById("editableRoster");
        if (!rosterTable) return [];

        const rows = rosterTable.querySelectorAll("tr");
        let data = [];

        rows.forEach((row, rowIndex) => {
          let rowData = [];
          // For each cell in the row
          row.querySelectorAll("th, td").forEach(cell => {
            rowData.push(cell.innerText.trim());
          });
          data.push(rowData);
        });
        return data;
      },

      // Get staff break data as a 2D array
      // (Only for staff with attendance = "Yes")
      getStaffBreakData: function() {
        const staffList = this.getCurrentStaffList();
        const workingStaff = staffList.filter(st => st.attendance === "Yes");

        // We'll create a small table: "Staff ID | Name | Break Time"
        let data = [
          ["Staff ID", "Name", "Break Time"]
        ];
        workingStaff.forEach(st => {
          data.push([st.staffID, st.name, st.breakTime]);
        });

        return data;
      },

      /************************************************
       * 11) Exporting Data
       ************************************************/
      downloadRoster: function(format) {
        // 1) Gather main roster data from the "editableRoster" table
        const rosterData = this.getEditableRosterData(); 
        if (!rosterData.length) {
          alert("No roster data found. Please generate the roster first.");
          return;
        }

        // 2) Gather staff break data
        const breakData = this.getStaffBreakData();

        if (format === "csv") {
          this.downloadAsCSV(rosterData, breakData);
        } else if (format === "excel") {
          this.downloadAsExcel(rosterData, breakData);
        } else if (format === "pdf") {
          this.downloadAsPDF(rosterData, breakData);
        }
      },

      // CSV
      downloadAsCSV: function(rosterData, breakData) {
        // Convert 2D array to CSV string
        const convertToCSV = (arr) => {
          return arr.map(row => row.map(cell => `"${cell}"`).join(",")).join("\n");
        };

        const rosterCSV = convertToCSV(rosterData);
        const breakCSV = convertToCSV(breakData);

        // Combine them with a blank line in between
        const finalCSV = rosterCSV + "\n\n" + "Staff Break Times:\n" + breakCSV;

        // Download as .csv file
        const blob = new Blob([finalCSV], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.setAttribute("download", "Roster_with_Breaks.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      },

      // Excel
      downloadAsExcel: function(rosterData, breakData) {
        // Create a new workbook
        const wb = XLSX.utils.book_new();

        // Convert main roster data to a worksheet
        const rosterSheet = XLSX.utils.aoa_to_sheet(rosterData);
        XLSX.utils.book_append_sheet(wb, rosterSheet, "Roster");

        // Convert break data to another worksheet
        const breakSheet = XLSX.utils.aoa_to_sheet(breakData);
        XLSX.utils.book_append_sheet(wb, breakSheet, "Break Times");

        // Write the workbook as an .xlsx file
        XLSX.writeFile(wb, "Roster_with_Breaks.xlsx");
      },

      // PDF
      downloadAsPDF: function(rosterData, breakData) {
        const { jsPDF } = window.jspdf;

        const doc = new jsPDF({
          orientation: "landscape",
          unit: "pt",
          format: "A4"
        });

        // 1) Main Roster Table
        doc.setFontSize(12);
        doc.text("Roster", 40, 30);

        doc.autoTable({
          startY: 40,
          head: [rosterData[0]],        // first row as the header
          body: rosterData.slice(1),    // rest as body
          margin: { left: 40 },
          theme: 'grid',
          styles: { fontSize: 8 }
        });

        // 2) Staff Break Times Table
        const finalY = doc.autoTable.previous.finalY + 20; // some gap after the first table
        doc.text("Staff Break Times", 40, finalY);

        doc.autoTable({
          startY: finalY + 10,
          head: [breakData[0]],
          body: breakData.slice(1),
          margin: { left: 40 },
          theme: 'grid',
          styles: { fontSize: 8 }
        });

        doc.save("Roster_with_Breaks.pdf");
      },

      /************************************************
       * 12) Misc Functions (Import, Export, Copy, etc.)
       ************************************************/
      importData: function() {
        alert("Import functionality is not implemented in this example.");
      },
      exportData: function() {
        alert("Export functionality is not implemented in this example.");
      },
      copyTSV: function() {
        alert("Copy TSV functionality is not implemented in this example.");
      },
      saveEditedRoster: function() {
        alert("Save edits functionality is not implemented in this example.");
      }
    };

    // Initialize the roster system so all buttons work
    rosterSystem.init();
  </script>
</body>
</html>
