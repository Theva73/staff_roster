<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Staff Roster Management System</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            text-align: center;
            font-size: 14px;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
        }
        th, td { 
            border: 1px solid #ccc; 
            padding: 6px; 
            text-align: center; 
        }
        th { 
            background-color: #f4f4f4; 
        }
        input, select { 
            padding: 4px; 
            text-align: center;
            font-size: 12px;
        }
        .date-container {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        .date-container > div {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .break-time-container { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 5px;
        }
        .button-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin: 16px 0;
            align-items: center;
        }
        .button-row {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        .roster-btn {
            background-color: #6B7280;
            color: white;
            padding: 2px 8px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            min-width: 80px;
            cursor: pointer;
        }
        .roster-btn:hover {
            background-color: #4B5563;
        }
        .remove-btn {
            background-color: #6B7280;
            color: white;
            padding: 1px 6px;
            font-size: 11px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
        }
        .remove-btn:hover {
            background-color: #4B5563;
        }
        #importFile {
            display: none;
        }
        .shortfall-note {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h2>Staff Roster Management System</h2>

    <div class="date-container">
        <div>
            <label for="rosterDate">Date:</label>
            <input type="date" id="rosterDate" />
        </div>
        <div>
            <label for="rosterDay">Day:</label>
            <select id="rosterDay">
                <option value="Monday">Monday</option>
                <option value="Tuesday">Tuesday</option>
                <option value="Wednesday">Wednesday</option>
                <option value="Thursday">Thursday</option>
                <option value="Friday">Friday</option>
                <option value="Saturday">Saturday</option>
                <option value="Sunday">Sunday</option>
            </select>
        </div>
    </div>

    <table id="staffTable">
        <thead>
            <tr>
                <th>Staff ID</th>
                <th>Name</th>
                <th>Break Time</th>
                <th>HHMD Eligible</th>
                <th>Attendance</th>
                <th>Lock</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="button-container">
        <div class="button-row">
            <button class="roster-btn" onclick="addStaff()">Add Staff</button>
            <button class="roster-btn" onclick="importData()">Import Data</button>
        </div>
        <div class="button-row">
            <button class="roster-btn" onclick="generateRoster()">Generate Roster</button>
            <button class="roster-btn" onclick="exportData()">Export Data</button>
            <button class="roster-btn" onclick="copyTSV()">Copy Roster TSV</button>
        </div>
    </div>

    <input type="file" id="importFile" accept=".json">

    <h3>Generated Roster</h3>
    <div id="rosterContainer"></div>

    <h4>Notes & Shortfalls</h4>
    <div id="notesContainer"></div>

<script>
// Constants
const STORAGE_KEY = 'staffListData';
const HALF_HOURS = [
    "20:00","20:30","21:00","21:30","22:00","22:30","23:00","23:30",
    "00:00","00:30","01:00","01:30","02:00","02:30","03:00","03:30",
    "04:00","04:30","05:00","05:30","06:00","06:30","07:00","07:30"
];

const OUTPUT_ORDER = [
    "Vertical Patrol", "Pass Counter", "Lobby", "HHMD",
    "Guard House", "Report Room", "Tango Papa"
];

const PRIORITY = [
    { location: "Pass Counter", needed: 2 },
    { location: "HHMD", needed: 1 },
    { location: "Lobby", needed: 2 },
    { location: "Guard House", needed: 1 },
    { location: "Vertical Patrol", needed: 1 },
    { location: "Report Room", needed: 1 },
    { location: "Tango Papa", needed: 1 }
];

// Initialize the page
window.onload = function() {
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('rosterDate').value = today;
    
    // Set default day based on current day
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const currentDay = days[new Date().getDay()];
    document.getElementById('rosterDay').value = currentDay;
    
    // Load existing staff list
    loadStaffList();
};

// Staff Management Functions
function loadStaffList() {
    const stored = localStorage.getItem(STORAGE_KEY);
    const tbody = document.getElementById("staffTable").getElementsByTagName("tbody")[0];

    if (stored) {
        const staffList = JSON.parse(stored);
        tbody.innerHTML = "";
        staffList.forEach(staff => {
            tbody.innerHTML += getStaffRowHTML(staff);
        });
    } else {
        addStaff(); // Create sample row
    }
    addListenersToAllRows();
}

function addStaff() {
    const tbody = document.getElementById("staffTable").getElementsByTagName("tbody")[0];
    const newStaff = {
        staffID: "",
        name: "",
        breakTime: "21:30-23:30",
        hhmdEligible: "No",
        attendance: "Yes",
        locked: false,
        assigned: []
    };
    tbody.insertAdjacentHTML("beforeend", getStaffRowHTML(newStaff));
    addListenersToAllRows();
    saveStaffList();
}

function removeRow(button) {
    button.closest("tr").remove();
    saveStaffList();
}

function getStaffRowHTML(staff = {}) {
    const [startVal, endVal] = staff.breakTime ? staff.breakTime.split("-") : ["21:30","23:30"];
    return `
        <tr data-assigned='${JSON.stringify(staff.assigned || [])}'>
            <td><input type="text" value="${staff.staffID || ''}" class="staff-input"></td>
            <td><input type="text" value="${staff.name || ''}" class="staff-input"></td>
            <td>
                <div class="break-time-container">
                    <input type="time" value="${startVal}" step="1800" class="time-input">
                    <span>-</span>
                    <input type="time" value="${endVal}" step="1800" class="time-input">
                </div>
            </td>
            <td>
                <select class="staff-select">
                    <option value="Yes" ${staff.hhmdEligible==="Yes"?"selected":""}>Yes</option>
                    <option value="No" ${staff.hhmdEligible==="No"?"selected":""}>No</option>
                </select>
            </td>
            <td>
                <select class="staff-select">
                    <option value="Yes" ${staff.attendance==="Yes"?"selected":""}>Yes</option>
                    <option value="No" ${staff.attendance==="No"?"selected":""}>No</option>
                </select>
            </td>
            <td>
                <input type="checkbox" ${staff.locked?"checked":""}>
            </td>
            <td><button class="remove-btn" onclick="removeRow(this)">Remove</button></td>
        </tr>
    `;
}

function addListenersToAllRows() {
    const tbody = document.getElementById("staffTable").getElementsByTagName("tbody")[0];
    for (let row of tbody.rows) {
        const allInputs = row.querySelectorAll("input, select");
        allInputs.forEach(inp => {
            inp.addEventListener("change", saveStaffList);
        });
    }
}

function saveStaffList() {
    const staffList = getCurrentStaffList();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(staffList));
}

function getCurrentStaffList() {
    const staffList = [];
    const rows = document.getElementById("staffTable").getElementsByTagName("tbody")[0].rows;
    
    for (let row of rows) {
        const staffData = {
            staffID: row.cells[0].querySelector("input").value.trim(),
            name: row.cells[1].querySelector("input").value.trim(),
            breakTime: row.cells[2].querySelectorAll("input[type='time']")[0].value + "-" +
                      row.cells[2].querySelectorAll("input[type='time']")[1].value,
            hhmdEligible: row.cells[3].querySelector("select").value,
            attendance: row.cells[4].querySelector("select").value,
            locked: row.cells[5].querySelector("input[type='checkbox']").checked,
            assigned: row.dataset.assigned ? JSON.parse(row.dataset.assigned) : []
        };
        staffList.push(staffData);
    }
    return staffList;
}

// Data Import/Export Functions
function exportData() {
    const staffList = getCurrentStaffList();
    const dataStr = JSON.stringify(staffList, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `staff_roster_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

function importData() {
    const input = document.getElementById('importFile');
    input.onchange = function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const staffList = JSON.parse(e.target.result);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(staffList));
                loadStaffList();
            } catch (error) {
                alert('Error importing file: ' + error.message);
            }
        };
        
        reader.readAsText(file);
    };
    input.click();
}

function copyTSV() {
    const table = document.querySelector("#rosterContainer table");
    if (!table) {
        alert("Please generate the roster first.");
        return;
    }

    let tsv = '';
    const headers = Array.from(table.querySelectorAll('thead th'))
        .map(th => th.textContent);
    tsv += headers.join('\t') + '\n';

    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const cells = Array.from(row.querySelectorAll('td'))
            .map(td => td.textContent);
        tsv += cells.join('\t') + '\n';
    });

    navigator.clipboard.writeText(tsv).then(() => {
        alert('Roster copied to clipboard in TSV format');
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy roster to clipboard');
    });
}

// Roster Generation Functions
function generateRoster() {
    const dayValue = document.getElementById("rosterDay").value;
    const isWeekend = (dayValue === "Saturday" || dayValue === "Sunday");
    
    let staffList = getCurrentStaffList();
    if (staffList.length === 0) {
        alert("Please add staff members before generating roster.");
        return;
    }

    // Clear previous assignments for unlocked staff
    staffList.forEach(st => {
        if (!st.locked) st.assigned = [];
    });
    
    let roster = {};
    OUTPUT_ORDER.forEach(loc => { roster[loc] = {}; });
    let shortfalls = [];
    
    // Generate assignments
    for (let slot of HALF_HOURS) {
        for (let p of PRIORITY) {
            let loc = p.location;
            if (!locationApplies(loc, slot, isWeekend)) continue;
            
            let needed = p.needed;
            if (!roster[loc][slot]) roster[loc][slot] = [];
            let assignedCount = roster[loc][slot].length;
            
            while (assignedCount < needed) {
                let chosen = pickStaffForSlot(staffList, slot, loc);
                if (!chosen) break;
                roster[loc][slot].push(chosen.staffID);
                chosen.assigned.push({ slot, location: loc });
                assignedCount++;
            }
            
            if ((loc === "Pass Counter" || loc === "Lobby") && assignedCount < needed) {
                shortfalls.push(`Shortfall at ${loc} for ${slot}. Needed ${needed}, got ${assignedCount}.`);
            }
        }
    }
    
    saveAssignedToRows(staffList);
    displayRoster(roster);
    displayNotes(shortfalls);
}

function staffAvailableHalfHour(st, slot) {
    const [bStart, bEnd] = st.breakTime.split("-");
    if (!bStart || !bEnd) return true;
    if (slot >= bStart && slot <= bEnd) return false;
    return true;
}

function isStaffElig