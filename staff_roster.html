

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff Roster Management System</title>
  
  <!-- Add required libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* Existing styles remain the same */
    body { 
      font-family: Arial, sans-serif; 
      padding: 20px; 
      text-align: center;
      font-size: 14px;
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 20px; 
    }
    th, td { 
      border: 1px solid #ccc; 
      padding: 6px; 
      text-align: center; 
    }
    th { 
      background-color: #f4f4f4; 
    }
    
    /* Add new styles for download features */
    .download-container {
      margin: 20px 0;
      padding: 15px;
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 6px;
    }
    
    .download-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 12px;
      color: #374151;
    }
    
    .download-options {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    
    .download-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      background-color: #4B5563;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    
    .download-btn:hover {
      background-color: #374151;
    }
    
    .download-icon {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }
  </style>
</head>
<body>
  <!-- Existing HTML structure remains the same until the rosterContainer -->
  
  <div class="download-container">
    <div class="download-title">Download Roster</div>
    <div class="download-options">
      <button class="download-btn" onclick="window.rosterSystem.downloadRoster('excel')">
        <svg class="download-icon" viewBox="0 0 24 24">
          <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
        </svg>
        Excel (.xlsx)
      </button>
      <button class="download-btn" onclick="window.rosterSystem.downloadRoster('csv')">
        <svg class="download-icon" viewBox="0 0 24 24">
          <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
        </svg>
        CSV
      </button>
      <button class="download-btn" onclick="window.rosterSystem.downloadRoster('pdf')">
        <svg class="download-icon" viewBox="0 0 24 24">
          <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
        </svg>
        PDF
      </button>
    </div>
  </div>

  <!-- Rest of your existing HTML -->
  
  <script>
    // Add these new methods to your existing window.rosterSystem object
    
    window.rosterSystem.downloadRoster = function(format) {
      const table = document.querySelector("#rosterContainer table");
      if (!table) {
        alert("Please generate the roster first.");
        return;
      }

      const date = document.getElementById('rosterDate').value;
      const day = document.getElementById('rosterDay').value;
      
      switch(format) {
        case 'excel':
          this.downloadExcel(table, date, day);
          break;
        case 'csv':
          this.downloadCSV(table, date, day);
          break;
        case 'pdf':
          this.downloadPDF(table, date, day);
          break;
      }
    };

    window.rosterSystem.downloadExcel = function(table, date, day) {
      // Create a new workbook
      const wb = XLSX.utils.book_new();
      
      // Convert table to worksheet
      const ws = XLSX.utils.table_to_sheet(table);
      
      // Add title and date information
      XLSX.utils.sheet_add_aoa(ws, [
        [`Staff Roster - ${day} ${date}`],
        []  // Empty row after title
      ], { origin: 'A1' });
      
      // Get notes if they exist
      const notes = Array.from(document.querySelectorAll('#notesContainer p'))
        .map(p => [p.textContent]);
      
      if (notes.length > 0) {
        XLSX.utils.sheet_add_aoa(ws, [
          ['Notes & Shortfalls:'],
          ...notes
        ], { origin: -1 });  // Append at the end
      }
      
      // Set column widths
      ws['!cols'] = [
        { wch: 15 },  // Location column
        ...Array(24).fill({ wch: 8 })  // Time columns
      ];
      
      // Add the worksheet to workbook
      XLSX.utils.book_append_sheet(wb, ws, 'Roster');
      
      // Save the file
      XLSX.writeFile(wb, `roster_${date}_${day}.xlsx`);
    };

    // Part 1 ends here - continued in Part 2...
  </script>
</body>
</html>

// Continue adding these methods to your window.rosterSystem object

window.rosterSystem.downloadCSV = function(table, date, day) {
  let csv = '';
  
  // Add title and date
  csv += `Staff Roster - ${day} ${date}\n\n`;
  
  // Add table headers
  const headers = Array.from(table.querySelectorAll('thead th'))
    .map(th => `"${th.textContent.trim()}"`)
    .join(',');
  csv += headers + '\n';
  
  // Add table data
  const rows = table.querySelectorAll('tbody tr');
  rows.forEach(row => {
    const cells = Array.from(row.querySelectorAll('td'))
      .map(td => `"${td.textContent.trim()}"`)
      .join(',');
    csv += cells + '\n';
  });
  
  // Add notes if they exist
  const notes = document.querySelectorAll('#notesContainer p');
  if (notes.length > 0) {
    csv += '\nNotes & Shortfalls:\n';
    notes.forEach(note => {
      csv += `"${note.textContent}"\n`;
    });
  }
  
  // Create and trigger download
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `roster_${date}_${day}.csv`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(link.href);
};

window.rosterSystem.downloadPDF = function(table, date, day) {
  // Initialize PDF in landscape mode
  const doc = new jspdf.jsPDF({
    orientation: 'landscape',
    unit: 'pt',
    format: 'a4'
  });
  
  // Add title
  doc.setFontSize(16);
  doc.text(`Staff Roster - ${day} ${date}`, 40, 40);
  
  // Configure table
  doc.autoTable({
    html: table,
    startY: 60,
    styles: {
      fontSize: 8,
      cellPadding: 2,
    },
    columnStyles: {
      0: { cellWidth: 80 }, // Location column
    },
    // Handle headers
    headStyles: {
      fillColor: [244, 244, 244],
      textColor: [0, 0, 0],
      fontSize: 8,
      fontStyle: 'bold',
    },
    // Handle completion of table drawing
    didDrawPage: function(data) {
      // Add notes at the bottom if they exist
      const notes = document.querySelectorAll('#notesContainer p');
      if (notes.length > 0) {
        const finalY = Math.max(data.cursor.y + 20, 500);
        doc.setFontSize(12);
        doc.text('Notes & Shortfalls:', 40, finalY);
        doc.setFontSize(10);
        Array.from(notes).forEach((note, i) => {
          doc.text(note.textContent, 40, finalY + 20 + (i * 15));
        });
      }
    }
  });
  
  // Save the PDF
  doc.save(`roster_${date}_${day}.pdf`);
};

// Add helper function to handle potential errors
window.rosterSystem.handleDownloadError = function(error, format) {
  console.error(`Error generating ${format} file:`, error);
  alert(`Failed to generate ${format} file. Please try again.`);
};

// Enhance the main download function with error handling
window.rosterSystem.downloadRoster = function(format) {
  const table = document.querySelector("#rosterContainer table");
  if (!table) {
    alert("Please generate the roster first.");
    return;
  }

  const date = document.getElementById('rosterDate').value;
  const day = document.getElementById('rosterDay').value;
  
  try {
    switch(format) {
      case 'excel':
        this.downloadExcel(table, date, day);
        break;
      case 'csv':
        this.downloadCSV(table, date, day);
        break;
      case 'pdf':
        this.downloadPDF(table, date, day);
        break;
      default:
        alert("Unsupported format selected");
    }
  } catch (error) {
    this.handleDownloadError(error, format);
  }
};

// Add validation helper
window.rosterSystem.validateTableData = function(table) {
  if (!table.querySelector('thead') || !table.querySelector('tbody')) {
    throw new Error("Invalid table structure");
  }
  return true;
};

// Modify your existing displayRoster function to ensure clean data
window.rosterSystem.displayRoster = function(roster) {
  const container = document.getElementById("rosterContainer");
  let tableHTML = `<table><thead><tr><th>Location</th>`;
  
  HALF_HOURS.forEach(slot => {
    tableHTML += `<th>${slot}</th>`;
  });
  tableHTML += "</tr></thead><tbody>";

  OUTPUT_ORDER.forEach(loc => {
    tableHTML += `<tr><td>${loc}</td>`;
    HALF_HOURS.forEach(slot => {
      const assignments = roster[loc][slot] || [];
      // Ensure clean data for export
      tableHTML += `<td>${assignments.join("/") || ""}</td>`;
    });
    tableHTML += "</tr>";
  });

  tableHTML += "</tbody></table>";
  container.innerHTML = tableHTML;
};