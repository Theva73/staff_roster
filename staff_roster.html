<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daily Roster</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #f5f5f5;
      padding: 15px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    h2 {
      margin: 0;
    }
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-top: 15px;
    }
    .top-bar label {
      font-weight: bold;
    }
    .top-bar input[type="date"],
    .top-bar select {
      padding: 5px;
      text-align: center;
    }
    /* Button bar */
    .button-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 15px 0;
    }
    button {
      background-color: #0066cc;
      color: #fff;
      padding: 10px 20px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background-color: #004a99;
    }
    /* Stats row */
    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .stat-box {
      background-color: #fafafa;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 200px;
      padding: 15px;
      text-align: center;
    }
    .stat-box h4 {
      margin: 0 0 10px;
      font-size: 1.1rem;
    }
    .stat-box p {
      font-size: 1.4rem;
      margin: 0;
      font-weight: bold;
    }
    /* Main content container */
    .content {
      padding: 20px;
    }
    /* Staff Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f4f4f4;
    }
    /* Break time container for drag-and-drop */
    .break-time-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      border: 1px solid #ccc;
      padding: 3px;
      background-color: #fafafa;
    }
    .draggable {
      cursor: move;
    }
    /* Notes */
    .shortfall-note {
      color: red;
      font-weight: bold;
    }
    /* Roster header & table */
    .roster-header {
      margin-top: 30px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .roster-header h3 {
      margin: 0;
    }
    /* "N/A" cells style (read-only) */
    .na-cell {
      background-color: #eee;
      color: #999;
    }
  </style>
</head>
<body>

<header>
  <h2>Daily Roster</h2>
</header>

<div class="content">
  <!-- Date & Day Selection -->
  <div class="top-bar">
    <div>
      <label for="rosterDate">Date:</label>
      <input type="date" id="rosterDate">
    </div>
    <div>
      <label for="rosterDay">Day:</label>
      <select id="rosterDay">
        <option value="Monday">Monday</option>
        <option value="Tuesday">Tuesday</option>
        <option value="Wednesday">Wednesday</option>
        <option value="Thursday">Thursday</option>
        <option value="Friday">Friday</option>
        <option value="Saturday">Saturday</option>
        <option value="Sunday">Sunday</option>
      </select>
    </div>
  </div>

  <!-- Button bar (Add Staff, Export, Import) -->
  <div class="button-bar">
    <button type="button" onclick="addStaff()">Add Staff</button>
    <button type="button" onclick="exportStaffData()">Export</button>
    <button type="button" onclick="document.getElementById('importFile').click()">Import</button>
    <input type="file" id="importFile" accept=".json" onchange="importStaffData(event)" style="display:none;">
  </div>

  <!-- Stats row -->
  <div class="stats-row">
    <div class="stat-box">
      <h4>Coverage</h4>
      <p id="coverage">-</p>
    </div>
    <div class="stat-box">
      <h4>Optimization Score</h4>
      <p id="optimizationScore">-</p>
    </div>
    <div class="stat-box">
      <h4>Total Headcount</h4>
      <!-- Staff Utilization now shows total headcount (Attendance = Yes) -->
      <p id="staffUtilization">-</p>
    </div>
  </div>

  <!-- Staff Table -->
  <table id="staffTable">
    <thead>
      <tr>
        <th>Staff ID</th>
        <th>Name</th>
        <th>Break Time (Start - End)</th>
        <th>HHMD Eligible?</th>
        <th>Attendance</th>
        <th>Constraints</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- Staff rows will be inserted here -->
    </tbody>
  </table>

  <!-- Roster Header (Generate & Copy Buttons) + Editable Roster Table -->
  <div class="roster-header">
    <h3>Generated Roster</h3>
    <button type="button" onclick="generateRoster()">Generate Roster</button>
    <button type="button" onclick="copyTSV()">Copy Roster TSV</button>
  </div>

  <!-- The generated roster table will appear here -->
  <div id="rosterContainer"></div>

  <h4>Notes & Shortfalls</h4>
  <div id="notesContainer"></div>
</div>

<script>
  /*******************************************************
   * GLOBAL CONSTANTS & CONFIG
   *******************************************************/
  const STORAGE_KEY = 'staffListData_StrictRules_Debug';

  // Full half-hour increments from 20:00 to 07:30 (for internal logic)
  const TIME_SLOTS = [
    "20:00","20:30","21:00","21:30","22:00","22:30","23:00","23:30",
    "00:00","00:30","01:00","01:30","02:00","02:30","03:00","03:30",
    "04:00","04:30","05:00","05:30","06:00","06:30","07:00","07:30"
  ];

  // Displayed slots (subset of TIME_SLOTS)
  const DISPLAY_SLOTS = [
    "20:00","20:30","21:00","22:00","23:00",
    "00:00","01:00","01:30","02:00","03:00",
    "04:00","05:00","06:00","06:30","07:00","07:30"
  ];

  // Locations in display order
  const OUTPUT_ORDER = [
    "HHMD",
    "Guard House",
    "Lobby",
    "Pass Counter",
    "Vertical Patrol",
    "Report Room",
    "Tango Papa"
  ];

  // Priority for assignment
  const PRIORITY = [
    { location: "HHMD", needed: 1 },
    { location: "Guard House", needed: 1 },
    { location: "Lobby", needed: 2 },
    { location: "Pass Counter", needed: 2 },
    { location: "Vertical Patrol", needed: 1 },
    { location: "Report Room", needed: 1 },
    { location: "Tango Papa", needed: 1 }
  ];

  // Global variable to store the generated roster for TSV export
  let lastRoster = null;

  /*******************************************************
   * INITIALIZATION
   *******************************************************/
  window.onload = function() {
    loadStaffList();
  };

  /*******************************************************
   * LOAD / SAVE STAFF
   *******************************************************/
  function loadStaffList() {
    let stored = localStorage.getItem(STORAGE_KEY);
    const tbody = document.getElementById("staffTable").querySelector("tbody");
    if (stored) {
      let staffList = [];
      try {
        staffList = JSON.parse(stored);
      } catch (e) {
        console.error("Error parsing stored JSON:", e);
        staffList = [];
      }
      tbody.innerHTML = "";
      staffList.forEach(staff => {
        tbody.insertAdjacentHTML("beforeend", getStaffRowHTML(staff));
      });
    } else {
      // If no data, add one empty staff row by default
      addStaff();
    }
    addListenersToAllRows();
  }

  function saveStaffList() {
    const staffList = [];
    const rows = document.getElementById("staffTable").querySelector("tbody").rows;
    for (let row of rows) {
      const staffID = row.cells[0].querySelector("input").value.trim();
      const name = row.cells[1].querySelector("input").value.trim();

      const timeInputs = row.cells[2].querySelectorAll("input[type='time']");
      const startVal = timeInputs[0].value;
      const endVal   = timeInputs[1].value;
      const breakTime = startVal + "-" + endVal;

      const hhmdEligible = row.cells[3].querySelector("select").value;
      const attendance   = row.cells[4].querySelector("select").value;
      const constraints  = row.cells[5].querySelector("input").value.trim() || "";

      let assigned = row.dataset.assigned ? JSON.parse(row.dataset.assigned) : [];

      staffList.push({
        staffID,
        name,
        breakTime,
        hhmdEligible,
        attendance,
        constraints,
        assigned
      });
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(staffList));
  }

  /*******************************************************
   * STAFF ROW CREATION / REMOVAL
   *******************************************************/
  function getStaffRowHTML(staff) {
    let [startVal, endVal] = staff.breakTime ? staff.breakTime.split("-") : ["21:00","23:00"];
    return `
      <tr data-assigned='${JSON.stringify(staff.assigned || [])}'>
        <td><input type="text" value="${staff.staffID || ''}"></td>
        <td><input type="text" value="${staff.name || ''}"></td>
        <td>
          <div class="break-time-container draggable" draggable="true">
            <input type="time" value="${startVal}" step="1">
            <span>-</span>
            <input type="time" value="${endVal}" step="1">
          </div>
        </td>
        <td>
          <select>
            <option value="Yes" ${staff.hhmdEligible==="Yes" ? "selected" : ""}>Yes</option>
            <option value="No"  ${staff.hhmdEligible==="No"  ? "selected" : ""}>No</option>
          </select>
        </td>
        <td>
          <select>
            <option value="Yes" ${staff.attendance==="Yes" ? "selected" : ""}>Yes</option>
            <option value="No"  ${staff.attendance==="No"  ? "selected" : ""}>No</option>
          </select>
        </td>
        <td>
          <input type="text" value="${staff.constraints || ''}">
        </td>
        <td>
          <button type="button" onclick="removeRow(this)">Remove</button>
        </td>
      </tr>
    `;
  }

  function addStaff() {
    const tbody = document.getElementById("staffTable").querySelector("tbody");
    const newStaff = {
      staffID: "",
      name: "",
      breakTime: "21:00-23:00",
      hhmdEligible: "No",
      attendance: "Yes",
      constraints: "",
      assigned: []
    };
    tbody.insertAdjacentHTML("beforeend", getStaffRowHTML(newStaff));
    addListenersToAllRows();
    saveStaffList();
  }

  function removeRow(button) {
    button.closest("tr").remove();
    saveStaffList();
  }

  /*******************************************************
   * DRAG & DROP SWAP TIME
   *******************************************************/
  let draggedContainer = null;
  function addDragAndDropListeners(element) {
    element.addEventListener("dragstart", function(e) {
      draggedContainer = element;
      e.dataTransfer.effectAllowed = "move";
    });
    element.addEventListener("dragover", function(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";
    });
    element.addEventListener("drop", function(e) {
      e.preventDefault();
      if (draggedContainer && draggedContainer !== element) {
        const sourceTimes = draggedContainer.querySelectorAll("input[type='time']");
        const targetTimes = element.querySelectorAll("input[type='time']");
        let tmpStart = sourceTimes[0].value, tmpEnd = sourceTimes[1].value;
        sourceTimes[0].value = targetTimes[0].value;
        sourceTimes[1].value = targetTimes[1].value;
        targetTimes[0].value = tmpStart;
        targetTimes[1].value = tmpEnd;
        saveStaffList();
      }
    });
  }

  function addListenersToAllRows() {
    const tbody = document.getElementById("staffTable").querySelector("tbody");
    for (let row of tbody.rows) {
      const container = row.cells[2].querySelector(".break-time-container");
      addDragAndDropListeners(container);
      const allInputs = row.querySelectorAll("input, select");
      allInputs.forEach(inp => {
        inp.addEventListener("change", function() {
          saveStaffList();
        });
      });
    }
  }

  /*******************************************************
   * FISHER-YATES SHUFFLE (Round-Robin)
   *******************************************************/
  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      let j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  /*******************************************************
   * GENERATE ROSTER
   *******************************************************/
  function generateRoster() {
    saveStaffList();
    const dayValue = document.getElementById("rosterDay").value;
    const isWeekend = (dayValue === "Saturday" || dayValue === "Sunday");

    let staffList = getCurrentStaffList();
    // Clear previous assignments
    staffList.forEach(st => { st.assigned = []; });
    // Shuffle staff to randomize assignment
    staffList = shuffleArray(staffList);

    let roster = {};
    OUTPUT_ORDER.forEach(loc => { roster[loc] = {}; });
    let shortfalls = [];

    const totalStaffCount = staffList.length;

    // For each half-hour slot, try to fill based on PRIORITY
    for (let slot of TIME_SLOTS) {
      // Re-shuffle staff for each time slot to randomize
      staffList = shuffleArray(staffList);

      let availableStaffForSlot = [...staffList];
      for (let p of PRIORITY) {
        let loc = p.location;
        if (!locationApplies(loc, slot, isWeekend)) continue;

        let needed = p.needed;
        if (!roster[loc][slot]) roster[loc][slot] = [];
        let assignedCount = roster[loc][slot].length;

        while (assignedCount < needed) {
          let chosen = pickStaffForSlot(availableStaffForSlot, slot, loc);
          if (!chosen) break;
          roster[loc][slot].push(chosen.staffID);
          chosen.assigned.push({ slot: slot, location: loc });
          assignedCount++;
          availableStaffForSlot = availableStaffForSlot.filter(st => st.staffID !== chosen.staffID);
        }

        if (assignedCount < needed) {
          shortfalls.push(`Shortfall at ${loc} for ${slot}. Needed ${needed}, got ${assignedCount}.`);
        }
      }
    }

    saveAssignedToRows(staffList);
    displayRoster(roster);
    displayNotes(shortfalls);

    // Update stats
    document.getElementById("coverage").innerText = calculateCoverage(roster);
    document.getElementById("optimizationScore").innerText = calculateOptimizationScore(roster);
    document.getElementById("staffUtilization").innerText = calculateStaffUtilization(staffList);

    // Store the roster for reference if needed
    lastRoster = roster;
  }

  function getCurrentStaffList() {
    let staffList = [];
    const rows = document.getElementById("staffTable").querySelector("tbody").rows;
    for (let row of rows) {
      const staffID = row.cells[0].querySelector("input").value.trim();
      const name = row.cells[1].querySelector("input").value.trim();
      const timeInputs = row.cells[2].querySelectorAll("input[type='time']");
      const startVal = timeInputs[0].value;
      const endVal   = timeInputs[1].value;
      const breakTime = startVal + "-" + endVal;
      const hhmdEligible = row.cells[3].querySelector("select").value;
      const attendance   = row.cells[4].querySelector("select").value;
      const constraints  = row.cells[5].querySelector("input").value.trim() || "";
      let assigned = row.dataset.assigned ? JSON.parse(row.dataset.assigned) : [];

      staffList.push({
        staffID,
        name,
        breakTime,
        hhmdEligible,
        attendance,
        constraints,
        assigned
      });
    }
    return staffList;
  }

  /*******************************************************
   * LOCATION APPLICABILITY
   *******************************************************/
  function locationApplies(loc, slot, isWeekend) {
    // Only top-of-hour for these four
    if (["HHMD","Guard House","Lobby","Pass Counter"].includes(loc)) {
      const topOfHour = [
        "20:00","21:00","22:00","23:00",
        "00:00","01:00","02:00","03:00",
        "04:00","05:00","06:00","07:00"
      ];
      return topOfHour.includes(slot);
    }
    // Vertical Patrol only at these exact times
    if (loc === "Vertical Patrol") {
      return ["20:30","23:00","01:30","06:30"].includes(slot);
    }
    // Report Room only at 20:00 or 21:00 on weekdays
    if (loc === "Report Room") {
      if (isWeekend) return false;
      return (slot === "20:00" || slot === "21:00");
    }
    // Tango Papa only at 07:30
    if (loc === "Tango Papa") {
      return (slot === "07:30");
    }
    return false;
  }

  /*******************************************************
   * STAFF SELECTION & ELIGIBILITY
   *******************************************************/
  function pickStaffForSlot(staffList, slot, loc) {
    for (let st of staffList) {
      if (isStaffEligible(st, slot, loc)) {
        return st;
      }
    }
    return null;
  }

  function isStaffEligible(st, slot, loc) {
    if (st.attendance !== "Yes") return false;
    if (!staffAvailableSlot(st, slot)) return false;
    if (alreadyAssignedSlot(st, slot, loc)) return false;
    if (loc === "HHMD" && st.hhmdEligible !== "Yes") return false;
    if (loc === "Guard House" && violatesOneHourGapForGuardHouse(st, slot)) return false;
    if (isBackToBack(st, slot, loc)) return false;
    if (loc === "Vertical Patrol" && alreadyDidVerticalPatrol(st)) return false;
    return true;
  }

  // SIMPLIFIED to block ANY double assignment in the same time slot
  function alreadyAssignedSlot(st, slot, newLoc) {
    // If staff has ANY assignment in this exact slot, block it
    return st.assigned.some(a => a.slot === slot);
  }

  function alreadyDidVerticalPatrol(st) {
    return st.assigned.some(a => a.location === "Vertical Patrol");
  }

  /*******************************************************
   * BREAK & GAP RULES
   *******************************************************/
  function staffAvailableSlot(st, slot) {
    const [bStart, bEnd] = st.breakTime.split("-");
    if (!bStart || !bEnd) return true;
    let startM = timeToMinutes(bStart);
    let endM   = timeToMinutes(bEnd);
    let slotM  = timeToMinutes(slot);
    // If break crosses midnight, endM < startM
    if (endM < startM) {
      // If slot >= start or slot < end, it's break time
      if (slotM >= startM || slotM < endM) return false;
      return true;
    }
    // Normal break range
    if (slotM >= startM && slotM < endM) return false;
    return true;
  }

  function violatesOneHourGapForGuardHouse(st, slot) {
    let idx = TIME_SLOTS.indexOf(slot);
    for (let i = 1; i <= 2; i++) {
      if (idx - i < 0) break;
      let checkSlot = TIME_SLOTS[idx - i];
      if (st.assigned.some(a => a.slot === checkSlot && a.location === "Guard House")) {
        return true;
      }
    }
    return false;
  }

  function isBackToBack(st, slot, loc) {
    let slotIndex = TIME_SLOTS.indexOf(slot);
    if (slotIndex <= 0) return false;
    let prevSlotIndex = slotIndex - 1;
    if (prevSlotIndex >= 0) {
      let prevSlot = TIME_SLOTS[prevSlotIndex];
      return st.assigned.some(a => a.slot === prevSlot && a.location === loc);
    }
    return false;
  }

  function timeToMinutes(t) {
    let [H, M] = t.split(":");
    return parseInt(H, 10)*60 + parseInt(M, 10);
  }

  /*******************************************************
   * SAVE & DISPLAY ASSIGNMENTS
   *******************************************************/
  function saveAssignedToRows(staffList) {
    const rows = document.getElementById("staffTable").querySelector("tbody").rows;
    for (let i = 0; i < rows.length; i++) {
      rows[i].dataset.assigned = JSON.stringify(staffList[i].assigned);
    }
    saveStaffList();
  }

  // NOTE: We no longer set "contenteditable" on the entire table.
  // Instead, each cell is read-only by default. If locationApplies is false, we show "N/A".
  function displayRoster(roster) {
    const container = document.getElementById("rosterContainer");

    // Check if it's weekend
    const dayValue = document.getElementById("rosterDay").value;
    const isWeekend = (dayValue === "Saturday" || dayValue === "Sunday");

    let tableHTML = `<table><thead><tr><th>Location</th>`;
    DISPLAY_SLOTS.forEach(slot => {
      tableHTML += `<th>${slot}</th>`;
    });
    tableHTML += `</tr></thead><tbody>`;

    OUTPUT_ORDER.forEach(loc => {
      tableHTML += `<tr><td>${loc}</td>`;
      DISPLAY_SLOTS.forEach(slot => {
        const arr = (roster[loc] && roster[loc][slot]) || [];
        const cellText = arr.join("/");

        // If this location/time is valid in the code, show the staff ID(s).
        // Otherwise, show "N/A" with a gray background.
        if (locationApplies(loc, slot, isWeekend)) {
          tableHTML += `<td>${cellText}</td>`;
        } else {
          tableHTML += `<td class="na-cell">N/A</td>`;
        }
      });
      tableHTML += `</tr>`;
    });

    tableHTML += `</tbody></table>`;
    container.innerHTML = tableHTML;
  }

  function displayNotes(shortfalls) {
    const notesDiv = document.getElementById("notesContainer");
    if (shortfalls.length === 0) {
      notesDiv.innerHTML = "<p>No critical shortfalls.</p>";
    } else {
      notesDiv.innerHTML = shortfalls.map(s => `<p class="shortfall-note">${s}</p>`).join("");
    }
  }

  /*******************************************************
   * COPY ROSTER AS TSV TO CLIPBOARD
   *******************************************************/
  function copyTSV() {
    const rosterTable = document.querySelector("#rosterContainer table");
    if (!rosterTable) {
      alert("No roster found. Please generate the roster first.");
      return;
    }
    let tsv = "";
    const rows = rosterTable.querySelectorAll("tr");
    rows.forEach(row => {
      const cells = row.querySelectorAll("th, td");
      let rowData = [];
      cells.forEach(cell => {
        rowData.push(cell.innerText.trim());
      });
      tsv += rowData.join("\t") + "\n";
    });
    navigator.clipboard.writeText(tsv).then(function() {
      alert("Roster TSV copied to clipboard!");
    }, function(err) {
      alert("Error copying TSV: " + err);
    });
  }

  /*******************************************************
   * EXPORT & IMPORT STAFF DATA
   *******************************************************/
  function exportStaffData() {
    const data = localStorage.getItem(STORAGE_KEY);
    if (!data) {
      alert("No staff data found in localStorage.");
      return;
    }
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'StaffDataBackup.json';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  function importStaffData(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const importedData = JSON.parse(e.target.result);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(importedData));
        alert("Staff data imported successfully. Refresh the page to see changes.");
      } catch (err) {
        alert("Error importing data: " + err.message);
      }
    };
    reader.readAsText(file);
  }

  /*******************************************************
   * PLACEHOLDER CALCULATIONS FOR THE STATS
   *******************************************************/
  function calculateCoverage(roster) {
    let totalAssigned = 0;
    let totalNeeded = 0;
    // For coverage, we consider all possible times (weekend or not)
    PRIORITY.forEach(p => {
      TIME_SLOTS.forEach(ts => {
        // Count if locationApplies for EITHER weekend or weekday
        if (locationApplies(p.location, ts, false) || locationApplies(p.location, ts, true)) {
          totalNeeded += p.needed;
          let assignedArr = (roster[p.location] && roster[p.location][ts]) || [];
          totalAssigned += assignedArr.length;
        }
      });
    });
    return `${totalAssigned}/${totalNeeded}`;
  }

  function calculateOptimizationScore(roster) {
    // You can add your custom logic here
    return "N/A";
  }

  // Count staff with Attendance = "Yes"
  function calculateStaffUtilization(staffList) {
    const yesCount = staffList.filter(st => st.attendance === "Yes").length;
    return yesCount.toString();
  }
</script>
</body>
</html>