<script>
    // Constants
    const STORAGE_KEY = 'staffListData';
    const HALF_HOURS = [
        "20:00","20:30","21:00","21:30","22:00","22:30","23:00","23:30",
        "00:00","00:30","01:00","01:30","02:00","02:30","03:00","03:30",
        "04:00","04:30","05:00","05:30","06:00","06:30","07:00","07:30"
    ];

    const LOCATIONS = [
        "Vertical Patrol", "Pass Counter", "Lobby", "HHMD",
        "Guard House", "Report Room", "Tango Papa"
    ];

    let rosterData = {};

    // Initialize page
    window.onload = function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('rosterDate').value = today;
        
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const currentDay = days[new Date().getDay()];
        document.getElementById('rosterDay').value = currentDay;
        
        loadStaffList();
    };

    // Staff Management Functions (addStaff, removeStaff, getStaffList, loadStaffList, saveStaffList, importStaffData, exportStaffData)
    // ... [existing staff management functions remain unchanged] ...

    // ***************** Refined Roster Generation Logic *****************

    // Generate and Display Roster using refined logic
    function generateRoster() {
        const staffList = getStaffList();
        if (staffList.length === 0) {
            alert('Please add staff members first.');
            return;
        }

        // Initialize empty roster structure
        const roster = {};
        LOCATIONS.forEach(loc => {
            roster[loc] = {};
            HALF_HOURS.forEach(time => {
                roster[loc][time] = '';
            });
        });

        // Filter available staff (attendance = Yes)
        const availableStaff = staffList.filter(staff => staff.attendance === 'Yes');
        
        // Loop through each time slot and assign staff based on location-specific requirements
        HALF_HOURS.forEach(timeSlot => {
            // Vertical Patrol - specific times only
            if (['20:00', '23:00', '01:00', '06:00'].includes(timeSlot)) {
                const eligibleStaff = availableStaff.filter(staff => 
                    !isOnBreak(staff, timeSlot) &&
                    !isAssignedNearby(roster, staff.id, timeSlot)
                );
                if (eligibleStaff.length > 0) {
                    roster['Vertical Patrol'][timeSlot] = eligibleStaff[0].id;
                }
            }

            // HHMD - requires eligible staff (marked as "Yes")
            const hhmdStaff = availableStaff.filter(staff => 
                staff.hhmdEligible === 'Yes' &&
                !isOnBreak(staff, timeSlot) &&
                !isAssignedNearby(roster, staff.id, timeSlot)
            );
            if (hhmdStaff.length > 0) {
                roster['HHMD'][timeSlot] = hhmdStaff[0].id;
            }

            // Pass Counter - needs 2 staff; assign as "id1/id2"
            const passStaff = availableStaff.filter(staff => 
                !isOnBreak(staff, timeSlot) &&
                !isAssignedNearby(roster, staff.id, timeSlot)
            );
            if (passStaff.length >= 2) {
                roster['Pass Counter'][timeSlot] = `${passStaff[0].id}/${passStaff[1].id}`;
            }

            // Other locations: Lobby, Guard House, Report Room, Tango Papa
            ['Lobby', 'Guard House', 'Report Room', 'Tango Papa'].forEach(location => {
                const remainingStaff = availableStaff.filter(staff => 
                    !isOnBreak(staff, timeSlot) &&
                    !isAssignedNearby(roster, staff.id, timeSlot) &&
                    !isAssignedAnywhere(roster, staff.id, timeSlot)
                );
                if (remainingStaff.length > 0) {
                    roster[location][timeSlot] = remainingStaff[0].id;
                }
            });
        });

        displayRoster(roster);
        rosterData = roster; // Save the roster data for download functions
    }

    // Helper function to check if a staff member is on break at a given time
    function isOnBreak(staff, timeSlot) {
        const time = new Date(`2000-01-01T${timeSlot}`);
        const breakStart = new Date(`2000-01-01T${staff.breakStart}`);
        const breakEnd = new Date(`2000-01-01T${staff.breakEnd}`);
        return time >= breakStart && time <= breakEnd;
    }

    // Helper function to check if a staff member is assigned in a nearby time slot
    function isAssignedNearby(roster, staffId, timeSlot) {
        const timeIndex = HALF_HOURS.indexOf(timeSlot);
        const nearbySlots = HALF_HOURS.slice(
            Math.max(0, timeIndex - 1),
            Math.min(HALF_HOURS.length, timeIndex + 2)
        );
        
        return Object.values(roster).some(location =>
            nearbySlots.some(slot =>
                location[slot]?.includes(staffId)
            )
        );
    }

    // Helper function to check if a staff member is assigned at the same time anywhere in the roster
    function isAssignedAnywhere(roster, staffId, timeSlot) {
        return Object.values(roster).some(location =>
            location[timeSlot]?.includes(staffId)
        );
    }

    // ***************** End of Refined Roster Generation Logic *****************

    // Function to display the roster on the page (remains unchanged)
    function displayRoster(roster) {
        const output = document.getElementById('rosterOutput');
        let html = '<table class="staff-table"><thead><tr><th>Location</th>';
        
        HALF_HOURS.forEach(time => {
            html += `<th>${time}</th>`;
        });
        
        html += '</tr></thead><tbody>';
        
        LOCATIONS.forEach(location => {
            html += `<tr><td>${location}</td>`;
            HALF_HOURS.forEach(time => {
                html += `<td>${roster[location][time] || ''}</td>`;
            });
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        output.innerHTML = html;
    }

    // Download Functions (downloadExcel, downloadCSV, downloadPDF)
    // ... [existing download functions remain unchanged] ...
</script>