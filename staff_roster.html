<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Advanced One-Hour Roster (Debug Mode)</title>
  <style>
    body {
      font-family: Arial, sans-serif; 
      padding: 20px; 
      text-align: center;
    }
    table {
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc; 
      padding: 8px; 
      text-align: center;
    }
    th {
      background-color: #f4f4f4;
    }
    button {
      padding: 10px; 
      margin: 10px; 
      cursor: pointer;
    }
    input, select {
      padding: 5px; 
      text-align: center;
    }
    .inline-block {
      display: inline-block; 
      margin: 10px;
    }
    .break-time-container { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 5px; 
      border: 1px solid #ccc;
      padding: 3px;
      background-color: #fafafa;
    }
    .draggable {
      cursor: move;
    }
    .shortfall-note {
      color: red; 
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h2>Advanced One-Hour Roster (Debug Mode)</h2>

  <!-- Date & Day Selection -->
  <div class="inline-block">
    <label for="rosterDate">Date:</label>
    <input type="date" id="rosterDate" />
  </div>
  <div class="inline-block">
    <label for="rosterDay">Day:</label>
    <select id="rosterDay">
      <option value="Monday">Monday</option>
      <option value="Tuesday">Tuesday</option>
      <option value="Wednesday">Wednesday</option>
      <option value="Thursday">Thursday</option>
      <option value="Friday">Friday</option>
      <option value="Saturday">Saturday</option>
      <option value="Sunday">Sunday</option>
    </select>
  </div>

  <!-- Staff Table -->
  <table id="staffTable">
    <thead>
      <tr>
        <th>Staff ID</th>
        <th>Name</th>
        <th>Break Time (Start - End)</th>
        <th>HHMD Eligible?</th>
        <th>Attendance</th>
        <th>Lock</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <!-- Rows will be loaded from localStorage or a sample row is created -->
    </tbody>
  </table>

  <!-- Roster Buttons -->
  <button type="button" onclick="addStaff()">Add Staff</button>
  <button type="button" onclick="generateRoster()">Generate Roster</button>
  <button type="button" onclick="sendWhatsApp()">Send via WhatsApp</button>

  <!-- Export / Import Buttons -->
  <button type="button" onclick="exportStaffData()">Export Staff Data</button>
  <input type="file" id="importFile" accept=".json" onchange="importStaffData(event)" style="display:none;" />
  <button type="button" onclick="document.getElementById('importFile').click()">Import Staff Data</button>

  <h3>Generated Staff Roster</h3>
  <div id="rosterContainer"></div>

  <h4>Notes & Shortfalls</h4>
  <div id="notesContainer"></div>

  <script>
    /*******************************************************
     *            GLOBAL CONSTANTS & CONFIG
     *******************************************************/
    const STORAGE_KEY = 'staffListData_OneHour_Debug';

    // One-hour increments from 20:00 to 07:00, plus an extra slot at 07:30 for Tango Papa.
    const TIME_SLOTS = [
      "20:00", "21:00", "22:00", "23:00",
      "00:00", "01:00", "02:00", "03:00",
      "04:00", "05:00", "06:00", "07:00", "07:30"
    ];

    // Locations (rows) in final display
    const OUTPUT_ORDER = [
      "Vertical Patrol",
      "Lobby",
      "Pass Counter",
      "HHMD",
      "Guard House",
      "Report Room",
      "Tango Papa"
    ];

    // Priority array with Lobby first so it gets staffed first
    const PRIORITY = [
      { location: "Lobby",          needed: 2 },
      { location: "Pass Counter",   needed: 2 },
      { location: "HHMD",           needed: 1 },
      { location: "Guard House",    needed: 1 },
      { location: "Vertical Patrol",needed: 1 },
      { location: "Report Room",    needed: 1 },
      { location: "Tango Papa",     needed: 1 }
    ];

    /*******************************************************
     *            INITIALIZATION (ON LOAD)
     *******************************************************/
    window.onload = function() {
      loadStaffList();
    };

    /*******************************************************
     *            LOAD/SAVE STAFF
     *******************************************************/
    function loadStaffList() {
      let stored = null;
      try {
        stored = localStorage.getItem(STORAGE_KEY);
      } catch(e) {
        console.error("Error accessing localStorage:", e);
      }
      const tbody = document.getElementById("staffTable").querySelector("tbody");

      if (stored) {
        let staffList = [];
        try {
          staffList = JSON.parse(stored);
        } catch(e) {
          console.error("Error parsing stored JSON:", e);
          staffList = [];
        }
        tbody.innerHTML = "";
        staffList.forEach(staff => {
          tbody.insertAdjacentHTML("beforeend", getStaffRowHTML(staff));
        });
      } else {
        // No stored data: add one sample row
        addStaff();
      }
      addListenersToAllRows();
    }

    function saveStaffList() {
      const staffList = [];
      const rows = document.getElementById("staffTable").querySelector("tbody").rows;

      for (let row of rows) {
        const staffID = row.cells[0].querySelector("input").value.trim();
        const name = row.cells[1].querySelector("input").value.trim();

        const timeInputs = row.cells[2].querySelectorAll("input[type='time']");
        const startVal = timeInputs[0].value;
        const endVal = timeInputs[1].value;
        const breakTime = startVal + "-" + endVal;

        const hhmdEligible = row.cells[3].querySelector("select").value;
        const attendance = row.cells[4].querySelector("select").value;
        const locked = row.cells[5].querySelector("input[type='checkbox']").checked;
        let workedLastTwoDays = row.dataset.worked ? JSON.parse(row.dataset.worked) : [];
        let assigned = row.dataset.assigned ? JSON.parse(row.dataset.assigned) : [];

        staffList.push({
          staffID,
          name,
          breakTime,
          hhmdEligible,
          attendance,
          locked,
          workedLastTwoDays,
          assigned
        });
      }

      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(staffList));
      } catch(e) {
        console.error("Error saving to localStorage:", e);
      }
    }

    /*******************************************************
     *         STAFF ROW CREATION/REMOVAL
     *******************************************************/
    function getStaffRowHTML(staff) {
      let [startVal, endVal] = staff.breakTime ? staff.breakTime.split("-") : ["21:00","23:00"];
      return `
        <tr data-worked='${JSON.stringify(staff.workedLastTwoDays || [])}'
            data-assigned='${JSON.stringify(staff.assigned || [])}'>
          <td><input type="text" value="${staff.staffID}"></td>
          <td><input type="text" value="${staff.name}"></td>
          <td>
            <div class="break-time-container draggable" draggable="true">
              <input type="time" value="${startVal}" step="1">
              <span>-</span>
              <input type="time" value="${endVal}" step="1">
            </div>
          </td>
          <td>
            <select>
              <option value="Yes" ${staff.hhmdEligible==="Yes" ? "selected" : ""}>Yes</option>
              <option value="No"  ${staff.hhmdEligible==="No"  ? "selected" : ""}>No</option>
            </select>
          </td>
          <td>
            <select>
              <option ${staff.attendance==="Yes" ? "selected" : ""}>Yes</option>
              <option ${staff.attendance==="No"  ? "selected" : ""}>No</option>
            </select>
          </td>
          <td>
            <input type="checkbox" ${staff.locked ? "checked" : ""}>
          </td>
          <td><button type="button" onclick="removeRow(this)">Remove</button></td>
        </tr>
      `;
    }

    function addStaff() {
      const tbody = document.getElementById("staffTable").querySelector("tbody");
      const newStaff = {
        staffID: "",
        name: "",
        breakTime: "21:00-23:00",
        hhmdEligible: "No",
        attendance: "Yes",
        locked: false,
        workedLastTwoDays: [],
        assigned: []
      };
      tbody.insertAdjacentHTML("beforeend", getStaffRowHTML(newStaff));
      addListenersToAllRows();
      saveStaffList();
    }

    function removeRow(button) {
      button.closest("tr").remove();
      saveStaffList();
    }

    /*******************************************************
     *            DRAG & DROP SWAP TIME
     *******************************************************/
    let draggedContainer = null;

    function addDragAndDropListeners(element) {
      element.addEventListener("dragstart", function(e) {
        draggedContainer = element;
        e.dataTransfer.effectAllowed = "move";
      });

      element.addEventListener("dragover", function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
      });

      element.addEventListener("drop", function(e) {
        e.preventDefault();
        if (draggedContainer && draggedContainer !== element) {
          const sourceTimes = draggedContainer.querySelectorAll("input[type='time']");
          const targetTimes = element.querySelectorAll("input[type='time']");
          let tmpStart = sourceTimes[0].value, tmpEnd = sourceTimes[1].value;
          sourceTimes[0].value = targetTimes[0].value;
          sourceTimes[1].value = targetTimes[1].value;
          targetTimes[0].value = tmpStart;
          targetTimes[1].value = tmpEnd;
          saveStaffList();
        }
      });
    }

    function addListenersToAllRows() {
      const tbody = document.getElementById("staffTable").querySelector("tbody");
      for (let row of tbody.rows) {
        const container = row.cells[2].querySelector(".break-time-container");
        addDragAndDropListeners(container);

        const allInputs = row.querySelectorAll("input, select");
        allInputs.forEach(inp => {
          inp.addEventListener("change", function() {
            saveStaffList();
          });
        });
      }
    }

    /*******************************************************
     *          GENERATE ROSTER (ONE-HOUR)
     *******************************************************/
    function generateRoster() {
      saveStaffList();
      const dayValue = document.getElementById("rosterDay").value;
      const isWeekend = (dayValue === "Saturday" || dayValue === "Sunday");

      let staffList = getCurrentStaffList();
      // Clear assignments for unlocked staff
      staffList.forEach(st => {
        if (!st.locked) {
          st.assigned = [];
        }
      });

      let roster = {};
      OUTPUT_ORDER.forEach(loc => roster[loc] = {});

      let shortfalls = [];

      // Assign in PRIORITY order for each time slot
      for (let slot of TIME_SLOTS) {
        for (let p of PRIORITY) {
          let loc = p.location;
          if (!locationApplies(loc, slot, isWeekend)) continue;

          let needed = p.needed;
          if (!roster[loc][slot]) roster[loc][slot] = [];
          let assignedCount = roster[loc][slot].length;

          while (assignedCount < needed) {
            let chosen = pickStaffForSlot(staffList, slot, loc);
            if (!chosen) {
              break;
            }
            roster[loc][slot].push(chosen.staffID);
            chosen.assigned.push({ slot, location: loc });
            assignedCount++;
          }

          // Mark shortfall for Lobby or Pass Counter
          if ((loc === "Lobby" || loc === "Pass Counter") && assignedCount < needed) {
            shortfalls.push(`Shortfall at ${loc} for ${slot}. Needed ${needed}, got ${assignedCount}.`);
          }
        }
      }

      saveAssignedToRows(staffList);
      displayRoster(roster);
      displayNotes(shortfalls);
    }

    function getCurrentStaffList() {
      let staffList = [];
      const rows = document.getElementById("staffTable").querySelector("tbody").rows;
      for (let row of rows) {
        const staffID = row.cells[0].querySelector("input").value.trim();
        const name = row.cells[1].querySelector("input").value.trim();

        const timeInputs = row.cells[2].querySelectorAll("input[type='time']");
        const startVal = timeInputs[0].value;
        const endVal = timeInputs[1].value;
        const breakTime = startVal + "-" + endVal;

        const hhmdEligible = row.cells[3].querySelector("select").value;
        const attendance = row.cells[4].querySelector("select").value;
        const locked = row.cells[5].querySelector("input[type='checkbox']").checked;
        let workedLastTwoDays = row.dataset.worked ? JSON.parse(row.dataset.worked) : [];
        let assigned = row.dataset.assigned ? JSON.parse(row.dataset.assigned) : [];

        staffList.push({
          staffID,
          name,
          breakTime,
          hhmdEligible,
          attendance,
          locked,
          workedLastTwoDays,
          assigned
        });
      }
      return staffList;
    }

    function locationApplies(loc, slot, isWeekend) {
      if (loc === "Vertical Patrol") {
        return ["20:00","23:00","01:00","06:00"].includes(slot);
      }
      if (loc === "Report Room") {
        // Skip on weekends
        if (isWeekend) return false;
        // Only at 20:00 or 21:00
        return (slot === "20:00" || slot === "21:00");
      }
      if (loc === "Tango Papa") {
        return (slot === "07:30");
      }
      return true;
    }

    function pickStaffForSlot(staffList, slot, loc) {
      // FIRST PASS: if loc=Lobby, skip staff who worked the previous slot in Lobby
      for (let st of staffList) {
        if (!isStaffEligible(st, slot, loc)) continue;
        if (loc === "Lobby" && isLobbyRepeat(st, slot)) {
          continue;
        }
        return st;
      }
      // SECOND PASS: for Lobby, allow repeats
      if (loc === "Lobby") {
        for (let st of staffList) {
          if (!isStaffEligible(st, slot, loc)) continue;
          return st;
        }
      }
      return null;
    }

    function isStaffEligible(st, slot, loc) {
      // If locked & not already assigned, skip
      if (st.locked && !alreadyAssignedSlot(st, slot)) return false;
      // Must be present
      if (st.attendance !== "Yes") return false;
      // Must not be on break
      if (!staffAvailableSlot(st, slot)) return false;
      // Must not already be assigned
      if (alreadyAssignedSlot(st, slot)) return false;
      // Must be HHMD-eligible if location=HHMD
      if (loc === "HHMD" && st.hhmdEligible !== "Yes") return false;
      // If you want a 1-hour gap or no gap, remove or adjust back-to-back below
      if (loc !== "Lobby" && isBackToBack(st, slot, loc)) return false;
      return true;
    }

    function alreadyAssignedSlot(st, slot) {
      return st.assigned.some(a => a.slot === slot);
    }

    function staffAvailableSlot(st, slot) {
      const [bStart, bEnd] = st.breakTime.split("-");
      if (!bStart || !bEnd) return true;
      let startM = timeToMinutes(bStart);
      let endM = timeToMinutes(bEnd);
      let slotM = timeToMinutes(slot);
      if (endM < startM) {
        // If break crosses midnight in a simple way, treat as always available
        return true;
      }
      return !(slotM >= startM && slotM < endM);
    }

    function timeToMinutes(t) {
      let [H, M] = t.split(":");
      return parseInt(H,10)*60 + parseInt(M,10);
    }

    // Simple check for same location in previous slot
    function isBackToBack(st, slot, loc) {
      let idx = TIME_SLOTS.indexOf(slot);
      if (idx <= 0) return false;
      let prevSlot = TIME_SLOTS[idx-1];
      return st.assigned.some(a => a.slot === prevSlot && a.location === loc);
    }

    // If staff worked Lobby in the previous slot, skip them (1st pass only)
    function isLobbyRepeat(st, slot) {
      let idx = TIME_SLOTS.indexOf(slot);
      if (idx <= 0) return false;
      let prevSlot = TIME_SLOTS[idx-1];
      return st.assigned.some(a => a.slot === prevSlot && a.location === "Lobby");
    }

    function saveAssignedToRows(staffList) {
      const rows = document.getElementById("staffTable").querySelector("tbody").rows;
      for (let i = 0; i < rows.length; i++) {
        rows[i].dataset.assigned = JSON.stringify(staffList[i].assigned);
      }
      saveStaffList();
    }

    function displayRoster(roster) {
      const container = document.getElementById("rosterContainer");
      container.innerHTML = "";

      let tableHTML = `<table><thead><tr><th>Location</th>`;
      TIME_SLOTS.forEach(slot => {
        tableHTML += `<th>${slot}</th>`;
      });
      tableHTML += "</tr></thead><tbody>";

      OUTPUT_ORDER.forEach(loc => {
        tableHTML += `<tr><td>${loc}</td>`;
        TIME_SLOTS.forEach(slot => {
          let arr = roster[loc][slot] || [];
          if (arr.length > 1) {
            tableHTML += `<td>${arr.join("/")}</td>`;
          } else if (arr.length === 1) {
            tableHTML += `<td>${arr[0]}</td>`;
          } else {
            tableHTML += `<td></td>`;
          }
        });
        tableHTML += "</tr>";
      });

      tableHTML += "</tbody></table>`;
      container.innerHTML = tableHTML;
    }

    function displayNotes(shortfalls) {
      const notesDiv = document.getElementById("notesContainer");
      if (shortfalls.length === 0) {
        notesDiv.innerHTML = "<p>No critical shortfalls.</p>";
      } else {
        notesDiv.innerHTML = shortfalls.map(s => `<p class="shortfall-note">${s}</p>`).join("");
      }
    }

    /*******************************************************
     *         WHATSAPP SHARING
     *******************************************************/
    function sendWhatsApp() {
      const table = document.querySelector("#rosterContainer table");
      if (!table) {
        alert("Please generate the roster first.");
        return;
      }
      let rosterText = "📋 *Staff Roster (One-Hour)*\n\n";
      const rows = table.querySelectorAll("tbody tr");
      rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        rosterText += `*${cells[0].innerText}*\n`; // location name
        for (let i = 1; i < cells.length; i++) {
          if (cells[i].innerText) {
            const slot = table.querySelector("thead").rows[0].cells[i].innerText;
            rosterText += `- ${cells[i].innerText} at ${slot}\n`;
          }
        }
        rosterText += "\n";
      });
      const whatsappURL = `https://wa.me/?text=${encodeURIComponent(rosterText)}`;
      window.open(whatsappURL, "_blank");
    }

    /*******************************************************
     *         EXPORT & IMPORT STAFF DATA
     *******************************************************/
    // 1. Export Staff Data
    function exportStaffData() {
      const data = localStorage.getItem(STORAGE_KEY);
      if (!data) {
        alert("No staff data found in localStorage.");
        return;
      }
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'StaffDataBackup.json'; // or any name you like
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // 2. Import Staff Data
    function importStaffData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(importedData));
          alert("Staff data imported successfully. Please refresh or re-open the page to see changes.");
        } catch (err) {
          alert("Error importing data: " + err.message);
        }
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>