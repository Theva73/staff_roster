<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Advanced Half-Hour Roster</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f4f4f4; }
    button { padding: 10px; margin: 10px; cursor: pointer; }
    input, select { padding: 5px; text-align: center; }
    .inline-block { display: inline-block; margin: 10px; }
    .break-time-container { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 5px; 
      border: 1px solid #ccc;
      padding: 3px;
      background-color: #fafafa;
    }
    .draggable { cursor: move; }
    .shortfall-note { color: red; font-weight: bold; }
  </style>
</head>
<body>

  <h2>Advanced Half-Hour Roster</h2>

  <!-- Date & Day Selection -->
  <div class="inline-block">
    <label for="rosterDate">Date:</label>
    <input type="date" id="rosterDate" />
  </div>
  <div class="inline-block">
    <label for="rosterDay">Day:</label>
    <select id="rosterDay">
      <option value="Monday">Monday</option>
      <option value="Tuesday">Tuesday</option>
      <option value="Wednesday">Wednesday</option>
      <option value="Thursday">Thursday</option>
      <option value="Friday">Friday</option>
      <option value="Saturday">Saturday</option>
      <option value="Sunday">Sunday</option>
    </select>
  </div>

  <!-- Staff Table -->
  <table id="staffTable">
    <thead>
      <tr>
        <th>Staff ID</th>
        <th>Name</th>
        <th>Break Time (Start - End)</th>
        <th>HHMD Eligible?</th>
        <th>Attendance</th>
        <th>Lock</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <!-- Rows will be loaded from localStorage or a sample row is created -->
    </tbody>
  </table>

  <button onclick="addStaff()">Add Staff</button>
  <button onclick="generateRoster()">Generate Roster</button>
  <button onclick="sendWhatsApp()">Send via WhatsApp</button>

  <h3>Generated Staff Roster</h3>
  <div id="rosterContainer"></div>

  <h4>Notes & Shortfalls</h4>
  <div id="notesContainer"></div>

  <script>
    /*******************************************************
     *            GLOBAL CONSTANTS & CONFIG
     *******************************************************/
    const STORAGE_KEY = 'staffListData_HalfHour';

    // We list half-hour increments from 20:00 up to 07:30 next day (24 slots total).
    const HALF_HOURS = [
      "20:00","20:30","21:00","21:30","22:00","22:30","23:00","23:30",
      "00:00","00:30","01:00","01:30","02:00","02:30","03:00","03:30",
      "04:00","04:30","05:00","05:30","06:00","06:30","07:00","07:30"
    ];

    // Output order (7 rows)
    const OUTPUT_ORDER = [
      "Vertical Patrol",
      "Pass Counter",
      "Lobby",
      "HHMD",
      "Guard House",
      "Report Room",
      "Tango Papa"
    ];

    // Priority for each half-hour:
    //  1. Pass Counter (2 staff)
    //  2. HHMD (1 staff, must be HHMD=Yes)
    //  3. Lobby (2 staff, half-hour increments)
    //  4. Guard House (1 staff)
    //  5. Vertical Patrol (only if 20:00, 23:00, 01:00, 06:00)
    //  6. Report Room (only if 20:00, 21:00; skip Sat/Sun)
    //  7. Tango Papa (only if 07:30)
    const PRIORITY = [
      { location: "Pass Counter", needed: 2 },
      { location: "HHMD",        needed: 1 },
      { location: "Lobby",       needed: 2 },
      { location: "Guard House", needed: 1 },
      { location: "Vertical Patrol", needed: 1 },
      { location: "Report Room",     needed: 1 },
      { location: "Tango Papa",      needed: 1 }
    ];

    // Some location constraints:
    // - Vertical Patrol: only at 20:00,23:00,01:00,06:00
    // - Report Room: only at 20:00 & 21:00, skip weekends
    // - Tango Papa: only at 07:30

    /*******************************************************
     *            ON LOAD: READ LOCALSTORAGE
     *******************************************************/
    window.onload = function() {
      loadStaffList();
    };

    /*******************************************************
     *            LOAD/SAVE STAFF
     *******************************************************/
    function loadStaffList() {
      const stored = localStorage.getItem(STORAGE_KEY);
      const tbody = document.getElementById("staffTable").getElementsByTagName("tbody")[0];
      if (stored) {
        const staffList = JSON.parse(stored);
        tbody.innerHTML = "";
        staffList.forEach(staff => {
          tbody.innerHTML += getStaffRowHTML(staff);
        });
      } else {
        // If none exist, create a sample row
        addStaff();
      }
      addListenersToAllRows();
    }

    function saveStaffList() {
      const staffList = [];
      const rows = document.getElementById("staffTable").getElementsByTagName("tbody")[0].rows;
      for (let row of rows) {
        const staffID = row.cells[0].querySelector("input").value.trim();
        const name    = row.cells[1].querySelector("input").value.trim();

        const timeInputs = row.cells[2].querySelectorAll("input[type='time']");
        const startVal   = timeInputs[0].value;
        const endVal     = timeInputs[1].value;
        const breakTime  = startVal + "-" + endVal;

        const hhmdEligible = row.cells[3].querySelector("select").value;
        const attendance   = row.cells[4].querySelector("select").value;
        const locked       = row.cells[5].querySelector("input[type='checkbox']").checked;
        let workedLastTwoDays = row.dataset.worked ? JSON.parse(row.dataset.worked) : [];
        let assigned = row.dataset.assigned ? JSON.parse(row.dataset.assigned) : [];

        staffList.push({
          staffID,
          name,
          breakTime,
          hhmdEligible,
          attendance,
          locked,
          workedLastTwoDays,
          assigned
        });
      }
      localStorage.setItem(STORAGE_KEY, JSON.stringify(staffList));
    }

    /*******************************************************
     *         STAFF ROW CREATION/REMOVAL
     *******************************************************/
    function getStaffRowHTML(staff) {
      let [startVal, endVal] = staff.breakTime ? staff.breakTime.split("-") : ["21:30","23:30"];
      return `
        <tr data-worked='${JSON.stringify(staff.workedLastTwoDays || [])}'
            data-assigned='${JSON.stringify(staff.assigned || [])}'>
          <td><input type="text" value="${staff.staffID}"></td>
          <td><input type="text" value="${staff.name}"></td>
          <td>
            <div class="break-time-container draggable" draggable="true">
              <input type="time" value="${startVal || "21:30"}" step="1">
              <span>-</span>
              <input type="time" value="${endVal   || "23:30"}" step="1">
            </div>
          </td>
          <td>
            <select>
              <option value="Yes" ${staff.hhmdEligible==="Yes"?"selected":""}>Yes</option>
              <option value="No"  ${staff.hhmdEligible==="No" ?"selected":""}>No</option>
            </select>
          </td>
          <td>
            <select>
              <option ${staff.attendance==="Yes"?"selected":""}>Yes</option>
              <option ${staff.attendance==="No" ?"selected":""}>No</option>
            </select>
          </td>
          <td>
            <input type="checkbox" ${staff.locked?"checked":""}>
          </td>
          <td><button onclick="removeRow(this)">Remove</button></td>
        </tr>
      `;
    }

    function addStaff() {
      const tbody = document.getElementById("staffTable").getElementsByTagName("tbody")[0];
      const newStaff = {
        staffID: "",
        name: "",
        breakTime: "21:30-23:30",
        hhmdEligible: "No",
        attendance: "Yes",
        locked: false,
        workedLastTwoDays: [],
        assigned: []
      };
      tbody.insertAdjacentHTML("beforeend", getStaffRowHTML(newStaff));
      addListenersToAllRows();
      saveStaffList();
    }

    function removeRow(button) {
      button.closest("tr").remove();
      saveStaffList();
    }

    /*******************************************************
     *            DRAG & DROP SWAP TIME
     *******************************************************/
    let draggedContainer = null;

    function addDragAndDropListeners(element) {
      element.addEventListener("dragstart", function(e) {
        draggedContainer = element;
        e.dataTransfer.effectAllowed = "move";
      });

      element.addEventListener("dragover", function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
      });

      element.addEventListener("drop", function(e) {
        e.preventDefault();
        if (draggedContainer && draggedContainer !== element) {
          // Swap time values
          const sourceTimes = draggedContainer.querySelectorAll("input[type='time']");
          const targetTimes = element.querySelectorAll("input[type='time']");
          let tmpStart = sourceTimes[0].value, tmpEnd = sourceTimes[1].value;
          sourceTimes[0].value = targetTimes[0].value;
          sourceTimes[1].value = targetTimes[1].value;
          targetTimes[0].value = tmpStart;
          targetTimes[1].value = tmpEnd;
          // Save
          saveStaffList();
        }
      });
    }

    function addListenersToAllRows() {
      const tbody = document.getElementById("staffTable").getElementsByTagName("tbody")[0];
      for (let row of tbody.rows) {
        // Add drag & drop to break-time container
        const container = row.cells[2].querySelector(".break-time-container");
        addDragAndDropListeners(container);

        // On change, save staff
        const allInputs = row.querySelectorAll("input, select");
        allInputs.forEach(inp => {
          inp.addEventListener("change", saveStaffList);
        });
      }
    }

    /*******************************************************
     *          GENERATE ROSTER (HALF-HOUR)
     *******************************************************/
    function generateRoster() {
      saveStaffList();  
      const dayValue = document.getElementById("rosterDay").value; 
      const isWeekend = (dayValue === "Saturday" || dayValue === "Sunday");

      // Gather staff
      let staffList = getCurrentStaffList();
      // Clear assignments for unlocked staff
      staffList.forEach(st => {
        if (!st.locked) st.assigned = [];
      });

      // Build empty roster data structure:
      // roster[location][halfHour] = arrayOfStaffIDs
      let roster = {};
      OUTPUT_ORDER.forEach(loc => { roster[loc] = {}; });

      let shortfalls = [];

      // For each half-hour slot, fill in priority order
      for (let slot of HALF_HOURS) {
        for (let p of PRIORITY) {
          let loc = p.location;
          if (!locationApplies(loc, slot, isWeekend)) continue;

          let needed = p.needed; // 1 or 2
          if (!roster[loc][slot]) roster[loc][slot] = [];
          let assignedCount = roster[loc][slot].length;

          while (assignedCount < needed) {
            let chosen = pickStaffForSlot(staffList, slot, loc);
            if (!chosen) break; // no more staff available

            roster[loc][slot].push(chosen.staffID);
            chosen.assigned.push({ slot, location: loc });
            assignedCount++;
          }

          // If we didn't reach needed, note shortfall
          if ((loc === "Pass Counter" || loc === "Lobby") && assignedCount < needed) {
            shortfalls.push(`Shortfall at ${loc} for ${slot}. Needed ${needed}, got ${assignedCount}.`);
          }
        }
      }

      // Save updated assigned arrays back to row dataset
      saveAssignedToRows(staffList);
      // Display results
      displayRoster(roster);
      displayNotes(shortfalls);
    }

    // Pull staff objects from the table
    function getCurrentStaffList() {
      let staffList = [];
      const rows = document.getElementById("staffTable").getElementsByTagName("tbody")[0].rows;
      for (let row of rows) {
        const staffID = row.cells[0].querySelector("input").value.trim();
        const name    = row.cells[1].querySelector("input").value.trim();

        const timeInputs = row.cells[2].querySelectorAll("input[type='time']");
        const startVal   = timeInputs[0].value;
        const endVal     = timeInputs[1].value;
        const breakTime  = startVal + "-" + endVal;

        const hhmdEligible = row.cells[3].querySelector("select").value;
        const attendance   = row.cells[4].querySelector("select").value;
        const locked       = row.cells[5].querySelector("input[type='checkbox']").checked;
        let workedLastTwoDays = row.dataset.worked ? JSON.parse(row.dataset.worked) : [];
        let assigned = row.dataset.assigned ? JSON.parse(row.dataset.assigned) : [];

        staffList.push({
          staffID,
          name,
          breakTime,
          hhmdEligible,
          attendance,
          locked,
          workedLastTwoDays,
          assigned
        });
      }
      return staffList;
    }

    function locationApplies(loc, slot, isWeekend) {
      if (loc === "Vertical Patrol") {
        // only at 20:00, 23:00, 01:00, 06:00
        return ["20:00","23:00","01:00","06:00"].includes(slot);
      }
      if (loc === "Report Room") {
        // only 20:00 & 21:00, skip weekends
        if (isWeekend) return false;
        return (slot === "20:00" || slot === "21:00");
      }
      if (loc === "Tango Papa") {
        // only 07:30
        return (slot === "07:30");
      }
      return true; // for others, always valid
    }

    // Picks one staff for the given slot & location
    // Must handle: attendance=Yes, not locked (unless already assigned?), break time conflict, HHMD eligibility, half-hour rotation for lobby, no double booking, etc.
    function pickStaffForSlot(staffList, slot, loc) {
      // We'll do a best-effort approach, scanning staff in order
      // If location=Lobby, we try to avoid the same staff as the immediate previous half-hour if possible
      // If staff is locked but not assigned to this slot yet, skip them for new assignments
      for (let st of staffList) {
        if (!st.locked) {
          // normal staff
        } else {
          // locked staff can only keep existing assignments
          if (!alreadyAssignedSlot(st, slot)) {
            continue;
          }
        }

        // Must have attendance=Yes
        if (st.attendance !== "Yes") continue;
        // Must not be on break
        if (!staffAvailableHalfHour(st, slot)) continue;
        // Must not already be assigned in this slot
        if (alreadyAssignedSlot(st, slot)) continue;
        // If HHMD, must have hhmdEligible=Yes
        if (loc === "HHMD" && st.hhmdEligible !== "Yes") continue;
        // No consecutive half-hour same location (except Lobby)
        if (loc !== "Lobby" && isBackToBack(st, slot, loc)) continue;
        // For Lobby, try to rotate staff if possible
        if (loc === "Lobby" && isLobbyRepeat(st, slot)) {
          // We'll skip this staff if we can find someone else
          // But if no one else is available, we'll come back to them
          // => We'll do a 2-pass approach: 
          // (1) try to find a staff who doesn't conflict
          // (2) if none found, accept them
          continue;
        }
        // 2-hour gap best-effort
        if (violates2HourGap(st, slot, loc)) continue;

        // If we pass all checks, return this staff
        return st;
      }

      // If we got here, no staff found that doesn't conflict
      // If loc="Lobby" we might do a second pass ignoring the isLobbyRepeat() rule
      if (loc === "Lobby") {
        // second pass ignoring isLobbyRepeat
        for (let st of staffList) {
          if (!st.locked) {
            // ok
          } else {
            if (!alreadyAssignedSlot(st, slot)) continue;
          }
          if (st.attendance !== "Yes") continue;
          if (!staffAvailableHalfHour(st, slot)) continue;
          if (alreadyAssignedSlot(st, slot)) continue;
          if (loc === "HHMD" && st.hhmdEligible !== "Yes") continue;
          if (loc !== "Lobby" && isBackToBack(st, slot, loc)) continue;
          if (violates2HourGap(st, slot, loc)) continue;

          // accept them even if they are a repeat from the previous half-hour
          return st;
        }
      }

      return null;
    }

    // Check if staff is on break at this half-hour
    // e.g. breakTime="21:30-23:30" means staff is unavailable for half-hour slots 21:30, 22:00, 22:30, 23:00
    function staffAvailableHalfHour(st, slot) {
      const [bStart, bEnd] = st.breakTime.split("-");
      if (!bStart || !bEnd) return true; // no break?

      // Convert each to numeric minutes from 00:00
      let startM = timeToMinutes(bStart);
      let endM   = timeToMinutes(bEnd);
      let slotM  = timeToMinutes(slot);

      // If endM < startM, it might wrap past midnight (rare, but let's assume breaks are same day)
      // We'll do a simple approach: staff is unavailable if slotM >= startM && slotM < endM
      if (endM < startM) {
        // e.g. break 23:30-01:30
        // We'll treat it as if it doesn't cross midnight for simplicity, or skip advanced logic
        // For a robust approach, you'd handle wrap-around. 
        // We'll do the simpler approach: if endM < startM => no check
        return true;
      }

      return !(slotM >= startM && slotM < endM);
    }

    function timeToMinutes(t) {
      // "HH:MM" => total minutes
      let [H, M] = t.split(":");
      return parseInt(H,10)*60 + parseInt(M,10);
    }

    function alreadyAssignedSlot(st, slot) {
      return st.assigned.some(a => a.slot === slot);
    }

    // Check if staff was assigned the same location in the immediate previous slot
    function isBackToBack(st, slot, loc) {
      let idx = HALF_HOURS.indexOf(slot);
      if (idx <= 0) return false;
      let prevSlot = HALF_HOURS[idx-1];
      return st.assigned.some(a => a.slot === prevSlot && a.location === loc);
    }

    // For Lobby, we try to avoid the same staff as the immediate previous half-hour if possible
    function isLobbyRepeat(st, slot) {
      let idx = HALF_HOURS.indexOf(slot);
      if (idx <= 0) return false;
      let prevSlot = HALF_HOURS[idx-1];
      // If staff was assigned to Lobby in prevSlot, that is a "repeat"
      return st.assigned.some(a => a.slot === prevSlot && a.location === "Lobby");
    }

    // 2-hour gap = skip staff if they worked the same location in the previous 4 half-hour slots
    function violates2HourGap(st, slot, loc) {
      let idx = HALF_HOURS.indexOf(slot);
      // Check up to 4 previous slots
      for (let i=1; i<=4; i++) {
        if (idx - i < 0) break;
        let checkSlot = HALF_HOURS[idx - i];
        if (st.assigned.some(a => a.slot === checkSlot && a.location === loc)) {
          return true;
        }
      }
      return false;
    }

    function saveAssignedToRows(staffList) {
      const rows = document.getElementById("staffTable").getElementsByTagName("tbody")[0].rows;
      let i = 0;
      for (let row of rows) {
        row.dataset.assigned = JSON.stringify(staffList[i].assigned);
        i++;
      }
      saveStaffList();
    }

    /*******************************************************
     *       DISPLAY THE ROSTER & SHORTFALL NOTES
     *******************************************************/
    function displayRoster(roster) {
      // roster[loc][slot] = arrayOfStaffIDs
      const container = document.getElementById("rosterContainer");
      container.innerHTML = "";

      let tableHTML = `<table><thead><tr><th>Location</th>`;
      HALF_HOURS.forEach(slot => {
        tableHTML += `<th>${slot}</th>`;
      });
      tableHTML += "</tr></thead><tbody>";

      OUTPUT_ORDER.forEach(loc => {
        tableHTML += `<tr><td>${loc}</td>`;
        HALF_HOURS.forEach(slot => {
          let arr = roster[loc][slot] || [];
          if (arr.length > 1) {
            tableHTML += `<td>${arr.join("/")}</td>`;
          } else if (arr.length === 1) {
            tableHTML += `<td>${arr[0]}</td>`;
          } else {
            tableHTML += `<td></td>`;
          }
        });
        tableHTML += "</tr>";
      });

      tableHTML += "</tbody></table>`;
      container.innerHTML = tableHTML;
    }

    function displayNotes(shortfalls) {
      const notesDiv = document.getElementById("notesContainer");
      if (shortfalls.length === 0) {
        notesDiv.innerHTML = "<p>No critical shortfalls.</p>";
      } else {
        notesDiv.innerHTML = shortfalls.map(s => `<p class="shortfall-note">${s}</p>`).join("");
      }
    }

    /*******************************************************
     *         WHATSAPP SHARING
     *******************************************************/
    function sendWhatsApp() {
      let rosterText = "ðŸ“‹ *Staff Roster (Half-Hour)*\n\n";
      const table = document.querySelector("#rosterContainer table");
      if (!table) {
        alert("Please generate the roster first.");
        return;
      }
      const rows = table.querySelectorAll("tbody tr");
      rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        rosterText += `*${cells[0].innerText}*\n`; // location name
        for (let i = 1; i < cells.length; i++) {
          if (cells[i].innerText) {
            const slot = table.querySelector("thead").rows[0].cells[i].innerText;
            rosterText += `- ${cells[i].innerText} at ${slot}\n`;
          }
        }
        rosterText += "\n";
      });
      const whatsappURL = `https://wa.me/?text=${encodeURIComponent(rosterText)}`;
      window.open(whatsappURL, "_blank");
    }
  </script>

</body>
</html>