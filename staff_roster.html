<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Staff Roster Management System</title>
  
  <!-- External libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 20px; 
      text-align: center;
      font-size: 14px;
      background-color: #f3f4f6;
      margin: 0; 
    }

    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 20px; 
    }

    th, td { 
      border: 1px solid #ccc; 
      padding: 6px; 
      text-align: center; 
    }

    th { 
      background-color: #f4f4f4; 
    }

    input, select { 
      padding: 4px; 
      text-align: center;
      font-size: 12px;
    }

    .date-container {
      margin: 20px 0;
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .date-container > div {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .break-time-container { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 5px;
    }

    .button-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 12px 0;
      align-items: center;
    }

    .button-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .roster-btn {
      background-color: #6B7280;
      color: white;
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }

    .roster-btn:hover {
      background-color: #4B5563;
    }

    .remove-btn {
      background-color: #6B7280;
      color: white;
      padding: 1px 6px;
      font-size: 11px;
      border-radius: 3px;
      border: none;
      cursor: pointer;
    }

    .shortfall-note {
      color: red;
      font-weight: bold;
      font-size: 12px;
    }

    #importFile {
      display: none;
    }

    #rosterContainer {
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h2>Staff Roster Management System</h2>

  <div class="date-container">
    <div>
      <label for="rosterDate">Date:</label>
      <input type="date" id="rosterDate">
    </div>
    <div>
      <label for="rosterDay">Day:</label>
      <select id="rosterDay">
        <option value="Monday">Monday</option>
        <option value="Tuesday">Tuesday</option>
        <option value="Wednesday">Wednesday</option>
        <option value="Thursday">Thursday</option>
        <option value="Friday">Friday</option>
        <option value="Saturday">Saturday</option>
        <option value="Sunday">Sunday</option>
      </select>
    </div>
  </div>

  <table id="staffTable">
    <thead>
      <tr>
        <th>Staff ID</th>
        <th>Name</th>
        <th>Break Time</th>
        <th>HHMD Eligible</th>
        <th>Attendance</th>
        <th>Lock</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="button-container">
    <div class="button-row">
      <button class="roster-btn" onclick="window.rosterSystem.addStaff()">Add Staff</button>
      <button class="roster-btn" onclick="window.rosterSystem.importData()">Import Data</button>
      <button class="roster-btn" onclick="window.rosterSystem.exportData()">Export Data</button>
    </div>
    <div class="button-row">
      <button class="roster-btn" onclick="window.rosterSystem.generateRoster()">Generate Roster</button>
      <button class="roster-btn" onclick="window.rosterSystem.copyTSV()">Copy Roster</button>
    </div>
    <div class="button-row">
      <button class="roster-btn" onclick="window.rosterSystem.downloadRoster('excel')">Excel</button>
      <button class="roster-btn" onclick="window.rosterSystem.downloadRoster('csv')">CSV</button>
      <button class="roster-btn" onclick="window.rosterSystem.downloadRoster('pdf')">PDF</button>
    </div>
  </div>

  <input type="file" id="importFile" accept=".json">

  <h3>Generated Roster</h3>
  <div id="rosterContainer"></div>

  <h4>Notes & Shortfalls</h4>
  <div id="notesContainer"></div>
</body>
</html>
<script>
(function() {
  // Core Constants
  const STORAGE_KEY = 'staffListData';
  const ROSTER_TIMES = [
    "20:00", "20:30", "21:00", "22:00", "23:00", "00:00", "01:00", "01:30", 
    "02:00", "03:00", "04:00", "05:00", "06:00", "07:00", "07:30"
  ];

  const PRIORITY = [
    { location: "Pass Counter", needed: 2 },
    { location: "HHMD", needed: 1 },
    { location: "Lobby", needed: 2 },
    { location: "Guard House", needed: 1 },
    { location: "Vertical Patrol", needed: 1 },
    { location: "Report Room", needed: 1 },
    { location: "Tango Papa", needed: 1 }
  ];

  const OUTPUT_ORDER = [
    "Pass Counter", "HHMD", "Lobby", "Guard House",
    "Vertical Patrol", "Report Room", "Tango Papa"
  ];

  window.rosterSystem = {
    init: function() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('rosterDate').value = today;
      
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const currentDay = days[new Date().getDay()];
      document.getElementById('rosterDay').value = currentDay;
      
      this.loadStaffList();
    },

    locationApplies: function(loc, slot, isWeekend) {
      if (slot === "07:30") {
        return loc === "Tango Papa";
      }

      switch(loc) {
        case "Vertical Patrol":
          return ["20:30", "23:00", "01:30", "06:00"].includes(slot);
        case "Report Room":
          if (isWeekend) return false;
          return ["20:00", "21:00"].includes(slot);
        case "Tango Papa":
          return slot === "07:30";
        case "Guard House":
          return slot !== "07:30"; // Guard House staffed at all times except 07:30
        default:
          return true;
      }
    },

    isStaffEligible: function(st, slot, loc) {
      if (st.attendance !== "Yes") return false;
      if (st.locked && !this.alreadyAssignedSlot(st, slot)) return false;
      if (!this.staffAvailableHalfHour(st, slot)) return false;
      
      var hasSlotAssignment = st.assigned.some(function(a) {
        return a.slot === slot;
      });
      if (hasSlotAssignment) return false;
      
      if (loc === "HHMD" && st.hhmdEligible !== "Yes") return false;
      if (loc !== "Lobby" && this.isBackToBack(st, slot, loc)) return false;
      if (this.violates2HourGap(st, slot, loc)) return false;
      return true;
    },

    staffAvailableHalfHour: function(st, slot) {
      var parts = st.breakTime.split("-");
      var bStart = parts[0];
      var bEnd = parts[1];
      if (!bStart || !bEnd) return true;
      if (slot >= bStart && slot <= bEnd) return false;
      return true;
    },

    isBackToBack: function(st, slot, loc) {
      var idx = ROSTER_TIMES.indexOf(slot);
      if (idx <= 0) return false;
      
      var prevSlot = ROSTER_TIMES[idx-1];
      var nextSlot = ROSTER_TIMES[idx+1];
      
      return st.assigned.some(function(a) {
        return (a.slot === prevSlot || a.slot === nextSlot) && a.location === loc;
      });
    },

    violates2HourGap: function(st, slot, loc) {
      var idx = ROSTER_TIMES.indexOf(slot);
      for (var i = 1; i <= 2; i++) {
        if (idx - i < 0) break;
        var checkSlot = ROSTER_TIMES[idx - i];
        var hasViolation = st.assigned.some(function(a) {
          return a.slot === checkSlot && a.location === loc;
        });
        if (hasViolation) return true;
      }
      return false;
    },

    alreadyAssignedSlot: function(st, slot) {
      return st.assigned.some(function(a) {
        return a.slot === slot;
      });
    },

    isLobbyRepeat: function(st, slot) {
      var idx = ROSTER_TIMES.indexOf(slot);
      if (idx <= 0) return false;
      var prevSlot = ROSTER_TIMES[idx-1];
      return st.assigned.some(function(a) {
        return a.slot === prevSlot && a.location === "Lobby";
      });
    }
  };
})();</script>
<script>
  // Staff Management Functions
  function extendRosterSystem() {
    window.rosterSystem = Object.assign(window.rosterSystem, {
      loadStaffList: function() {
        var stored = localStorage.getItem(STORAGE_KEY);
        var tbody = document.getElementById("staffTable").getElementsByTagName("tbody")[0];

        if (stored) {
          var staffList = JSON.parse(stored);
          tbody.innerHTML = "";
          var self = this;
          staffList.forEach(function(staff) {
            tbody.innerHTML += self.getStaffRowHTML(staff);
          });
        } else {
          this.addStaff();
        }
        this.addListenersToAllRows();
      },

      getStaffRowHTML: function(staff) {
        staff = staff || {};
        var parts = staff.breakTime ? staff.breakTime.split("-") : ["21:30", "23:30"];
        var startVal = parts[0];
        var endVal = parts[1];
        
        return '<tr data-assigned=\'' + JSON.stringify(staff.assigned || []) + '\'>' +
          '<td><input type="text" value="' + (staff.staffID || '') + '" class="staff-input"></td>' +
          '<td><input type="text" value="' + (staff.name || '') + '" class="staff-input"></td>' +
          '<td><div class="break-time-container">' +
            '<input type="time" value="' + startVal + '" step="1800" class="time-input">' +
            '<span>-</span>' +
            '<input type="time" value="' + endVal + '" step="1800" class="time-input">' +
          '</div></td>' +
          '<td><select class="staff-select">' +
            '<option value="Yes"' + (staff.hhmdEligible==="Yes"?" selected":"") + '>Yes</option>' +
            '<option value="No"' + (staff.hhmdEligible==="No"?" selected":"") + '>No</option>' +
          '</select></td>' +
          '<td><select class="staff-select">' +
            '<option value="Yes"' + (staff.attendance==="Yes"?" selected":"") + '>Yes</option>' +
            '<option value="No"' + (staff.attendance==="No"?" selected":"") + '>No</option>' +
          '</select></td>' +
          '<td><input type="checkbox"' + (staff.locked?" checked":"") + '></td>' +
          '<td><button class="remove-btn" onclick="window.rosterSystem.removeRow(this)">Remove</button></td>' +
        '</tr>';
      },

      addStaff: function() {
        var tbody = document.getElementById("staffTable").getElementsByTagName("tbody")[0];
        var newStaff = {
          staffID: "",
          name: "",
          breakTime: "21:30-23:30",
          hhmdEligible: "No",
          attendance: "Yes",
          locked: false,
          assigned: []
        };
        tbody.insertAdjacentHTML("beforeend", this.getStaffRowHTML(newStaff));
        this.addListenersToAllRows();
        this.saveStaffList();
      },

      removeRow: function(button) {
        button.closest("tr").remove();
        this.saveStaffList();
      },

      getCurrentStaffList: function() {
        var staffList = [];
        var rows = document.getElementById("staffTable").getElementsByTagName("tbody")[0].rows;
        
        for (var i = 0; i < rows.length; i++) {
          var row = rows[i];
          var staffData = {
            staffID: row.cells[0].querySelector("input").value.trim(),
            name: row.cells[1].querySelector("input").value.trim(),
            breakTime: row.cells[2].querySelectorAll("input[type='time']")[0].value + "-" +
                      row.cells[2].querySelectorAll("input[type='time']")[1].value,
            hhmdEligible: row.cells[3].querySelector("select").value,
            attendance: row.cells[4].querySelector("select").value,
            locked: row.cells[5].querySelector("input[type='checkbox']").checked,
            assigned: row.dataset.assigned ? JSON.parse(row.dataset.assigned) : []
          };
          staffList.push(staffData);
        }
        return staffList;
      },

      addListenersToAllRows: function() {
        var tbody = document.getElementById("staffTable").getElementsByTagName("tbody")[0];
        var self = this;
        for (var i = 0; i < tbody.rows.length; i++) {
          var row = tbody.rows[i];
          var allInputs = row.querySelectorAll("input, select");
          allInputs.forEach(function(inp) {
            inp.addEventListener("change", function() {
              self.saveStaffList();
            });
          });
        }
      },

      saveStaffList: function() {
        var staffList = this.getCurrentStaffList();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(staffList));
      },

      pickStaffForSlot: function(staffList, slot, loc) {
        var self = this;
        for (var i = 0; i < staffList.length; i++) {
          var st = staffList[i];
          if (!self.isStaffEligible(st, slot, loc)) continue;
          if (loc === "Lobby" && self.isLobbyRepeat(st, slot)) continue;
          return st;
        }
        
        if (loc === "Lobby") {
          for (var j = 0; j < staffList.length; j++) {
            var st = staffList[j];
            if (!self.isStaffEligible(st, slot, loc)) continue;
            return st;
          }
        }
        return null;
      },

      saveAssignedToRows: function(staffList) {
        var rows = document.getElementById("staffTable").getElementsByTagName("tbody")[0].rows;
        for (var i = 0; i < rows.length; i++) {
          rows[i].dataset.assigned = JSON.stringify(staffList[i].assigned);
        }
        this.saveStaffList();
      }
    });
  }

  // Run the extension
  extendRosterSystem();
</script>
<script>
  // Roster Generation and Export Functions
  function extendRosterSystemPart4() {
    window.rosterSystem = Object.assign(window.rosterSystem, {
      generateRoster: function() {
        var dayValue = document.getElementById("rosterDay").value;
        var isWeekend = (dayValue === "Saturday" || dayValue === "Sunday");
        
        var staffList = this.getCurrentStaffList().filter(function(staff) {
          return staff.attendance === "Yes";
        });

        if (staffList.length === 0) {
          alert("Please add staff members before generating roster.");
          return;
        }

        // Clear assigned slots (unless locked)
        var self = this;
        staffList.forEach(function(st) {
          if (!st.locked) st.assigned = [];
        });
        
        var roster = {};
        var shortfalls = [];
        PRIORITY.forEach(function(p) {
          roster[p.location] = {};
        });
        
        // Generate roster for each time slot
        for (var s = 0; s < ROSTER_TIMES.length; s++) {
          var slot = ROSTER_TIMES[s];
          for (var p = 0; p < PRIORITY.length; p++) {
            var loc = PRIORITY[p].location;
            if (!self.locationApplies(loc, slot, isWeekend)) continue;
            
            var needed = PRIORITY[p].needed;
            if (!roster[loc][slot]) roster[loc][slot] = [];
            var assignedCount = roster[loc][slot].length;
            
            while (assignedCount < needed) {
              var chosen = self.pickStaffForSlot(staffList, slot, loc);
              if (!chosen) break;
              roster[loc][slot].push(chosen.staffID);
              chosen.assigned.push({ slot: slot, location: loc });
              assignedCount++;
            }
            
            if (loc === "Pass Counter" && slot !== "07:30" && assignedCount < 2) {
              shortfalls.push('Critical Shortfall: Pass Counter at ' + slot + ' has only ' + assignedCount + ' staff');
            }
          }
        }
        
        window.generatedRosterData = roster;
        this.saveAssignedToRows(staffList);
        this.displayRoster(roster);
        this.displayNotes(shortfalls);
      },

      displayRoster: function(roster) {
        var container = document.getElementById("rosterContainer");
        var tableHTML = '<table><thead><tr><th>Location</th>';
        
        for (var i = 0; i < ROSTER_TIMES.length; i++) {
          tableHTML += '<th>' + ROSTER_TIMES[i] + '</th>';
        }
        tableHTML += '</tr></thead><tbody>';

        for (var j = 0; j < OUTPUT_ORDER.length; j++) {
          var loc = OUTPUT_ORDER[j];
          tableHTML += '<tr><td>' + loc + '</td>';
          
          for (var k = 0; k < ROSTER_TIMES.length; k++) {
            var slot = ROSTER_TIMES[k];
            var assignments = roster[loc][slot] || [];
            var display = assignments.join("/");
            if (loc === "Lobby" && assignments.length === 2) {
              display = assignments[0] + '/' + assignments[1];
            }
            tableHTML += '<td contenteditable="true">' + display + '</td>';
          }
          tableHTML += '</tr>';
        }

        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
      },

      displayNotes: function(shortfalls) {
        var notesDiv = document.getElementById("notesContainer");
        if (shortfalls.length === 0) {
          notesDiv.innerHTML = "<p>No critical shortfalls.</p>";
        } else {
          var shortfallsHTML = '';
          for (var i = 0; i < shortfalls.length; i++) {
            shortfallsHTML += '<p class="shortfall-note">' + shortfalls[i] + '</p>';
          }
          notesDiv.innerHTML = shortfallsHTML;
        }
      },

      exportData: function() {
        var staffList = this.getCurrentStaffList();
        var dataStr = JSON.stringify(staffList, null, 2);
        var dataBlob = new Blob([dataStr], { type: 'application/json' });
        var url = URL.createObjectURL(dataBlob);
        
        var link = document.createElement('a');
        link.href = url;
        link.download = 'staff_roster_' + new Date().toISOString().split('T')[0] + '.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      },

      importData: function() {
        var self = this;
        var input = document.getElementById('importFile');
        input.onchange = function(e) {
          var file = e.target.files[0];
          var reader = new FileReader();
          
          reader.onload = function(e) {
            try {
              var staffList = JSON.parse(e.target.result);
              localStorage.setItem(STORAGE_KEY, JSON.stringify(staffList));
              self.loadStaffList();
            } catch (error) {
              alert('Error importing file: ' + error.message);
            }
          };
          
          reader.readAsText(file);
        };
        input.click();
      },

      copyTSV: function() {
        var table = document.querySelector("#rosterContainer table");
        if (!table) {
          alert("Please generate the roster first.");
          return;
        }

        var tsv = '';
        var headers = Array.prototype.slice.call(table.querySelectorAll('thead th'))
          .map(function(th) { return th.textContent; });
        tsv += headers.join('\t') + '\n';

        var rows = table.querySelectorAll('tbody tr');
        for (var i = 0; i < rows.length; i++) {
          var cells = Array.prototype.slice.call(rows[i].querySelectorAll('td'))
            .map(function(td) { return td.textContent; });
          tsv += cells.join('\t') + '\n';
        }

        navigator.clipboard.writeText(tsv).then(function() {
          alert('Roster copied to clipboard in TSV format');
        }).catch(function(err) {
          console.error('Failed to copy:', err);
          alert('Failed to copy roster to clipboard');
        });
      },

      downloadRoster: function(format) {
        var date = document.getElementById('rosterDate').value || new Date().toISOString().split('T')[0];
        var day = document.getElementById('rosterDay').value || "Day";
        
        if (!window.generatedRosterData) {
          alert("Please generate the roster first.");
          return;
        }
        
        try {
          switch(format) {
            case 'excel':
              this.downloadExcel(date, day);
              break;
            case 'csv':
              this.downloadCSV(date, day);
              break;
            case 'pdf':
              this.downloadPDF(date, day);
              break;
          }
        } catch(error) {
          console.error('Download error:', error);
          alert('Error generating file. Please try again.');
        }
      },

      downloadExcel: function(date, day) {
        var wb = XLSX.utils.book_new();
        var data = [
          ['Staff Roster - ' + day + ' ' + date],
          [],
          ['Location'].concat(ROSTER_TIMES)
        ];
        
        for (var i = 0; i < OUTPUT_ORDER.length; i++) {
          var location = OUTPUT_ORDER[i];
          var row = [location];
          for (var j = 0; j < ROSTER_TIMES.length; j++) {
            var time = ROSTER_TIMES[j];
            var cellData = window.generatedRosterData[location] && 
                          window.generatedRosterData[location][time];
            row.push(cellData ? cellData.join("/") : '');
          }
          data.push(row);
        }
        
        var ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, 'Roster');
        XLSX.writeFile(wb, 'roster_' + date + '_' + day + '.xlsx');
      },

      downloadCSV: function(date, day) {
        var csv = 'Staff Roster - ' + day + ' ' + date + '\n\n';
        csv += ['Location'].concat(ROSTER_TIMES).join(',') + '\n';
        
        for (var i = 0; i < OUTPUT_ORDER.length; i++) {
          var location = OUTPUT_ORDER[i];
          var row = [location];
          for (var j = 0; j < ROSTER_TIMES.length; j++) {
            var time = ROSTER_TIMES[j];
            var cellData = window.generatedRosterData[location] && 
                          window.generatedRosterData[location][time];
            row.push(cellData ? cellData.join("/") : '');
          }
          csv += row.join(',') + '\n';
        }
        
        var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        var link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'roster_' + date + '_' + day + '.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
      },

      downloadPDF: function(date, day) {
        var self = this;
        var { jsPDF } = window.jspdf;
        var doc = new jsPDF({
          orientation: 'landscape',
          unit: 'pt',
          format: 'a4'
        });
        
        doc.setFontSize(16);
        doc.text('Staff Roster - ' + day + ' ' + date, 40, 40);
        
        var tableData = OUTPUT_ORDER.map(function(location) {
          var row = [location];
          ROSTER_TIMES.forEach(function(time) {
            var cellData = window.generatedRosterData[location] && 
                          window.generatedRosterData[location][time];
            row.push(cellData ? cellData.join("/") : '');
          });
          return row;
        });
        
        doc.autoTable({
          head: [['Location'].concat(ROSTER_TIMES)],
          body: tableData,
          startY: 60,
          styles: {
            fontSize: 8,
            cellPadding: 2,
            halign: 'center'
          },
          columnStyles: {
            0: { cellWidth: 80, halign: 'left' }
          },
          headStyles: {
            fillColor: [244, 244, 244],
            textColor: [0, 0, 0],
            fontSize: 8,
            fontStyle: 'bold',
            halign: 'center'
          }
        });
        
        doc.save('roster_' + date + '_' + day + '.pdf');
      }
    });
  }

  // Run the extension
  extendRosterSystemPart4();
</script>
