<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Staff Roster Management System</title>
  
  <!-- External libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <h2>Staff Roster Management System</h2>

  <!-- Date Selection -->
  <div class="date-container">
    <div>
      <label for="rosterDate">Date:</label>
      <input type="date" id="rosterDate">
    </div>
    <div>
      <label for="rosterDay">Day:</label>
      <select id="rosterDay">
        <option value="Monday">Monday</option>
        <option value="Tuesday">Tuesday</option>
        <option value="Wednesday">Wednesday</option>
        <option value="Thursday">Thursday</option>
        <option value="Friday">Friday</option>
        <option value="Saturday">Saturday</option>
        <option value="Sunday">Sunday</option>
      </select>
    </div>
  </div>

  <!-- Staff Input Table -->
  <table id="staffTable">
    <thead>
      <tr>
        <th>Staff ID</th>
        <th>Name</th>
        <th>Break Time</th>
        <th>HHMD Eligible</th>
        <th>Attendance</th>
        <th>Lock</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Control Buttons -->
  <div class="button-container">
    <div class="button-row">
      <button class="roster-btn" onclick="window.rosterSystem.addStaff()">Add Staff</button>
      <button class="roster-btn" onclick="window.rosterSystem.importData()">Import Data</button>
      <button class="roster-btn" onclick="window.rosterSystem.generateRoster()">Generate Roster</button>
    </div>
    <div class="button-row">
      <button class="roster-btn" onclick="window.rosterSystem.exportData()">Export Data</button>
      <button class="roster-btn" onclick="window.rosterSystem.copyTSV()">Copy Roster TSV</button>
      <button class="roster-btn" onclick="window.rosterSystem.downloadRoster('excel')">Excel (.xlsx)</button>
      <button class="roster-btn" onclick="window.rosterSystem.downloadRoster('csv')">CSV</button>
      <button class="roster-btn" onclick="window.rosterSystem.downloadRoster('pdf')">PDF</button>
    </div>
  </div>

  <input type="file" id="importFile" accept=".json">

  <!-- Generated Roster Display -->
  <h3>Generated Roster</h3>
  <div id="rosterContainer"></div>

  <!-- Notes and Shortfalls -->
  <h4>Notes & Shortfalls</h4>
  <div id="notesContainer"></div>
</body>
</html>

// Core Constants
const STORAGE_KEY = 'staffListData';
const ROSTER_TIMES = [
  "20:00", "20:30", "21:00", "22:00", "23:00", "00:00", "01:00", "01:30", 
  "02:00", "03:00", "04:00", "05:00", "06:00", "07:00", "07:30"
];

const PRIORITY = [
  { location: "Pass Counter", needed: 2 },
  { location: "HHMD", needed: 1 },
  { location: "Lobby", needed: 2 },
  { location: "Guard House", needed: 1 },
  { location: "Vertical Patrol", needed: 1 },
  { location: "Report Room", needed: 1 },
  { location: "Tango Papa", needed: 1 }
];

window.rosterSystem = {
  init: function() {
    // Set today's date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('rosterDate').value = today;
    
    // Set current day
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const currentDay = days[new Date().getDay()];
    document.getElementById('rosterDay').value = currentDay;
    
    this.loadStaffList();
  },

  // Staff Management Functions
  loadStaffList: function() {
    const stored = localStorage.getItem(STORAGE_KEY);
    const tbody = document.getElementById("staffTable").getElementsByTagName("tbody")[0];

    if (stored) {
      const staffList = JSON.parse(stored);
      tbody.innerHTML = "";
      staffList.forEach(staff => {
        tbody.innerHTML += this.getStaffRowHTML(staff);
      });
    } else {
      this.addStaff();
    }
    this.addListenersToAllRows();
  },

  getCurrentStaffList: function() {
    const staffList = [];
    const rows = document.getElementById("staffTable").getElementsByTagName("tbody")[0].rows;
    
    for (let row of rows) {
      const staffData = {
        staffID: row.cells[0].querySelector("input").value.trim(),
        name: row.cells[1].querySelector("input").value.trim(),
        breakTime: row.cells[2].querySelectorAll("input[type='time']")[0].value + "-" +
                  row.cells[2].querySelectorAll("input[type='time']")[1].value,
        hhmdEligible: row.cells[3].querySelector("select").value,
        attendance: row.cells[4].querySelector("select").value,
        locked: row.cells[5].querySelector("input[type='checkbox']").checked,
        assigned: row.dataset.assigned ? JSON.parse(row.dataset.assigned) : []
      };
      staffList.push(staffData);
    }
    return staffList;
  },

  getStaffRowHTML: function(staff = {}) {
    const [startVal, endVal] = staff.breakTime ? staff.breakTime.split("-") : ["21:30", "23:30"];
    return `
      <tr data-assigned='${JSON.stringify(staff.assigned || [])}'>
        <td><input type="text" value="${staff.staffID || ''}" class="staff-input"></td>
        <td><input type="text" value="${staff.name || ''}" class="staff-input"></td>
        <td>
          <div class="break-time-container">
            <input type="time" value="${startVal}" step="1800" class="time-input">
            <span>-</span>
            <input type="time" value="${endVal}" step="1800" class="time-input">
          </div>
        </td>
        <td>
          <select class="staff-select">
            <option value="Yes" ${staff.hhmdEligible==="Yes"?"selected":""}>Yes</option>
            <option value="No" ${staff.hhmdEligible==="No"?"selected":""}>No</option>
          </select>
        </td>
        <td>
          <select class="staff-select">
            <option value="Yes" ${staff.attendance==="Yes"?"selected":""}>Yes</option>
            <option value="No" ${staff.attendance==="No"?"selected":""}>No</option>
          </select>
        </td>
        <td>
          <input type="checkbox" ${staff.locked?"checked":""}>
        </td>
        <td><button class="remove-btn" onclick="window.rosterSystem.removeRow(this)">Remove</button></td>
      </tr>
    `;
  },

  addStaff: function() {
    const tbody = document.getElementById("staffTable").getElementsByTagName("tbody")[0];
    const newStaff = {
      staffID: "",
      name: "",
      breakTime: "21:30-23:30",
      hhmdEligible: "No",
      attendance: "Yes",
      locked: false,
      assigned: []
    };
    tbody.insertAdjacentHTML("beforeend", this.getStaffRowHTML(newStaff));
    this.addListenersToAllRows();
    this.saveStaffList();
  },

  removeRow: function(button) {
    button.closest("tr").remove();
    this.saveStaffList();
  },

  addListenersToAllRows: function() {
    const tbody = document.getElementById("staffTable").getElementsByTagName("tbody")[0];
    for (let row of tbody.rows) {
      const allInputs = row.querySelectorAll("input, select");
      allInputs.forEach(inp => {
        inp.addEventListener("change", () => this.saveStaffList());
      });
    }
  },

  saveStaffList: function() {
    const staffList = this.getCurrentStaffList();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(staffList));
  },

  saveAssignedToRows: function(staffList) {
    const rows = document.getElementById("staffTable").getElementsByTagName("tbody")[0].rows;
    for (let i = 0; i < rows.length; i++) {
      rows[i].dataset.assigned = JSON.stringify(staffList[i].assigned);
    }
    this.saveStaffList();
  }
};

// Initialize on page load
window.onload = function() {
  window.rosterSystem.init();
};