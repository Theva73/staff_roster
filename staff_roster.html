<!DOCTYPE html>
<html lang="en-GB">
<head>
  <!-- [Metadata and CSS remain unchanged] -->
  <style>
    /* [Original CSS preserved] */
  </style>
</head>
<body>
  <!-- [HTML structure unchanged] -->

<script>
  // ... (Previous constants remain the same)

  /*******************************************************
   * MODIFIED: GENERATE ROSTER WITH STRICTER RULES
   *******************************************************/
  function generateRoster() {
    saveStaffList();
    const dayValue = document.getElementById("rosterDay").value;
    const isWeekend = (dayValue === "Saturday" || dayValue === "Sunday");
    let staffList = getCurrentStaffList();
    
    // Reset assignments and track location last assignments
    staffList.forEach(st => { st.assigned = []; });
    let lastGuardHouseAssignment = {}; // Track last time per staff

    staffList = shuffleArray(staffList);
    let roster = {};
    OUTPUT_ORDER.forEach(loc => { roster[loc] = {}; });
    let shortfalls = [];

    for (let slot of TIME_SLOTS) {
      staffList = shuffleArray(staffList);
      let availableStaffForSlot = [...staffList];
      
      // Track Guard House last assignment time
      const guardHouseLastSlot = lastGuardHouseAssignment[slot] || null;

      for (let p of PRIORITY) {
        let loc = p.location;
        if (!locationApplies(loc, slot, isWeekend)) continue;
        
        // Modified: Guard House gap enforcement (location-based)
        if (loc === "Guard House" && guardHouseLastSlot) {
          const timeDiff = timeToMinutes(slot) - timeToMinutes(guardHouseLastSlot);
          if (timeDiff < 60) {
            shortfalls.push(`Guard House gap violation at ${slot}`);
            continue;
          }
        }

        let needed = p.needed;
        if (!roster[loc][slot]) roster[loc][slot] = [];
        
        while (roster[loc][slot].length < needed) {
          let chosen = pickStaffForSlot(availableStaffForSlot, slot, loc, staffList.length);
          if (!chosen) break;
          
          // Vertical Patrol assignment limiter
          if (loc === "Vertical Patrol" && alreadyDidVerticalPatrol(chosen)) {
            continue;
          }

          roster[loc][slot].push(chosen.staffID);
          chosen.assigned.push({ slot: slot, location: loc });
          
          // Update Guard House tracking
          if (loc === "Guard House") {
            lastGuardHouseAssignment[slot] = slot;
          }

          availableStaffForSlot = availableStaffForSlot.filter(st => st.staffID !== chosen.staffID);
        }
        
        if (roster[loc][slot].length < needed) {
          shortfalls.push(`Shortfall at ${loc} for ${slot}. Needed ${needed}, got ${roster[loc][slot].length}.`);
        }
      }
    }
    
    saveAssignedToRows(staffList);
    displayRoster(roster);
    displayNotes(shortfalls);
    updateStats(roster, staffList);
    lastRoster = roster;
  }

  /*******************************************************
   * NEW: BREAK TIME VALIDATION
   *******************************************************/
  function validateBreakTime(start, end) {
    const startM = timeToMinutes(start);
    const endM = timeToMinutes(end);
    if (startM >= endM) {
      alert("Break start time must be before end time!");
      return false;
    }
    return true;
  }

  /*******************************************************
   * ENHANCED: STAFF ELIGIBILITY CHECKS
   *******************************************************/
  function isStaffEligible(st, slot, loc, totalStaffCount) {
    if (st.attendance !== "Yes") return false;
    if (!staffAvailableSlot(st, slot)) return false;
    if (alreadyAssignedSlot(st, slot, loc, totalStaffCount)) return false;
    
    // Strict HHMD check
    if (loc === "HHMD" && st.hhmdEligible !== "Yes") return false;
    
    // Enhanced Guard House gap (now location-based)
    if (loc === "Guard House") {
      const lastAssigned = lastGuardHouseAssignment[slot];
      if (lastAssigned && (timeToMinutes(slot) - timeToMinutes(lastAssigned)) < 60) return false;
    }
    
    return true;
  }

  /*******************************************************
   * NEW: REPORT ROOM WEEKEND HANDLING
   *******************************************************/
  function locationApplies(loc, slot, isWeekend) {
    if (loc === "Report Room" && isWeekend) return false;
    // ... (rest of original logic)
  }

  // ... (Remaining functions updated with enhanced checks)

  // [Rest of the original script remains with these key modifications]
</script>
</body>
</html>