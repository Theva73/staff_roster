<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Staff Roster Management System</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            text-align: center;
            font-size: 14px;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
        }
        th, td { 
            border: 1px solid #ccc; 
            padding: 6px; 
            text-align: center; 
        }
        th { 
            background-color: #f4f4f4; 
        }
        input, select { 
            padding: 4px; 
            text-align: center;
            font-size: 12px;
        }
        .inline-block { 
            display: inline-block; 
            margin: 10px; 
        }
        .break-time-container { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 5px; 
            border: 1px solid #ccc;
            padding: 3px;
            background-color: #fafafa;
        }
        .shortfall-note { 
            color: red; 
            font-weight: bold; 
        }
        .button-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 16px;
            align-items: center;
        }
        .button-row {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        .roster-btn {
            background-color: #6B7280;
            color: white;
            padding: 2px 8px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            min-width: 80px;
            cursor: pointer;
        }
        .roster-btn:hover {
            background-color: #4B5563;
        }
        .remove-btn {
            background-color: #6B7280;
            color: white;
            padding: 1px 6px;
            font-size: 11px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
        }
        .remove-btn:hover {
            background-color: #4B5563;
        }
        #importFile {
            display: none;
        }
    </style>
</head>
<body>
    <h2>Staff Roster Management System</h2>

    <!-- Date & Day Selection -->
    <div class="inline-block">
        <label for="rosterDate">Date:</label>
        <input type="date" id="rosterDate" />
    </div>
    <div class="inline-block">
        <label for="rosterDay">Day:</label>
        <select id="rosterDay">
            <option value="Monday">Monday</option>
            <option value="Tuesday">Tuesday</option>
            <option value="Wednesday">Wednesday</option>
            <option value="Thursday">Thursday</option>
            <option value="Friday">Friday</option>
            <option value="Saturday">Saturday</option>
            <option value="Sunday">Sunday</option>
        </select>
    </div>

    <!-- Staff Table -->
    <table id="staffTable">
        <thead>
            <tr>
                <th>Staff ID</th>
                <th>Name</th>
                <th>Break Time</th>
                <th>HHMD Eligible</th>
                <th>Attendance</th>
                <th>Lock</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Buttons in two rows -->
    <div class="button-container">
        <!-- First row -->
        <div class="button-row">
            <button class="roster-btn" onclick="addStaff()">Add Staff</button>
            <button class="roster-btn" onclick="importData()">Import Data</button>
        </div>
        <!-- Second row -->
        <div class="button-row">
            <button class="roster-btn" onclick="generateRoster()">Generate Roster</button>
            <button class="roster-btn" onclick="exportData()">Export Data</button>
            <button class="roster-btn" onclick="copyTSV()">Copy Roster TSV</button>
        </div>
    </div>

    <input type="file" id="importFile" accept=".json">

    <!-- Generated Roster Display -->
    <h3>Generated Roster</h3>
    <div id="rosterContainer"></div>

    <!-- Notes & Shortfalls Display -->
    <h4>Notes & Shortfalls</h4>
    <div id="notesContainer"></div>

    <script>
        // Constants
        const STORAGE_KEY = 'staffListData';
        const HALF_HOURS = [
            "20:00","20:30","21:00","21:30","22:00","22:30","23:00","23:30",
            "00:00","00:30","01:00","01:30","02:00","02:30","03:00","03:30",
            "04:00","04:30","05:00","05:30","06:00","06:30","07:00","07:30"
        ];

        const OUTPUT_ORDER = [
            "Vertical Patrol", "Pass Counter", "Lobby", "HHMD",
            "Guard House", "Report Room", "Tango Papa"
        ];

        const PRIORITY = [
            { location: "Pass Counter", needed: 2 },
            { location: "HHMD", needed: 1 },
            { location: "Lobby", needed: 2 },
            { location: "Guard House", needed: 1 },
            { location: "Vertical Patrol", needed: 1 },
            { location: "Report Room", needed: 1 },
            { location: "Tango Papa", needed: 1 }
        ];

        // Staff Management Functions
        function addStaff() {
            const tbody = document.getElementById("staffTable").getElementsByTagName("tbody")[0];
            const newStaff = {
                staffID: "",
                name: "",
                breakTime: "21:30-23:30",
                hhmdEligible: "No",
                attendance: "Yes",
                locked: false,
                assigned: []
            };
            tbody.insertAdjacentHTML("beforeend", getStaffRowHTML(newStaff));
            addListenersToAllRows();
            saveStaffList();
        }

        function removeRow(button) {
            button.closest("tr").remove();
            saveStaffList();
        }

        function getStaffRowHTML(staff = {}) {
            const [startVal, endVal] = staff.breakTime ? staff.breakTime.split("-") : ["21:30","23:30"];
            return `
                <tr data-assigned='${JSON.stringify(staff.assigned || [])}'>
                    <td><input type="text" value="${staff.staffID || ''}" class="staff-input"></td>
                    <td><input type="text" value="${staff.name || ''}" class="staff-input"></td>
                    <td>
                        <div class="break-time-container">
                            <input type="time" value="${startVal}" step="1800" class="time-input">
                            <span>-</span>
                            <input type="time" value="${endVal}" step="1800" class="time-input">
                        </div>
                    </td>
                    <td>
                        <select class="staff-select">
                            <option value="Yes" ${staff.hhmdEligible==="Yes"?"selected":""}>Yes</option>
                            <option value="No" ${staff.hhmdEligible==="No"?"selected":""}>No</option>
                        </select>
                    </td>
                    <td>
                        <select class="staff-select">
                            <option value="Yes" ${staff.attendance==="Yes"?"selected":""}>Yes</option>
                            <option value="No" ${staff.attendance==="No"?"selected":""}>No</option>
                        </select>
                    </td>
                    <td>
                        <input type="checkbox" ${staff.locked?"checked":""}>
                    </td>
                    <td><button class="remove-btn" onclick="removeRow(this)">Remove</button></td>
                </tr>
            `;
        }

        // Data Import/Export Functions
        function exportData() {
            const staffList = getCurrentStaffList();
            const dataStr = JSON.stringify(staffList, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `staff_roster_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.getElementById('importFile');
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const staffList = JSON.parse(e.target.result);
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(staffList));
                        loadStaffList();
                    } catch (error) {
                        alert('Error importing file: ' + error.message);
                    }
                };
                
                reader.readAsText(file);
            };
            input.click();
        }

        function copyTSV() {
            const table = document.querySelector("#rosterContainer table");
            if (!table) {
                alert("Please generate the roster first.");
                return;
            }

            let tsv = '';
            const headers = Array.from(table.querySelectorAll('thead th'))
                .map(th => th.textContent);
            tsv += headers.join('\t') + '\n';

            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td'))
                    .map(td => td.textContent);
                tsv += cells.join('\t') + '\n';
            });

            navigator.clipboard.writeText(tsv).then(() => {
                alert('Roster copied to clipboard in TSV format');
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy roster to clipboard');
            });
        }

        // Roster Generation Functions
        function staffAvailableHalfHour(st, slot) {
            const [bStart, bEnd] = st.breakTime.split("-");
            if (!bStart || !bEnd) return true;
            
            if (slot >= bStart && slot <= bEnd) {
                return false;
            }
            return true;
        }

        function isStaffEligible(st, slot, loc) {
            if (st.attendance !== "Yes") return false;
            if (st.locked && !alreadyAssignedSlot(st, slot)) return false;
            if (!staffAvailableHalfHour(st, slot)) return false;
            if (st.assigned.some(a => a.slot === slot)) return false;
            if (loc === "HHMD" && st.hhmdEligible !== "Yes") return false;
            if (loc !== "Lobby" && isBackToBack(st, slot, loc)) return false;
            if (violates2HourGap(st, slot, loc)) return false;
            return true;
        }

        function isBackToBack(st, slot, loc) {
            const idx = HALF_HOURS.indexOf(slot);
            if (idx <= 0) return false;
            
            const prevSlot = HALF_HOURS[idx-1];
            const nextSlot = HALF_HOURS[idx+1];
            
            return st.assigned.some(a => 
                (a.slot === prevSlot || a.slot === nextSlot) && 
                a.location === loc
            );
        }

        function alreadyAssignedSlot(st, slot) {
            return st.assigned.some(a => a.slot === slot);
        }

        function violates2HourGap(st, slot, loc) {
            const idx = HALF_HOURS.indexOf(slot);
            for (let i = 1; i <= 4; i++) {
                if (idx - i < 0) break;
                const checkSlot = HALF_HOURS[idx - i];
                if (st.assigned.some(a => a.slot === checkSlot && a.location === loc)) {
                    return true;
                }
            }
            return false;
        }

        function locationApplies(loc, slot, isWeekend) {
            if (loc === "Vertical Patrol") {
                return ["20:00","23:00","01:00","06:00"].includes(slot);
            }
            if (loc === "Report Room") {
                if (isWeekend) return false;
                return ["20:00","21:00"].includes(slot);
            }
            if (loc === "Tango Papa") {
                return slot === "07:30";
            }
            return true;
        }

        function pickStaffForSlot(staffList, slot, loc) {
            for (let st of staffList) {
                if (!isStaffEligible(st, slot, loc)) continue;
                if (loc === "Lobby" && isLobbyRepeat(st, slot)) continue;
                return st;
            }
            
            if (loc === "Lobby") {
                for (let st of staffList) {
                    if (!isStaffEligible(st, slot, loc)) continue;
                    return st;
                }
            }
            return null;
        }

        function isLobbyRepeat(st, slot) {
            const idx = HALF_HOURS.indexOf(slot);
            if (idx <= 0) return false;
            const prevSlot = HALF_HOURS[idx-1];
            return st.assigned.some(a => a.slot === prevSlot && a.location === "Lobby");
        }

        function generateRoster() {
            const dayValue = document.getElementById("rosterDay").value;
            const isWeekend = (dayValue === "Saturday" || dayValue === "Sunday");
            
            let staffList = getCurrentStaffList();
            staffList.forEach(st => {
                if (!st.locked) st.assigned = [];
            });
            
            let roster = {};
            OUTPUT_ORDER.forEach(loc => { roster[loc] = {}; });
            let shortfalls = [];
            
            for (let slot of HALF_HOURS) {
                for (let p of PRIORITY) {
                    let loc = p.location;
                    if (!locationApplies(loc, slot, isWeekend)) continue;
                    
                    let needed = p.needed;