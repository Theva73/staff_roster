<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Advanced One-Hour Roster (Debug Mode)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f4f4f4; }
    button { padding: 10px; margin: 10px; cursor: pointer; }
    input, select { padding: 5px; text-align: center; }
    .inline-block { display: inline-block; margin: 10px; }
    .break-time-container { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 5px; 
      border: 1px solid #ccc;
      padding: 3px;
      background-color: #fafafa;
    }
    .draggable { cursor: move; }
    .shortfall-note { color: red; font-weight: bold; }
  </style>
</head>
<body>

  <h2>Advanced One-Hour Roster (Debug Mode)</h2>

  <!-- Date & Day Selection -->
  <div class="inline-block">
    <label for="rosterDate">Date:</label>
    <input type="date" id="rosterDate" />
  </div>
  <div class="inline-block">
    <label for="rosterDay">Day:</label>
    <select id="rosterDay">
      <option value="Monday">Monday</option>
      <option value="Tuesday">Tuesday</option>
      <option value="Wednesday">Wednesday</option>
      <option value="Thursday">Thursday</option>
      <option value="Friday">Friday</option>
      <option value="Saturday">Saturday</option>
      <option value="Sunday">Sunday</option>
    </select>
  </div>

  <!-- Staff Table -->
  <table id="staffTable">
    <thead>
      <tr>
        <th>Staff ID</th>
        <th>Name</th>
        <th>Break Time (Start - End)</th>
        <th>HHMD Eligible?</th>
        <th>Attendance</th>
        <th>Lock</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <!-- Rows will be loaded from localStorage or a sample row is created -->
    </tbody>
  </table>

  <button onclick="addStaff()">Add Staff</button>
  <button onclick="generateRoster()">Generate Roster</button>
  <button onclick="sendWhatsApp()">Send via WhatsApp</button>

  <h3>Generated Staff Roster</h3>
  <div id="rosterContainer"></div>

  <h4>Notes & Shortfalls</h4>
  <div id="notesContainer"></div>

  <script>
    console.log("Script loaded: Starting debug version...");

    /*******************************************************
     *            GLOBAL CONSTANTS & CONFIG
     *******************************************************/
    const STORAGE_KEY = 'staffListData_OneHour_Debug';

    // One-hour increments from 20:00 to 07:00 (12 slots).
    const HALF_HOURS = [
      "20:00", "21:00", "22:00", "23:00",
      "00:00", "01:00", "02:00", "03:00",
      "04:00", "05:00", "06:00", "07:00"
    ];

    // Output rows (locations)
    const OUTPUT_ORDER = [
      "Vertical Patrol",
      "Pass Counter",
      "Lobby",
      "HHMD",
      "Guard House",
      "Report Room",
      "Tango Papa"
    ];

    // Priority for each location per time slot
    const PRIORITY = [
      { location: "Pass Counter", needed: 2 },
      { location: "HHMD",        needed: 1 },
      { location: "Lobby",       needed: 2 },
      { location: "Guard House", needed: 1 },
      { location: "Vertical Patrol", needed: 1 },
      { location: "Report Room",     needed: 1 },
      { location: "Tango Papa",      needed: 1 }
    ];

    /*******************************************************
     *            INITIALIZATION (ON LOAD)
     *******************************************************/
    window.onload = function() {
      console.log("window.onload triggered");
      loadStaffList();
    };

    /*******************************************************
     *            LOAD/SAVE STAFF
     *******************************************************/
    function loadStaffList() {
      console.log("loadStaffList() called");
      let stored = null;
      try {
        stored = localStorage.getItem(STORAGE_KEY);
      } catch(e) {
        console.error("Error accessing localStorage:", e);
      }
      const tbody = document.getElementById("staffTable").getElementsByTagName("tbody")[0];

      if (stored) {
        console.log("Found stored data in localStorage:", stored);
        let staffList = [];
        try {
          staffList = JSON.parse(stored);
        } catch(e) {
          console.error("Error parsing stored JSON:", e);
          staffList = [];
        }
        tbody.innerHTML = "";
        staffList.forEach(staff => {
          tbody.innerHTML += getStaffRowHTML(staff);
        });
      } else {
        console.log("No stored data found; adding a sample row");
        addStaff(); // create one sample row if none stored
      }
      addListenersToAllRows();
    }

    function saveStaffList() {
      console.log("saveStaffList() called");
      const staffList = [];
      const rows = document.getElementById("staffTable").getElementsByTagName("tbody")[0].rows;

      for (let row of rows) {
        const staffID = row.cells[0].querySelector("input").value.trim();
        const name    = row.cells[1].querySelector("input").value.trim();

        const timeInputs = row.cells[2].querySelectorAll("input[type='time']");
        const startVal   = timeInputs[0].value;
        const endVal     = timeInputs[1].value;
        const breakTime  = startVal + "-" + endVal;

        const hhmdEligible = row.cells[3].querySelector("select").value;
        const attendance   = row.cells[4].querySelector("select").value;
        const locked       = row.cells[5].querySelector("input[type='checkbox']").checked;
        let workedLastTwoDays = row.dataset.worked ? JSON.parse(row.dataset.worked) : [];
        let assigned = row.dataset.assigned ? JSON.parse(row.dataset.assigned) : [];

        staffList.push({
          staffID,
          name,
          breakTime,
          hhmdEligible,
          attendance,
          locked,
          workedLastTwoDays,
          assigned
        });
      }

      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(staffList));
        console.log("saveStaffList(): staffList saved:", staffList);
      } catch(e) {
        console.error("Error saving to localStorage:", e);
      }
    }

    /*******************************************************
     *         STAFF ROW CREATION/REMOVAL
     *******************************************************/
    function getStaffRowHTML(staff) {
      let [startVal, endVal] = staff.breakTime ? staff.breakTime.split("-") : ["21:00","23:00"];
      return `
        <tr data-worked='${JSON.stringify(staff.workedLastTwoDays || [])}'
            data-assigned='${JSON.stringify(staff.assigned || [])}'>
          <td><input type="text" value="${staff.staffID}"></td>
          <td><input type="text" value="${staff.name}"></td>
          <td>
            <div class="break-time-container draggable" draggable="true">
              <input type="time" value="${startVal || "21:00"}" step="1">
              <span>-</span>
              <input type="time" value="${endVal   || "23:00"}" step="1">
            </div>
          </td>
          <td>
            <select>
              <option value="Yes" ${staff.hhmdEligible==="Yes"?"selected":""}>Yes</option>
              <option value="No"  ${staff.hhmdEligible==="No" ?"selected":""}>No</option>
            </select>
          </td>
          <td>
            <select>
              <option ${staff.attendance==="Yes"?"selected":""}>Yes</option>
              <option ${staff.attendance==="No" ?"selected":""}>No</option>
            </select>
          </td>
          <td>
            <input type="checkbox" ${staff.locked?"checked":""}>
          </td>
          <td><button onclick="removeRow(this)">Remove</button></td>
        </tr>
      `;
    }

    function addStaff() {
      console.log("addStaff() called");
      const tbody = document.getElementById("staffTable").getElementsByTagName("tbody")[0];
      const newStaff = {
        staffID: "",
        name: "",
        breakTime: "21:00-23:00",
        hhmdEligible: "No",
        attendance: "Yes",
        locked: false,
        workedLastTwoDays: [],
        assigned: []
      };
      tbody.insertAdjacentHTML("beforeend", getStaffRowHTML(newStaff));
      addListenersToAllRows();
      saveStaffList();
    }

    function removeRow(button) {
      console.log("removeRow() called");
      button.closest("tr").remove();
      saveStaffList();
    }

    /*******************************************************
     *            DRAG & DROP SWAP TIME
     *******************************************************/
    let draggedContainer = null;

    function addDragAndDropListeners(element) {
      element.addEventListener("dragstart", function(e) {
        draggedContainer = element;
        e.dataTransfer.effectAllowed = "move";
        console.log("dragstart on break-time container");
      });

      element.addEventListener("dragover", function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
      });

      element.addEventListener("drop", function(e) {
        e.preventDefault();
        if (draggedContainer && draggedContainer !== element) {
          console.log("drop on break-time container -> swapping times");
          const sourceTimes = draggedContainer.querySelectorAll("input[type='time']");
          const targetTimes = element.querySelectorAll("input[type='time']");
          let tmpStart = sourceTimes[0].value, tmpEnd = sourceTimes[1].value;
          sourceTimes[0].value = targetTimes[0].value;
          sourceTimes[1].value = targetTimes[1].value;
          targetTimes[0].value = tmpStart;
          targetTimes[1].value = tmpEnd;
          saveStaffList();
        }
      });
    }

    function addListenersToAllRows() {
      console.log("addListenersToAllRows() called");
      const tbody = document.getElementById("staffTable").getElementsByTagName("tbody")[0];
      for (let row of tbody.rows) {
        const container = row.cells[2].querySelector(".break-time-container");
        addDragAndDropListeners(container);

        const allInputs = row.querySelectorAll("input, select");
        allInputs.forEach(inp => {
          inp.addEventListener("change", function() {
            console.log("Input changed -> saving staff");
            saveStaffList();
          });
        });
      }
    }

    /*******************************************************
     *          GENERATE ROSTER (ONE-HOUR)
     *******************************************************/
    function generateRoster() {
      console.log("generateRoster() called");
      saveStaffList();  
      const dayValue = document.getElementById("rosterDay").value; 
      const isWeekend = (dayValue === "Saturday" || dayValue === "Sunday");

      let staffList = getCurrentStaffList();
      staffList.forEach(st => {
        if (!st.locked) {
          console.log(`Clearing assignments for unlocked staff ${st.staffID}`);
          st.assigned = [];
        }
      });

      let roster = {};
      OUTPUT_ORDER.forEach(loc => { roster[loc] = {}; });
      let shortfalls = [];

      // For each one-hour slot, fill in priority order
      for (let slot of HALF_HOURS) {
        for (let p of PRIORITY) {
          let loc = p.location;
          if (!locationApplies(loc, slot, isWeekend)) continue;

          let needed = p.needed;
          if (!roster[loc][slot]) roster[loc][slot] = [];
          let assignedCount = roster[loc][slot].length;

          while (assignedCount < needed) {
            let chosen = pickStaffForSlot(staffList, slot, loc);
            if (!chosen) {
              console.log(`No available staff found for ${loc} at ${slot}`);
              break;
            }
            roster[loc][slot].push(chosen.staffID);
            chosen.assigned.push({ slot, location: loc });
            assignedCount++;
          }

          if ((loc === "Pass Counter" || loc === "Lobby") && assignedCount < needed) {
            shortfalls.push(`Shortfall at ${loc} for ${slot}. Needed ${needed}, got ${assignedCount}.`);
          }
        }
      }

      saveAssignedToRows(staffList);
      displayRoster(roster);
      displayNotes(shortfalls);
    }

    function getCurrentStaffList() {
      console.log("getCurrentStaffList() called");
      let staffList = [];
      const rows = document.getElementById("staffTable").getElementsByTagName("tbody")[0].rows;
      for (let row of rows) {
        const staffID = row.cells[0].querySelector("input").value.trim();
        const name    = row.cells[1].querySelector("input").value.trim();

        const timeInputs = row.cells[2].querySelectorAll("input[type='time']");
        const startVal   = timeInputs[0].value;
        const endVal     = timeInputs[1].value;
        const breakTime  = startVal + "-" + endVal;

        const hhmdEligible = row.cells[3].querySelector("select").value;
        const attendance   = row.cells[4].querySelector("select").value;
        const locked       = row.cells[5].querySelector("input[type='checkbox']").checked;
        let workedLastTwoDays = row.dataset.worked ? JSON.parse(row.dataset.worked) : [];
        let assigned = row.dataset.assigned ? JSON.parse(row.dataset.assigned) : [];

        staffList.push({
          staffID,
          name,
          breakTime,
          hhmdEligible,
          attendance,
          locked,
          workedLastTwoDays,
          assigned
        });
      }
      console.log("Current staffList from table:", staffList);
      return staffList;
    }

    function locationApplies(loc, slot, isWeekend) {
      if (loc === "Vertical Patrol") {
        // For one-hour intervals, specific times for Vertical Patrol
        return ["20:00","23:00","01:00","06:00"].includes(slot);
      }
      if (loc === "Report Room") {
        if (isWeekend) return false;
        return (slot === "20:00" || slot === "21:00");
      }
      if (loc === "Tango Papa") {
        return (slot === "07:00");
      }
      return true;
    }

    function pickStaffForSlot(staffList, slot, loc) {
      console.log(`pickStaffForSlot(${loc}, ${slot})`);
      // 1st pass: skip staff who are "lobby repeats" if loc=Lobby
      for (let st of staffList) {
        if (!isStaffEligible(st, slot, loc)) continue;
        // If loc=Lobby, skip staff who worked previous slot in Lobby
        if (loc === "Lobby" && isLobbyRepeat(st, slot)) {
          continue;
        }
        console.log(`Picked staff ${st.staffID} for ${loc} at ${slot} (1st pass)`);
        return st;
      }
      // 2nd pass (for Lobby): if none found, allow repeats
      if (loc === "Lobby") {
        console.log(`No staff found in 1st pass for Lobby at ${slot}; allowing repeats`);
        for (let st of staffList) {
          if (!isStaffEligible(st, slot, loc)) continue;
          console.log(`Picked staff ${st.staffID} for Lobby at ${slot} (2nd pass)`);
          return st;
        }
      }
      return null;
    }

    function isStaffEligible(st, slot, loc) {
      // If locked & not assigned to this slot, skip
      if (st.locked && !alreadyAssignedSlot(st, slot)) {
        return false;
      }
      if (st.attendance !== "Yes") return false;
      if (!staffAvailableSlot(st, slot)) return false;
      if (alreadyAssignedSlot(st, slot)) return false;
      if (loc === "HHMD" && st.hhmdEligible !== "Yes") return false;
      if (loc !== "Lobby" && isBackToBack(st, slot, loc)) return false;
      if (violates2HourGap(st, slot, loc)) return false;
      return true;
    }

    function alreadyAssignedSlot(st, slot) {
      return st.assigned.some(a => a.slot === slot);
    }

    function staffAvailableSlot(st, slot) {
      const [bStart, bEnd] = st.breakTime.split("-");
      if (!bStart || !bEnd) return true;
      let startM = timeToMinutes(bStart);
      let endM   = timeToMinutes(bEnd);
      let slotM  = timeToMinutes(slot);
      if (endM < startM) {
        // simplistic approach for wrap-around breaks
        return true;
      }
      return !(slotM >= startM && slotM < endM);
    }

    function timeToMinutes(t) {
      let [H, M] = t.split(":");
      return parseInt(H,10)*60 + parseInt(M,10);
    }

    function isBackToBack(st, slot, loc) {
      let idx = HALF_HOURS.indexOf(slot);
      if (idx <= 0) return false;
      let prevSlot = HALF_HOURS[idx-1];
      return st.assigned.some(a => a.slot === prevSlot && a.location === loc);
    }

    function isLobbyRepeat(st, slot) {
      let idx = HALF_HOURS.indexOf(slot);
      if (idx <= 0) return false;
      let prevSlot = HALF_HOURS[idx-1];
      return st.assigned.some(a => a.slot === prevSlot && a.location === "Lobby");
    }

    function violates2HourGap(st, slot, loc) {
      let idx = HALF_HOURS.indexOf(slot);
      // For one-hour intervals, check the previous 2 slots for a 2-hour gap
      for (let i = 1; i <= 2; i++) {
        if (idx - i < 0) break;
        let checkSlot = HALF_HOURS[idx - i];
        if (st.assigned.some(a => a.slot === checkSlot && a.location === loc)) {
          return true;
        }
      }
      return false;
    }

    function saveAssignedToRows(staffList) {
      console.log("saveAssignedToRows() called");
      const rows = document.getElementById("staffTable").getElementsByTagName("tbody")[0].rows;
      let i = 0;
      for (let row of rows) {
        row.dataset.assigned = JSON.stringify(staffList[i].assigned);
        i++;
      }
      saveStaffList();
    }

    /*******************************************************
     *       DISPLAY THE ROSTER & SHORTFALL NOTES
     *******************************************************/
    function displayRoster(roster) {
      console.log("displayRoster() called");
      const container = document.getElementById("rosterContainer");
      container.innerHTML = "";

      let tableHTML = `<table><thead><tr><th>Location</th>`;
      HALF_HOURS.forEach(slot => {
        tableHTML += `<th>${slot}</th>`;
      });
      tableHTML += "</tr></thead><tbody>";

      OUTPUT_ORDER.forEach(loc => {
        tableHTML += `<tr><td>${loc}</td>`;
        HALF_HOURS.forEach(slot => {
          let arr = roster[loc][slot] || [];
          if (arr.length > 1) {
            tableHTML += `<td>${arr.join("/")}</td>`;
          } else if (arr.length === 1) {
            tableHTML += `<td>${arr[0]}</td>`;
          } else {
            tableHTML += `<td></td>`;
          }
        });
        tableHTML += "</tr>";
      });

      tableHTML += "</tbody></table>";
      container.innerHTML = tableHTML;
    }

    function displayNotes(shortfalls) {
      console.log("displayNotes() called:", shortfalls);
      const notesDiv = document.getElementById("notesContainer");
      if (shortfalls.length === 0) {
        notesDiv.innerHTML = "<p>No critical shortfalls.</p>";
      } else {
        notesDiv.innerHTML = shortfalls.map(s => `<p class="shortfall-note">${s}</p>`).join("");
      }
    }

    /*******************************************************
     *         WHATSAPP SHARING
     *******************************************************/
    function sendWhatsApp() {
      console.log("sendWhatsApp() called");
      let rosterText = "ðŸ“‹ *Staff Roster (One-Hour)*\n\n";
      const table = document.querySelector("#rosterContainer table");
      if (!table) {
        alert("Please generate the roster first.");
        return;
      }
      const rows = table.querySelectorAll("tbody tr");
      rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        rosterText += `*${cells[0].innerText}*\n`; // location name
        for (let i = 1; i < cells.length; i++) {
          if (cells[i].innerText) {
            const slot = table.querySelector("thead").rows[0].cells[i].innerText;
            rosterText += `- ${cells[i].innerText} at ${slot}\n`;
          }
        }
        rosterText += "\n";
      });
      const whatsappURL = `https://wa.me/?text=${encodeURIComponent(rosterText)}`;
      window.open(whatsappURL, "_blank");
    }
  </script>
</body>
</html>