<style>
body { 
  font-family: Arial, sans-serif; 
  padding: 20px; 
  text-align: center;
  font-size: 14px;
  background-color: #f3f4f6;
  margin: 0; 
}

table { 
  width: 100%; 
  border-collapse: collapse; 
  margin-top: 20px; 
}

th, td { 
  border: 1px solid #ccc; 
  padding: 6px; 
  text-align: center; 
}

th { 
  background-color: #f4f4f4; 
}

input, select { 
  padding: 4px; 
  text-align: center;
  font-size: 12px;
}

.date-container {
  margin: 20px 0;
  display: flex;
  justify-content: center;
  gap: 20px;
  flex-wrap: wrap;
}

.date-container > div {
  display: flex;
  align-items: center;
  gap: 8px;
}

.break-time-container { 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  gap: 5px;
}

.button-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin: 16px 0;
  align-items: center;
}

.button-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: center;
}

.roster-btn {
  background-color: #6B7280;
  color: white;
  padding: 4px 10px;
  font-size: 12px;
  border-radius: 4px;
  border: none;
  cursor: pointer;
}

.roster-btn:hover {
  background-color: #4B5563;
}

.remove-btn {
  background-color: #6B7280;
  color: white;
  padding: 1px 6px;
  font-size: 11px;
  border-radius: 3px;
  border: none;
  cursor: pointer;
}

.shortfall-note {
  color: red;
  font-weight: bold;
  font-size: 12px;
}

#importFile {
  display: none;
}

#rosterContainer {
  overflow-x: auto;
}

/* Additional styling for the roster table */
#rosterContainer table {
  margin-top: 20px;
  width: 100%;
}

#rosterContainer th {
  background-color: #e5e7eb;
  font-weight: bold;
}

#rosterContainer td.critical-shortfall {
  background-color: #fee2e2;
  color: #991b1b;
}

#notesContainer {
  margin-top: 20px;
  text-align: left;
  padding: 10px;
}
</style>

// Core Constants
const STORAGE_KEY = 'staffListData';
const ROSTER_TIMES = [
  "20:00", "20:30", "21:00", "22:00", "23:00", "00:00", "01:00", "01:30", 
  "02:00", "03:00", "04:00", "05:00", "06:00", "07:00", "07:30"
];

const PRIORITY = [
  { location: "Pass Counter", needed: 2 },
  { location: "HHMD", needed: 1 },
  { location: "Lobby", needed: 2 },
  { location: "Guard House", needed: 1 },
  { location: "Vertical Patrol", needed: 1 },
  { location: "Report Room", needed: 1 },
  { location: "Tango Papa", needed: 1 }
];

window.rosterSystem = {
  init: function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('rosterDate').value = today;
    
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const currentDay = days[new Date().getDay()];
    document.getElementById('rosterDay').value = currentDay;
    
    this.loadStaffList();
  },

  // Staff Management Functions
  loadStaffList: function() {
    const stored = localStorage.getItem(STORAGE_KEY);
    const tbody = document.getElementById("staffTable").getElementsByTagName("tbody")[0];

    if (stored) {
      const staffList = JSON.parse(stored);
      tbody.innerHTML = "";
      staffList.forEach(staff => {
        tbody.innerHTML += this.getStaffRowHTML(staff);
      });
    } else {
      this.addStaff();
    }
    this.addListenersToAllRows();
  },

  getStaffRowHTML: function(staff = {}) {
    const [startVal, endVal] = staff.breakTime ? staff.breakTime.split("-") : ["21:30", "23:30"];
    return `
      <tr data-assigned='${JSON.stringify(staff.assigned || [])}'>
        <td><input type="text" value="${staff.staffID || ''}" class="staff-input"></td>
        <td><input type="text" value="${staff.name || ''}" class="staff-input"></td>
        <td>
          <div class="break-time-container">
            <input type="time" value="${startVal}" step="1800" class="time-input">
            <span>-</span>
            <input type="time" value="${endVal}" step="1800" class="time-input">
          </div>
        </td>
        <td>
          <select class="staff-select">
            <option value="Yes" ${staff.hhmdEligible==="Yes"?"selected":""}>Yes</option>
            <option value="No" ${staff.hhmdEligible==="No"?"selected":""}>No</option>
          </select>
        </td>
        <td>
          <select class="staff-select">
            <option value="Yes" ${staff.attendance==="Yes"?"selected":""}>Yes</option>
            <option value="No" ${staff.attendance==="No"?"selected":""}>No</option>
          </select>
        </td>
        <td>
          <input type="checkbox" ${staff.locked?"checked":""}>
        </td>
        <td><button class="remove-btn" onclick="window.rosterSystem.removeRow(this)">Remove</button></td>
      </tr>
    `;
  },

  addStaff: function() {
    const tbody = document.getElementById("staffTable").getElementsByTagName("tbody")[0];
    const newStaff = {
      staffID: "",
      name: "",
      breakTime: "21:30-23:30",
      hhmdEligible: "No",
      attendance: "Yes",
      locked: false,
      assigned: []
    };
    tbody.insertAdjacentHTML("beforeend", this.getStaffRowHTML(newStaff));
    this.addListenersToAllRows();
    this.saveStaffList();
  },

  // Core Roster Generation Functions
  locationApplies: function(loc, slot, isWeekend) {
    // Special case: At 07:30, only Tango Papa should be staffed
    if (slot === "07:30") {
      return loc === "Tango Papa";
    }

    switch(loc) {
      case "Vertical Patrol":
        return ["20:30", "23:00", "01:30", "06:00"].includes(slot);
      case "Report Room":
        if (isWeekend) return false;
        return ["20:00", "21:00"].includes(slot);
      case "Tango Papa":
        return slot === "07:30";
      default:
        return true;
    }
  },

  isStaffEligible: function(st, slot, loc) {
    if (st.attendance !== "Yes") return false;
    if (st.locked && !this.alreadyAssignedSlot(st, slot)) return false;
    if (!this.staffAvailableHalfHour(st, slot)) return false;
    if (loc === "HHMD" && st.hhmdEligible !== "Yes") return false;
    if (st.assigned.some(a => a.slot === slot)) return false;
    if (loc !== "Lobby" && this.isBackToBack(st, slot, loc)) return false;
    if (this.violates2HourGap(st, slot, loc)) return false;
    return true;
  },

  staffAvailableHalfHour: function(st, slot) {
    const [bStart, bEnd] = st.breakTime.split("-");
    if (!bStart || !bEnd) return true;
    if (slot >= bStart && slot <= bEnd) return false;
    return true;
  },

  isBackToBack: function(st, slot, loc) {
    const idx = ROSTER_TIMES.indexOf(slot);
    if (idx <= 0) return false;
    
    const prevSlot = ROSTER_TIMES[idx-1];
    const nextSlot = ROSTER_TIMES[idx+1];
    
    return st.assigned.some(a => 
      (a.slot === prevSlot || a.slot === nextSlot) && 
      a.location === loc
    );
  },

  violates2HourGap: function(st, slot, loc) {
    const idx = ROSTER_TIMES.indexOf(slot);
    for (let i = 1; i <= 2; i++) {
      if (idx - i < 0) break;
      const checkSlot = ROSTER_TIMES[idx - i];
      if (st.assigned.some(a => a.slot === checkSlot && a.location === loc)) {
        return true;
      }
    }
    return false;
  },

  generateRoster: function() {
    const dayValue = document.getElementById("rosterDay").value;
    const isWeekend = (dayValue === "Saturday" || dayValue === "Sunday");
    
    let staffList = this.getCurrentStaffList().filter(staff => staff.attendance === "Yes");
    if (staffList.length === 0) {
      alert("Please add staff members before generating roster.");
      return;
    }

    // Clear assigned slots (unless locked)
    staffList.forEach(st => {
      if (!st.locked) st.assigned = [];
    });
    
    let roster = {};
    let shortfalls = [];
    PRIORITY.forEach(({location}) => { roster[location] = {}; });
    
    // Generate roster for each time slot
    for (let slot of ROSTER_TIMES) {
      for (let p of PRIORITY) {
        let loc = p.location;
        if (!this.locationApplies(loc, slot, isWeekend)) continue;
        
        let needed = p.needed;
        if (!roster[loc][slot]) roster[loc][slot] = [];
        let assignedCount = roster[loc][slot].length;
        
        while (assignedCount < needed) {
          let chosen = this.pickStaffForSlot(staffList, slot, loc);
          if (!chosen) break;
          roster[loc][slot].push(chosen.staffID);
          chosen.assigned.push({ slot, location: loc });
          assignedCount++;
        }
        
        // Track shortfalls for Pass Counter (except at 07:30)
        if (loc === "Pass Counter" && slot !== "07:30" && assignedCount < 2) {
          shortfalls.push(`Critical Shortfall: Pass Counter at ${slot} has only ${assignedCount} staff`);
        }
      }
    }
    
    window.generatedRosterData = roster;
    this.saveAssignedToRows(staffList);
    this.displayRoster(roster);
    this.displayNotes(shortfalls);
  },

  pickStaffForSlot: function(staffList, slot, loc) {
    for (let st of staffList) {
      if (!this.isStaffEligible(st, slot, loc)) continue;
      if (loc === "Lobby" && this.isLobbyRepeat(st, slot)) continue;
      return st;
    }
    
    // Second pass for Lobby without repeat check
    if (loc === "Lobby") {
      for (let st of staffList) {
        if (!this.isStaffEligible(st, slot, loc)) continue;
        return st;
      }
    }
    return null;
  },

  isLobbyRepeat: function(st, slot) {
    const idx = ROSTER_TIMES.indexOf(slot);
    if (idx <= 0) return false;
    const prevSlot = ROSTER_TIMES[idx-1];
    return st.assigned.some(a => a.slot === prevSlot && a.location === "Lobby");
  },

  displayRoster: function(roster) {
    const container = document.getElementById("rosterContainer");
    let tableHTML = `<table><thead><tr><th>Location</th>`;
    
    ROSTER_TIMES.forEach(slot => {
      tableHTML += `<th>${slot}</th>`;
    });
    tableHTML += "</tr></thead><tbody>";

    Object.keys(roster).forEach(loc => {
      tableHTML += `<tr><td>${loc}</td>`;
      ROSTER_TIMES.forEach(slot => {
        const assignments = roster[loc][slot] || [];
        let display = assignments.join("/");
        if (loc === "Lobby" && assignments.length === 2) {
          display = `${assignments[0]}/${assignments[1]}`;
        }
        tableHTML += `<td contenteditable="true">${display}</td>`;
      });
      tableHTML += "</tr>";
    });

    tableHTML += "</tbody></table>";
    container.innerHTML = tableHTML;
  },

  displayNotes: function(shortfalls) {
    const notesDiv = document.getElementById("notesContainer");
    if (shortfalls.length === 0) {
      notesDiv.innerHTML = "<p>No critical shortfalls.</p>";
    } else {
      notesDiv.innerHTML = shortfalls.map(s => 
        `<p class="shortfall-note">${s}</p>`
      ).join("");
    }
  }
};