<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staff Roster Management</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --primary: #2c5282;
      --primary-hover: #2b6cb0;
      --secondary: #718096;
      --success: #38a169;
      --warning: #ecc94b;
      --danger: #e53e3e;
      --background: #f7fafc;
      --card-bg: #ffffff;
      --border: #e2e8f0;
      --text: #2d3748;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--background);
      color: var(--text);
      padding: 2rem;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1280px;
      margin: 0 auto;
    }
    
    h2 {
      color: var(--primary);
      font-size: 2rem;
      margin-bottom: 2rem;
      text-align: center;
    }
    
    .card {
      background: var(--card-bg);
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 2rem;
      transition: transform 0.2s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
    }
    
    .flex-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      justify-content: center;
      margin: 1.5rem 0;
    }
    
    .flex-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-bg);
      border-radius: 0.5rem;
      overflow: hidden;
    }
    
    th, td {
      padding: 0.75rem;
      text-align: center;
      border: 1px solid var(--border);
    }
    
    th {
      background: var(--primary);
      color: white;
      font-weight: 600;
    }
    
    tr:nth-child(even) { background: rgba(0,0,0,0.02); }
    tr:hover { background: rgba(0,0,0,0.05); }
    
    input, select {
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(44,82,130,0.1);
    }
    
    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-danger:hover {
      opacity: 0.9;
    }
    
    #breakListContainer {
      position: fixed;
      bottom: 1.5rem;
      left: 1.5rem;
      width: 240px;
      max-height: 400px;
      background: var(--card-bg);
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 1rem;
      font-size: 0.875rem;
      overflow: auto;
      transition: opacity 0.3s;
    }
    
    #breakListContainer.hidden { opacity: 0.3; }
    #breakListContainer:hover { opacity: 1; }
    
    @media (max-width: 768px) {
      .flex-container { flex-direction: column; align-items: center; }
      .btn { width: 100%; max-width: 200px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Staff Roster Management</h2>
    
    <div class="card">
      <div class="flex-container">
        <div class="flex-item">
          <label>Roster Date:</label>
          <input type="date" id="rosterDate">
        </div>
        <div class="flex-item">
          <label>Day:</label>
          <select id="rosterDay">
            <option value="Monday">Monday</option>
            <option value="Tuesday">Tuesday</option>
            <option value="Wednesday">Wednesday</option>
            <option value="Thursday">Thursday</option>
            <option value="Friday">Friday</option>
            <option value="Saturday">Saturday</option>
            <option value="Sunday">Sunday</option>
          </select>
        </div>
        <div class="flex-item">
          <label> Gap Threshold:</label>
          <input type="range" id="gapThreshold" min="30" max="120" step="15" value="120">
          <span id="gapThresholdValue">120</span>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Staff Management</h3>
      <table id="staffTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Break Time</th>
            <th>HHMD</th>
            <th>Present</th>
            <th>Lock</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="flex-container">
        <button class="btn btn-primary" id="addStaffBtn">Add Staff</button>
        <button class="btn btn-primary" id="generateRosterBtn">Generate Roster</button>
        <button class="btn btn-primary" id="downloadPDFBtn">Download PDF</button>
      </div>
    </div>

    <div class="card">
      <h3>Roster Preview</h3>
      <div id="rosterContainer"></div>
    </div>

    <div id="breakListContainer">
      <strong>Break Times</strong><br><br>
    </div>
  </div>

  <script>
    const rosterSystem = {
      constants: {
        STORAGE_KEY: 'staffListData_v3',
        ROSTER_TIMES: ["20:00","20:30","21:00","22:00","23:00","00:00","01:00","01:30","02:00","03:00","04:00","05:00","06:00","07:00","07:30"],
        PRIORITY: [
          { location: "Pass Counter", needed: 2 },
          { location: "HHMD", needed: 1 },
          { location: "Lobby", needed: 2 },
          { location: "Guard House", needed: 1 },
          { location: "Vertical Patrol", needed: 1 },
          { location: "Report Room", needed: 1 },
          { location: "Tango Papa", needed: 1 }
        ],
        BREAK_TIME_POOL: [
          "20:00-21:30", "21:30-23:30", "22:00-00:00",
          "23:00-01:00", "00:00-02:00", "01:30-03:30",
          "02:00-04:00", "03:00-05:00", "04:00-06:00"
        ]
      },

      init() {
        this.setupEventListeners();
        this.loadStaffList();
        this.makeDraggable(document.getElementById('breakListContainer'));
      },

      setupEventListeners() {
        const debounce = (fn, delay) => {
          let timeout;
          return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => fn(...args), delay);
          };
        };

        document.getElementById('addStaffBtn').addEventListener('click', () => this.addStaff());
        document.getElementById('generateRosterBtn').addEventListener('click', () => this.generateRoster());
        document.getElementById('downloadPDFBtn').addEventListener('click', () => this.downloadAsPDF());
        
        const gapSlider = document.getElementById("gapThreshold");
        gapSlider.addEventListener("input", () => {
          document.getElementById("gapThresholdValue").textContent = gapSlider.value;
        });
      },

      loadStaffList() {
        const tbody = document.getElementById("staffTable").querySelector("tbody");
        const stored = localStorage.getItem(this.constants.STORAGE_KEY);
        if (stored) {
          const staffList = JSON.parse(stored);
          tbody.innerHTML = staffList.map(staff => this.getStaffRowHTML(staff)).join('');
        } else {
          this.addStaff();
        }
        this.addRowListeners();
      },

      getStaffRowHTML(staff = {}) {
        const [startVal, endVal] = staff.breakTime?.split("-") || ["21:30", "23:30"];
        return `
          <tr>
            <td><input type="text" value="${staff.staffID || ''}" placeholder="ID"></td>
            <td><input type="text" value="${staff.name || ''}" placeholder="Name"></td>
            <td>
              <input type="time" value="${startVal}" step="1800">
              -
              <input type="time" value="${endVal}" step="1800">
            </td>
            <td><select><option ${staff.hhmdEligible === "Yes" ? "selected" : ""}>Yes</option><option ${staff.hhmdEligible === "No" ? "selected" : ""}>No</option></select></td>
            <td><select><option ${staff.attendance === "Yes" ? "selected" : ""}>Yes</option><option ${staff.attendance === "No" ? "selected" : ""}>No</option></select></td>
            <td><input type="checkbox" ${staff.locked ? "checked" : ""}></td>
            <td><button class="btn btn-danger">Remove</button></td>
          </tr>
        `;
      },

      addStaff() {
        const tbody = document.getElementById("staffTable").querySelector("tbody");
        const newStaff = { staffID: "", name: "", breakTime: "21:30-23:30", hhmdEligible: "No", attendance: "Yes", locked: false };
        tbody.insertAdjacentHTML("beforeend", this.getStaffRowHTML(newStaff));
        this.addRowListeners();
        this.saveStaffList();
      },

      addRowListeners() {
        const tbody = document.getElementById("staffTable").querySelector("tbody");
        tbody.querySelectorAll('input, select').forEach(el => {
          el.addEventListener('change', () => this.saveStaffList());
        });
        tbody.querySelectorAll('.btn-danger').forEach(btn => {
          btn.addEventListener('click', () => {
            btn.closest('tr').remove();
            this.saveStaffList();
          });
        });
      },

      saveStaffList() {
        const rows = document.getElementById("staffTable").querySelector("tbody").rows;
        const staffList = Array.from(rows).map(row => ({
          staffID: row.cells[0].querySelector("input").value,
          name: row.cells[1].querySelector("input").value,
          breakTime: `${row.cells[2].querySelectorAll("input")[0].value}-${row.cells[2].querySelectorAll("input")[1].value}`,
          hhmdEligible: row.cells[3].querySelector("select").value,
          attendance: row.cells[4].querySelector("select").value,
          locked: row.cells[5].querySelector("input").checked
        }));
        localStorage.setItem(this.constants.STORAGE_KEY, JSON.stringify(staffList));
      },

      generateRoster() {
        const staffList = this.getCurrentStaffList().filter(st => st.attendance === "Yes");
        if (!staffList.length) return alert("Please add staff first");

        const roster = this.constants.PRIORITY.reduce((acc, { location }) => ({
          ...acc,
          [location]: {}
        }), {});

        this.constants.ROSTER_TIMES.forEach(slot => {
          this.constants.PRIORITY.forEach(({ location, needed }) => {
            roster[location][slot] = roster[location][slot] || "";
            const available = staffList.filter(st => !this.isOnBreak(st, slot) && !st.assigned?.includes(slot));
            if (available.length) {
              roster[location][slot] = available.slice(0, needed).map(st => st.staffID).join(", ");
              available.slice(0, needed).forEach(st => {
                st.assigned = st.assigned || [];
                st.assigned.push(slot);
              });
            }
          });
        });

        this.displayRoster(roster);
      },

      getCurrentStaffList() {
        return JSON.parse(localStorage.getItem(this.constants.STORAGE_KEY) || "[]");
      },

      isOnBreak(st, slot) {
        const [start, end] = st.breakTime.split("-").map(t => this.timeToMinutes(t));
        const slotTime = this.timeToMinutes(slot);
        return slotTime >= start && slotTime <= end;
      },

      timeToMinutes(timeStr) {
        const [hours, minutes] = timeStr.split(":").map(Number);
        return (hours < 8 ? hours + 24 : hours) * 60 + minutes;
      },

      displayRoster(roster) {
        const container = document.getElementById("rosterContainer");
        let html = '<table><thead><tr><th>Location</th>';
        this.constants.ROSTER_TIMES.forEach(slot => html += `<th>${slot}</th>`);
        html += '</tr></thead><tbody>';
        
        this.constants.PRIORITY.forEach(({ location }) => {
          html += `<tr><td>${location}</td>`;
          this.constants.ROSTER_TIMES.forEach(slot => {
            html += `<td>${roster[location][slot] || ''}</td>`;
          });
          html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
      },

      downloadAsPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const tableData = this.getTableData();
        doc.text("Staff Roster", 14, 20);
        doc.autoTable({ head: [tableData[0]], body: tableData.slice(1) });
        doc.save(`roster_${new Date().toISOString().split("T")[0]}.pdf`);
      },

      getTableData() {
        const table = document.getElementById("rosterContainer").querySelector("table");
        if (!table) return [];
        return Array.from(table.rows).map(row => 
          Array.from(row.cells).map(cell => cell.textContent)
        );
      },

      makeDraggable(el) {
        let pos = { x: 0, y: 0 };
        el.onmousedown = (e) => {
          pos = { x: e.clientX, y: e.clientY };
          document.onmousemove = (e) => {
            el.style.left = (el.offsetLeft + e.clientX - pos.x) + 'px';
            el.style.top = (el.offsetTop + e.clientY - pos.y) + 'px';
            pos = { x: e.clientX, y: e.clientY };
          };
          document.onmouseup = () => {
            document.onmousemove = document.onmouseup = null;
          };
        };
      }
    };

    document.addEventListener("DOMContentLoaded", () => rosterSystem.init());
  </script>
</body>
</html>