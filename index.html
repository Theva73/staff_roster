<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staff Roster Management System v2.1</title>
  
  <!-- External libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* ... (keep original styles unchanged) ... */
  </style>
</head>

<body>
  <!-- ... (keep original HTML structure unchanged) ... -->

  <script>
    const STORAGE_KEY = 'staffListData';
    const ROSTER_TIMES = [
      "20:00", "20:30", "21:00", "22:00", "23:00",
      "00:00", "01:00", "01:30", "02:00", "03:00",
      "04:00", "05:00", "06:00", "07:00", "07:30"
    ];

    // Updated priority with Tango Papa first
    const PRIORITY = [
      { location: "Tango Papa", needed: 1 },
      { location: "Pass Counter", needed: 2 },
      { location: "HHMD", needed: 1 },
      { location: "Lobby", needed: 2 },
      { location: "Guard House", needed: 1 },
      { location: "Vertical Patrol", needed: 1 },
      { location: "Report Room", needed: 1 }
    ];

    const OUTPUT_ORDER = [
      "Pass Counter", "HHMD", "Lobby", "Guard House",
      "Vertical Patrol", "Report Room", "Tango Papa"
    ];

    const BREAK_TIME_POOL = [
      "20:00-21:30", "21:30-23:30", "22:00-00:00",
      "23:00-01:00", "00:00-02:00", "01:30-03:30",
      "02:00-04:00", "03:00-05:00", "04:00-06:00",
      "05:00-07:00", "06:00-08:00"
    ];

    const CRITICAL_LOCATIONS = {
      "Vertical Patrol": ["20:30", "23:00", "01:30", "06:00"],
      "Report Room": ["20:00", "21:00"],
      "Tango Papa": ["07:30"]
    };

    const rosterSystem = {
      // INITIALIZATION AND CORE FUNCTIONS
      init: function() {
        // ... (original init code with element checks and event listeners)
      },

      // STAFF MANAGEMENT
      getCurrentStaffList: function() {
        const rows = document.getElementById("staffTable").querySelector("tbody").rows;
        return Array.from(rows).map(row => {
          const timeInputs = row.cells[2].querySelectorAll("input[type='time']");
          let start = timeInputs[0].value.padEnd(5, ":00").substring(0,5);
          let end = timeInputs[1].value.padEnd(5, ":00").substring(0,5);
          
          return {
            staffID: row.cells[0].querySelector("input").value.trim(),
            name: row.cells[1].querySelector("input").value.trim(),
            breakTime: `${start}-${end}`.replace(/:+/g, ":"),
            hhmdEligible: row.cells[3].querySelector("select").value,
            attendance: row.cells[4].querySelector("select").value,
            locked: row.cells[5].querySelector("input[type='checkbox']").checked,
            assigned: row.dataset.assigned ? JSON.parse(row.dataset.assigned) : []
          };
        });
      },

      // BREAK TIME VALIDATION
      isOnBreak: function(st, slot) {
        if (!st.breakTime || !st.breakTime.includes("-")) return false;
        
        const [bStart, bEnd] = st.breakTime.split("-").map(t => {
          let [h, m] = t.split(":");
          return `${h.padStart(2,'0')}:${(m || '00').padStart(2,'0')}`;
        });

        const slotTime = this.timeToMinutes(slot);
        const breakStart = this.timeToMinutes(bStart);
        const breakEnd = this.timeToMinutes(bEnd);

        if (breakStart <= breakEnd) {
          return slotTime >= breakStart && slotTime <= breakEnd;
        }
        return slotTime >= breakStart || slotTime <= breakEnd;
      },

      // TIME CONVERSION
      timeToMinutes: function(timeStr) {
        const [hours, minutes] = timeStr.split(":").map(Number);
        const adjustedHours = hours < 20 ? hours + 24 : hours;
        return (adjustedHours - 20) * 60 + (minutes || 0);
      },

      // ROSTER GENERATION IMPROVEMENTS
      assignCriticalLocations: function(roster, staffList, isWeekend, shortfalls) {
        // Force Tango Papa assignment first
        const tangoSlot = "07:30";
        let chosen = this.findAvailableStaff(staffList, tangoSlot, "Tango Papa") || 
                    this.findEmergencyStaff(staffList, tangoSlot);
        
        if (chosen) {
          roster["Tango Papa"][tangoSlot] = chosen.staffID;
          chosen.assigned.push({ slot: tangoSlot, location: "Tango Papa" });
        } else {
          shortfalls.push(`CRITICAL: Could not fill Tango Papa at ${tangoSlot}`);
        }

        // Original critical location logic
        // ... (rest of critical location assignments)
      },

      // ENHANCED VALIDATION
      validateRoster: function(roster, gapThreshold = 120) {
        const staffAssignments = {};
        const issues = [];
        const conflicts = {};

        // Existing validation checks...

        // New: Consecutive assignment prevention
        for (const staffID in staffAssignments) {
          const assignments = staffAssignments[staffID]
            .sort((a, b) => this.timeToMinutes(a.slot) - this.timeToMinutes(b.slot));

          for (let i = 0; i < assignments.length - 1; i++) {
            const current = assignments[i];
            const next = assignments[i + 1];
            
            // Same location consecutive check
            if (current.location === next.location) {
              const timeDiff = this.timeToMinutes(next.slot) - this.timeToMinutes(current.slot);
              if (timeDiff < 60) {
                issues.push(`Staff ${staffID} has consecutive ${current.location} shifts: ${current.slot} â†’ ${next.slot}`);
                this.autoCorrectConsecutive(roster, staffID, current, next);
              }
            }
          }
        }

        return { issues, conflicts };
      },

      // AUTO-CORRECTION MECHANISMS
      autoCorrectConsecutive: function(roster, staffID, current, next) {
        const staff = this.getCurrentStaffList().find(s => s.staffID === staffID);
        if (!staff) return;

        // Remove from the later assignment
        this.removeAssignment(roster, staff, next.slot, next.location);
        
        // Find replacement staff
        const replacement = this.findAvailableStaff(
          this.getCurrentStaffList().filter(s => s.staffID !== staffID),
          next.slot,
          next.location
        );
        
        if (replacement) {
          roster[next.location][next.slot] = replacement.staffID;
          replacement.assigned.push({ slot: next.slot, location: next.location });
        }
      },

      // PDF GENERATION FIXES
      downloadAsPDF: function(rosterData, breakData) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape', 'pt', 'a4');
        
        // Format break times
        const formattedBreaks = breakData.map(row => {
          if (row[2]) {
            row[2] = row[2].replace("-", " to ");
          }
          return row;
        });

        // Roster table
        doc.autoTable({
          head: [rosterData[0]],
          body: rosterData.slice(1),
          // ... (other PDF settings)
        });

        // Break times table
        doc.autoTable({
          head: [formattedBreaks[0]],
          body: formattedBreaks.slice(1),
          // ... (other PDF settings)
        });

        doc.save("Roster_with_Breaks.pdf");
      },

      // ... (remaining original functions with minor adjustments)
    };

    // Initialize the system
    window.RosterApp = rosterSystem;
    document.addEventListener('DOMContentLoaded', () => rosterSystem.init());
  </script>
</body>
</html>