<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Roster System v5.4 - 100% Compliance Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, addDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAP7b4KcwRYPMZjNc2TWsNqMvC3ywImhOM",
            authDomain: "roster-4a997.firebaseapp.com",
            projectId: "roster-4a997",
            storageBucket: "roster-4a997.appspot.com",
            messagingSenderId: "901381868881",
            appId: "1:901381868881:web:92930481d6c1c85fedd770"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.firebase = {
             collection, getDocs, doc, setDoc, addDoc, deleteDoc, onSnapshot, query
        };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn:hover { transform: translateY(-1px); }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 0.5rem; }
        #editableRoster th, #editableRoster td, #staffTable th, #staffTable td { white-space: nowrap; }
        #staffTable td:nth-child(2), #staffTable th:nth-child(2) { white-space: normal; }
        #editableRoster thead th:first-child, #editableRoster tbody td:first-child,
        #staffTable thead th:first-child, #staffTable tbody td:first-child { position: sticky; left: 0; z-index: 10; }
        #editableRoster thead th:first-child, #staffTable thead th:first-child { z-index: 20; background-color: #f3f4f6; }
        .not-applicable { background-color: #e5e7eb; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-indigo-600">Staff Roster System v5.4</h1>
            <p class="text-lg text-gray-500 mt-2">100% Break Time Compliance & Validation</p>
        </header>

        <!-- Controls Card and Staff Management are unchanged -->
        <div class="card p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                <div>
                    <label for="rosterDate" class="font-semibold text-gray-700">Roster Date:</label>
                    <input type="date" id="rosterDate" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="rosterDay" class="font-semibold text-gray-700">Day:</label>
                    <select id="rosterDay" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option>
                    </select>
                </div>
                <div class="text-center md:text-right">
                    <span class="text-lg font-semibold">Working Staff:</span>
                    <span id="staffCount" class="text-2xl font-bold text-indigo-600 ml-2">0</span>
                </div>
            </div>
        </div>

        <div class="card p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Staff Management (Live from Cloud)</h2>
            <div class="overflow-x-auto">
                <table id="staffTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="sticky left-0 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Break Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HHMD Eligible</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Attendance</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lock</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div class="mt-6 flex flex-wrap gap-4 justify-center">
                <button id="addStaffBtn" class="btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-indigo-700">Add Staff</button>
                <button id="shuffleBreaksBtn" class="btn bg-purple-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-purple-700">Shuffle Breaks</button>
            </div>
        </div>


        <!-- Roster Generation Card -->
        <div class="card p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Roster Controls</h2>
            <div class="flex justify-center">
                 <button id="generateRosterBtn" class="btn bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-green-700 text-lg">Generate & Validate Roster</button>
            </div>
            <div id="notification-container" class="mt-4 space-y-2"></div>
            
            <!-- NEW: Compliance Report section -->
            <div id="complianceReport" class="mt-6 hidden"></div>
            
            <div id="rosterContainer" class="mt-2 overflow-x-auto"></div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdfModal" class="modal">
        <div class="modal-content">
             <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">PDF Preview</h3>
                <button id="closePdfBtn" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            </div>
            <iframe id="pdfPreview" class="w-full h-[75vh]"></iframe>
        </div>
    </div>


<script type="module">
// --- V5.4 ---
// REWRITE: `isOnBreak` function rewritten with absolute minutes for 100% accuracy.
// NEW: `validator` object to perform post-generation scrubbing, guaranteeing compliance.
// NEW: `complianceReport` UI to transparently show validation results.

const rosterSystem = {
    // --- CONFIGURATION & STATE (Unchanged) ---
    ROSTER_TIMES: ["20:00", "20:30", "21:00", "22:00", "23:00", "00:00", "01:00", "01:30", "02:00", "03:00", "04:00", "05:00", "06:00", "06:30", "07:00"],
    LOCATIONS: [ { name: "Pass Counter", needed: 2, isMultiStaff: true }, { name: "HHMD", needed: 1 }, { name: "Lobby", needed: 2, isMultiStaff: true }, { name: "Guard House", needed: 1 }, { name: "Vertical Patrol", needed: 1 }, { name: "Report Room", needed: 1 }, { name: "Tango Papa", needed: 1 } ],
    OUTPUT_ORDER: ["Pass Counter", "HHMD", "Guard House", "Lobby", "Report Room", "Vertical Patrol", "Tango Papa"],
    CRITICAL_DUTIES: { "Vertical Patrol": ["20:30", "23:00", "01:30", "04:00", "06:30"], "Report Room": ["20:00", "21:00"], "Tango Papa": ["07:00"] },
    generatedRoster: null, staffDataCache: [], db: null, firebase: null,

    // --- INITIALIZATION ---
    async init() {
        await new Promise(resolve => {
            const interval = setInterval(() => {
                if (window.db && window.firebase) {
                    clearInterval(interval);
                    this.db = window.db; this.firebase = window.firebase;
                    console.log("Roster System v5.4 Initialized with Firebase");
                    resolve();
                }
            }, 50);
        });
        this.setupEventListeners(); this.initializeDate(); this.listenForStaffUpdates();
    },

    initializeDate() { /* Unchanged */
        const today = new Date(); document.getElementById('rosterDate').value = today.toISOString().split('T')[0];
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        document.getElementById('rosterDay').value = days[today.getDay()];
    },

    setupEventListeners() { /* Unchanged */
        document.getElementById('addStaffBtn').addEventListener('click', () => this.addStaffToFirestore());
        document.getElementById('generateRosterBtn').addEventListener('click', () => this.runRosterGeneration());
        document.getElementById('shuffleBreaksBtn').addEventListener('click', () => this.shuffleBreaks());
        document.getElementById('closePdfBtn').addEventListener('click', () => document.getElementById('pdfModal').style.display = 'none');
    },

    // --- FIREBASE & STAFF DATA MANAGEMENT (Unchanged) ---
    listenForStaffUpdates() { const { collection, query, onSnapshot } = this.firebase; const q = query(collection(this.db, "staff")); onSnapshot(q, (querySnapshot) => { const staffList = []; querySnapshot.forEach((doc) => { staffList.push({ docId: doc.id, ...doc.data() }); }); this.staffDataCache = staffList.sort((a,b) => (a.id || "").localeCompare(b.id || "")); this.renderStaffTable(this.staffDataCache); this.updateStaffCount(); }); },
    renderStaffTable(staffList) { const tbody = document.getElementById('staffTable').querySelector('tbody'); tbody.innerHTML = ''; staffList.forEach(staff => { const row = tbody.insertRow(); row.dataset.docId = staff.docId; row.innerHTML = ` <td class="sticky left-0 bg-white px-6 py-4"><input data-field="id" class="w-24 p-1 border rounded" type="text" value="${staff.id || ''}"></td> <td class="px-6 py-4"><input data-field="name" class="w-36 p-1 border rounded" type="text" value="${staff.name || ''}"></td> <td class="px-6 py-4"> <div class="flex items-center gap-1"> <input type="time" data-field="breakStart" value="${staff.breakStart || '22:00'}" step="1800" class="p-1 border rounded"> <span>-</span> <input type="time" data-field="breakEnd" value="${staff.breakEnd || '00:00'}" step="1800" class="p-1 border rounded"> </div> </td> <td class="px-6 py-4"><select data-field="hhmd" class="p-1 border rounded"><option value="Yes" ${staff.hhmd === 'Yes' ? 'selected' : ''}>Yes</option><option value="No" ${staff.hhmd !== 'Yes' ? 'selected' : ''}>No</option></select></td> <td class="px-6 py-4"><select data-field="attendance" class="p-1 border rounded"><option value="Yes" ${staff.attendance !== 'No' ? 'selected' : ''}>Yes</option><option value="No" ${staff.attendance === 'No' ? 'selected' : ''}>No</option></select></td> <td class="px-6 py-4"><input type="checkbox" data-field="locked" ${staff.locked ? 'checked' : ''} class="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500"></td> <td class="px-6 py-4"><button class="remove-btn text-red-600 hover:text-red-800 font-semibold">Remove</button></td> `; row.querySelectorAll('input, select').forEach(el => el.addEventListener('change', (e) => this.updateStaffInFirestore(e))); row.querySelector('.remove-btn').addEventListener('click', (e) => this.deleteStaffFromFirestore(e)); }); },
    async addStaffToFirestore() { const { collection, addDoc } = this.firebase; try { const newStaff = { id: `S${Date.now().toString().slice(-4)}`, name: 'New Staff', breakStart: '22:00', breakEnd: '00:00', hhmd: 'No', attendance: 'Yes', locked: false, createdAt: new Date() }; await addDoc(collection(this.db, "staff"), newStaff); this.showNotification(`Added new staff member.`, 'success'); } catch (e) { this.showNotification('Error adding staff member.', 'error'); } },
    async updateStaffInFirestore(event) { const { doc, setDoc } = this.firebase; const row = event.target.closest('tr'); const docId = row.dataset.docId; const dataToSave = { id: row.querySelector('[data-field="id"]').value, name: row.querySelector('[data-field="name"]').value, breakStart: row.querySelector('[data-field="breakStart"]').value, breakEnd: row.querySelector('[data-field="breakEnd"]').value, hhmd: row.querySelector('[data-field="hhmd"]').value, attendance: row.querySelector('[data-field="attendance"]').value, locked: row.querySelector('[data-field="locked"]').checked }; try { await setDoc(doc(this.db, "staff", docId), dataToSave, { merge: true }); } catch (e) { this.showNotification('Error updating staff member.', 'error'); } },
    async deleteStaffFromFirestore(event) { const { doc, deleteDoc } = this.firebase; const row = event.target.closest('tr'); const docId = row.dataset.docId; if (confirm(`Are you sure you want to remove staff member ${row.querySelector('[data-field=id]').value}?`)) { try { await deleteDoc(doc(this.db, "staff", docId)); this.showNotification('Staff member removed.', 'success'); } catch (e) { this.showNotification('Error removing staff member.', 'error'); } } },
    async saveRosterToFirestore(rosterData) { const { doc, setDoc } = this.firebase; const rosterDate = document.getElementById('rosterDate').value; if (!rosterDate) { this.showNotification('Please select a valid date before saving.', 'error'); return; } const rosterDoc = { date: rosterDate, day: document.getElementById('rosterDay').value, roster: rosterData, createdAt: new Date() }; try { await setDoc(doc(this.db, "rosters", rosterDate), rosterDoc); this.showNotification(`Roster for ${rosterDate} saved to cloud successfully!`, 'success'); } catch (e) { this.showNotification('Could not save roster to the cloud.', 'error'); } },
    updateStaffCount() { const workingStaff = this.staffDataCache.filter(s => s.attendance === 'Yes').length; document.getElementById('staffCount').textContent = workingStaff; },
    async shuffleBreaks() { const presentStaff = this.staffDataCache.filter(s => s.attendance === 'Yes' && !s.locked); if (presentStaff.length < 2) { this.showNotification('Not enough unlocked, present staff to shuffle breaks.', 'warning'); return; } let breaks = presentStaff.map(s => ({ start: s.breakStart, end: s.breakEnd })); for (let i = breaks.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[breaks[i], breaks[j]] = [breaks[j], breaks[i]]; } const { doc, setDoc } = this.firebase; let breakIndex = 0; const promises = []; presentStaff.forEach(staff => { const newBreaks = { breakStart: breaks[breakIndex].start, breakEnd: breaks[breakIndex].end }; promises.push(setDoc(doc(this.db, "staff", staff.docId), newBreaks, { merge: true })); breakIndex++; }); try { await Promise.all(promises); this.showNotification('Break times have been shuffled in the cloud.', 'success'); } catch(e) { this.showNotification('An error occurred while shuffling breaks.', 'error'); } },
    
    // --- CORE ROSTER GENERATION ---
    
    /**
     * REWRITTEN: Converts HH:mm to absolute minutes from midnight for robust comparisons.
     */
    timeToAbsMinutes(timeStr) {
        if (!timeStr || !timeStr.includes(':')) return -1;
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
    },

    /**
     * REWRITTEN: The new, 100% compliant break check logic.
     */
    isOnBreak(staff, timeSlot) {
        const slotMins = this.timeToAbsMinutes(timeSlot);
        const startMins = this.timeToAbsMinutes(staff.breakStart);
        const endMins = this.timeToAbsMinutes(staff.breakEnd);

        if (startMins === -1 || endMins === -1) return false; // Invalid break time format

        // Case 1: Same-day break (e.g., 09:00 - 17:00)
        if (startMins <= endMins) {
            return slotMins >= startMins && slotMins < endMins;
        } 
        // Case 2: Overnight break (e.g., 22:00 - 06:00)
        else {
            return slotMins >= startMins || slotMins < endMins;
        }
    },

    /**
     * NEW: A dedicated validator object to guarantee compliance.
     */
    validator: {
        scrubRosterForBreakViolations(roster, staffList, system) {
            const violations = [];
            let totalAssignments = 0;

            const staffMap = new Map(staffList.map(s => [s.id, s]));

            for (const locName in roster) {
                for (const timeSlot in roster[locName]) {
                    const assignedIds = [...roster[locName][timeSlot]]; // Clone array
                    totalAssignments += assignedIds.length;
                    
                    for (const staffId of assignedIds) {
                        const staffMember = staffMap.get(staffId);
                        if (staffMember && system.isOnBreak(staffMember, timeSlot)) {
                            // VIOLATION FOUND!
                            violations.push({ staffId, locName, timeSlot, breakTime: `${staffMember.breakStart}-${staffMember.breakEnd}` });
                            
                            // Remove the invalid assignment from the actual roster object
                            const index = roster[locName][timeSlot].indexOf(staffId);
                            if (index > -1) {
                                roster[locName][timeSlot].splice(index, 1);
                            }
                        }
                    }
                }
            }
            return { violations, totalAssignments, scrubbedRoster: roster };
        }
    },

    runRosterGeneration() {
        this.clearNotifications();
        const staff = this.staffDataCache.filter(s => s.attendance === 'Yes');
        if (staff.length === 0) { this.showNotification("Cannot generate roster. No staff marked as present.", 'error'); return; }
        
        let roster = this.initializeRoster();
        const staffAvailability = this.initializeStaffAvailability(staff);
        let shortfalls = [];
        const isWeekend = ['Saturday', 'Sunday'].includes(document.getElementById('rosterDay').value);
        
        // --- Generation ---
        this.assignCriticalDuties(roster, staffAvailability, isWeekend, shortfalls);
        this.assignStandardDuties(roster, staffAvailability, isWeekend, shortfalls);
        
        // --- NEW: Validation Step ---
        const validationResult = this.validator.scrubRosterForBreakViolations(roster, staff, this);
        this.generatedRoster = validationResult.scrubbedRoster;

        // --- Display & Save ---
        this.displayComplianceReport(validationResult);
        this.displayRoster(this.generatedRoster);
        
        if (shortfalls.length > 0) shortfalls.forEach(msg => this.showNotification(msg, 'warning'));
        
        this.saveRosterToFirestore(this.generatedRoster);
        this.addRosterActionButtons();
    },

    initializeRoster: function() { const r={};this.LOCATIONS.forEach(l=>{r[l.name]={};this.ROSTER_TIMES.forEach(t=>r[l.name][t]=[])});return r; },
    initializeStaffAvailability: function(staffList) { const a={};staffList.forEach(s=>{a[s.id]={data:s,assignedSlots:[]}});return a; },
    findAvailableStaff: function(staffAvailability, timeSlot, locationName) { const s=Object.values(staffAvailability).sort((a,b)=>a.assignedSlots.length-b.assignedSlots.length);for(const t of s){const a=t.assignedSlots.includes(timeSlot),e="HHMD"!==locationName||"Yes"===t.data.hhmd;if(!this.isOnBreak(t.data,timeSlot)&&!a&&e)return t}return null },
    assignStaff: function(roster, staff, timeSlot, locationName) { roster[locationName][timeSlot].push(staff.data.id); staff.assignedSlots.push(timeSlot); },
    assignCriticalDuties(roster, staffAvailability, isWeekend, shortfalls) { for(const l in this.CRITICAL_DUTIES){if(isWeekend&&"Report Room"===l)continue;this.CRITICAL_DUTIES[l].forEach(t=>{const s=this.findAvailableStaff(staffAvailability,t,l);s?this.assignStaff(roster,s,t,l):shortfalls.push(`CRITICAL SHORTFALL: No staff for ${l} at ${t}.`)})} },
    assignStandardDuties(roster, staffAvailability, isWeekend, shortfalls) { const t=this.OUTPUT_ORDER.filter(l=>!this.CRITICAL_DUTIES.hasOwnProperty(l));t.forEach(l=>{const o=this.LOCATIONS.find(s=>s.name===l);this.ROSTER_TIMES.forEach(s=>{const e=o.needed;for(let a=roster[l][s].length;a<e;a++){const d=this.findAvailableStaff(staffAvailability,s,l);if(d)this.assignStaff(roster,d,s,l);else{shortfalls.push(`Shortfall: ${l} at ${s}.`);break}}})}) },
    
    // --- DISPLAY & EXPORT ---
    
    /**
     * NEW: Renders the compliance report UI.
     */
    displayComplianceReport(report) {
        const container = document.getElementById('complianceReport');
        const compliance = report.totalAssignments === 0 ? 100 : ((report.totalAssignments - report.violations.length) / report.totalAssignments) * 100;

        let violationsHTML = '';
        if (report.violations.length > 0) {
            violationsHTML = `<p class="text-xs text-red-600 mt-2">Validator removed ${report.violations.length} assignments that violated break times.</p>`;
        }

        container.innerHTML = `
            <div class="p-4 bg-gray-100 rounded-lg">
                <h3 class="font-bold text-lg text-gray-800">Break Time Compliance Report</h3>
                <div class="flex justify-around items-center mt-2 text-center">
                    <div>
                        <p class="text-2xl font-bold text-gray-700">${report.totalAssignments}</p>
                        <p class="text-sm text-gray-500">Total Assignments</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-green-600">${compliance.toFixed(1)}%</p>
                        <p class="text-sm text-gray-500">Compliance</p>
                    </div>
                </div>
                ${violationsHTML}
            </div>
        `;
        container.classList.remove('hidden');
    },

    displayRoster(roster) { /* Unchanged from 5.2 */
        const container = document.getElementById('rosterContainer');
        let tableHTML = `<table id="editableRoster" class="min-w-full divide-y divide-gray-200 mt-4"><thead class="bg-gray-100"><tr><th class="sticky left-0 bg-gray-100 px-4 py-2 text-left text-sm font-semibold text-gray-700">Location</th>`;
        this.ROSTER_TIMES.forEach(time => tableHTML += `<th class="px-4 py-2 text-center text-sm font-semibold text-gray-700">${time}</th>`);
        tableHTML += `</tr></thead><tbody class="bg-white">`;
        const isWeekend = ['Saturday', 'Sunday'].includes(document.getElementById('rosterDay').value);
        this.OUTPUT_ORDER.forEach(locName => {
            const location = this.LOCATIONS.find(l => l.name === locName);
            tableHTML += `<tr class="border-b"><td class="sticky left-0 bg-white px-4 py-2 font-medium text-gray-900">${locName}</td>`;
            this.ROSTER_TIMES.forEach(timeSlot => {
                const assignedStaff = roster[locName][timeSlot]; let cellText = assignedStaff.join(location.isMultiStaff ? ' | ' : ', '); let cellClass = '';
                const isCriticalLocation = this.CRITICAL_DUTIES.hasOwnProperty(locName); const isDesignatedTime = isCriticalLocation && this.CRITICAL_DUTIES[locName].includes(timeSlot);
                if (isCriticalLocation) { if (isDesignatedTime) { cellClass = assignedStaff.length < location.needed ? 'bg-red-100' : 'bg-blue-100 font-bold'; } else { cellClass = 'not-applicable'; cellText = ''; } }
                else { cellClass = assignedStaff.length < location.needed ? 'bg-red-100' : 'bg-white'; }
                if (locName === 'Report Room' && isWeekend) { cellClass = 'not-applicable'; cellText = ''; }
                tableHTML += `<td class="text-center px-4 py-2 ${cellClass}">${cellText}</td>`;
            });
            tableHTML += `</tr>`;
        });
        tableHTML += `</tbody></table>`; container.innerHTML = tableHTML;
    },
    addRosterActionButtons() { /* Unchanged */
        if (document.getElementById('rosterActions')) document.getElementById('rosterActions').remove();
        let container = document.getElementById('rosterContainer');
        let buttonsHTML = `<div id="rosterActions" class="mt-6 flex flex-wrap gap-4 justify-center"><button id="copyTSVBtn" class="btn bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-blue-700">Copy for Excel</button><button id="downloadPDFBtn" class="btn bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-red-700">Download PDF</button></div>`;
        container.insertAdjacentHTML('beforeend', buttonsHTML);
        document.getElementById('copyTSVBtn').addEventListener('click', () => this.copyTSV());
        document.getElementById('downloadPDFBtn').addEventListener('click', () => this.downloadPDF());
    },
    copyTSV() { /* Unchanged */
        if (!this.generatedRoster) { this.showNotification('No roster to copy.', 'error'); return; }
        let tsv = 'Location\t' + this.ROSTER_TIMES.join('\t') + '\n';
        this.OUTPUT_ORDER.forEach(locName => {
            const location = this.LOCATIONS.find(l => l.name === locName);
            tsv += locName + '\t' + this.ROSTER_TIMES.map(time => this.generatedRoster[locName][time].join(location.isMultiStaff ? ' | ' : ', ')).join('\t') + '\n';
        });
        navigator.clipboard.writeText(tsv).then(() => this.showNotification('Roster copied to clipboard!', 'success'), () => this.showNotification('Failed to copy.', 'error'));
    },
    downloadPDF() { /* Unchanged from 5.3 */
        if (!this.generatedRoster) { this.showNotification('No roster to download.', 'error'); return; }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
        const rosterDate = document.getElementById('rosterDate').value; const rosterDay = document.getElementById('rosterDay').value;
        doc.setFontSize(16); doc.text(`Staff Roster - ${rosterDate} (${rosterDay})`, 14, 15);
        const rosterHead = [['Location', ...this.ROSTER_TIMES]];
        const rosterBody = this.OUTPUT_ORDER.map(locName => { const location = this.LOCATIONS.find(l => l.name === locName); return [locName, ...this.ROSTER_TIMES.map(time => this.generatedRoster[locName][time].join(location.isMultiStaff ? ' | ' : ', '))]; });
        doc.autoTable({ head: rosterHead, body: rosterBody, startY: 22, theme: 'grid', styles: { fontSize: 6, cellPadding: 1 }, headStyles: { fillColor: [45, 55, 72], textColor: 255, fontSize: 7 }, columnStyles: { 0: { fontStyle: 'bold', cellWidth: 22 } } });
        const presentStaff = this.staffDataCache.filter(s => s.attendance === 'Yes');
        const staffHead = [['Staff ID', 'Name', 'Break Time']];
        const staffBody = presentStaff.map(staff => [ staff.id, staff.name, `${staff.breakStart} - ${staff.breakEnd}` ]);
        doc.autoTable({ head: staffHead, body: staffBody, startY: doc.autoTable.previous.finalY + 8, theme: 'striped', styles: { fontSize: 8, cellPadding: 1.5 }, headStyles: { fillColor: [124, 58, 237], textColor: 255 }, columnStyles: { 1: { cellWidth: 40 } }, margin: { left: 14 } });
        document.getElementById('pdfPreview').src = doc.output('bloburl'); document.getElementById('pdfModal').style.display = 'block';
        doc.save(`roster_${rosterDate}.pdf`);
    },
    clearNotifications() { document.getElementById('notification-container').innerHTML = ''; },
    showNotification(message, type = 'info') { /* Unchanged */
        const container = document.getElementById('notification-container');
        const colors = { success: 'green', error: 'red', warning: 'yellow', info: 'blue' };
        const notification = document.createElement('div');
        notification.className = `border-l-4 p-4 bg-${colors[type]}-100 border-${colors[type]}-500 text-${colors[type]}-700`;
        notification.innerHTML = `<p class="font-bold">${type.charAt(0).toUpperCase() + type.slice(1)}</p><p>${message}</p>`;
        container.appendChild(notification);
        setTimeout(() => { notification.style.transition = 'opacity 0.5s ease'; notification.style.opacity = '0'; setTimeout(() => notification.remove(), 500); }, 5000);
    },
};

rosterSystem.init();

</script>
</body>
</html>