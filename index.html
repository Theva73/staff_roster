<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staff Roster Management System</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* ... (keep original styles unchanged) ... */
  </style>
</head>

<body>
  <!-- ... (keep original HTML structure unchanged) ... -->

  <script>
    const STORAGE_KEY = 'staffListData';
    const ROSTER_TIMES = [
      "20:00", "20:30", "21:00", "22:00", "23:00",
      "00:00", "01:00", "01:30", "02:00", "03:00",
      "04:00", "05:00", "06:00", "07:00", "07:30"
    ];
    
    // Updated priority order with Tango Papa first
    const PRIORITY = [
      { location: "Tango Papa", needed: 1 },
      { location: "Pass Counter", needed: 2 },
      { location: "HHMD", needed: 1 },
      { location: "Lobby", needed: 2 },
      { location: "Guard House", needed: 1 },
      { location: "Vertical Patrol", needed: 1 },
      { location: "Report Room", needed: 1 }
    ];

    const OUTPUT_ORDER = [
      "Pass Counter", "HHMD", "Lobby", "Guard House",
      "Vertical Patrol", "Report Room", "Tango Papa"
    ];

    const BREAK_TIME_POOL = [
      "20:00-21:30", "21:30-23:30", "22:00-00:00",
      "23:00-01:00", "00:00-02:00", "01:30-03:30",
      "02:00-04:00", "03:00-05:00", "04:00-06:00",
      "05:00-07:00", "06:00-08:00"
    ];

    const CRITICAL_LOCATIONS = {
      "Vertical Patrol": ["20:30", "23:00", "01:30", "06:00"],
      "Report Room": ["20:00", "21:00"],
      "Tango Papa": ["07:30"]
    };

    const rosterSystem = {
      // ... (previous init and helper functions remain same) ...

      getCurrentStaffList: function() {
        const rows = document.getElementById("staffTable").querySelector("tbody").rows;
        const staffList = [];
        for (let row of rows) {
          const startInput = row.cells[2].querySelectorAll("input[type='time']")[0].value || "00:00";
          const endInput = row.cells[2].querySelectorAll("input[type='time']")[1].value || "00:00";
          const staffData = {
            staffID: row.cells[0].querySelector("input").value.trim(),
            name: row.cells[1].querySelector("input").value.trim(),
            breakTime: `${startInput}-${endInput}`,
            hhmdEligible: row.cells[3].querySelector("select").value,
            attendance: row.cells[4].querySelector("select").value,
            locked: row.cells[5].querySelector("input[type='checkbox']").checked,
            assigned: row.dataset.assigned ? JSON.parse(row.dataset.assigned) : []
          };
          staffList.push(staffData);
        }
        return staffList;
      },

      isOnBreak: function(st, slot) {
        if (!st.breakTime || !st.breakTime.includes("-")) return false;
        
        // Normalize break time format
        const [bStart, bEnd] = st.breakTime.split("-").map(t => {
          const [h, m] = t.split(":");
          return `${h.padStart(2,'0')}:${(m || '00').padStart(2,'0')}`;
        });

        const slotTime = this.timeToMinutes(slot);
        const breakStart = this.timeToMinutes(bStart);
        const breakEnd = this.timeToMinutes(bEnd);

        if (breakStart <= breakEnd) {
          return slotTime >= breakStart && slotTime <= breakEnd;
        } else {
          return slotTime >= breakStart || slotTime <= breakEnd;
        }
      },

      timeToMinutes: function(timeStr) {
        const [hours, minutes] = timeStr.split(":").map(Number);
        const adjustedHours = hours < 20 ? hours + 24 : hours;
        return (adjustedHours - 20) * 60 + (minutes || 0);
      },

      assignCriticalLocations: function(roster, staffList, isWeekend, shortfalls) {
        // Force Tango Papa assignment first
        const tangoSlot = "07:30";
        let chosen = this.findAvailableStaff(staffList, tangoSlot, "Tango Papa");
        if (!chosen) {
          chosen = this.findEmergencyStaff(staffList, tangoSlot);
          if (chosen) {
            shortfalls.push(`Emergency assignment: ${chosen.staffID} to Tango Papa at ${tangoSlot}`);
          }
        }
        
        if (chosen) {
          roster["Tango Papa"][tangoSlot] = chosen.staffID;
          chosen.assigned.push({ slot: tangoSlot, location: "Tango Papa" });
        } else {
          shortfalls.push(`CRITICAL: Could not fill mandatory Tango Papa at ${tangoSlot}`);
        }

        // Original logic for other locations
        for (const loc in CRITICAL_LOCATIONS) {
          if (loc === "Report Room" && isWeekend) continue;
          for (const slot of CRITICAL_LOCATIONS[loc]) {
            if (!roster[loc][slot]) roster[loc][slot] = "";
            if (!this.locationApplies(loc, slot, isWeekend)) continue;
            
            let chosen = this.findAvailableStaff(staffList, slot, loc);
            if (chosen) {
              roster[loc][slot] += roster[loc][slot] ? `, ${chosen.staffID}` : chosen.staffID;
              chosen.assigned.push({ slot, location: loc });
            } else {
              chosen = this.findEmergencyStaff(staffList, slot);
              if (chosen) {
                roster[loc][slot] += roster[loc][slot] ? `, ${chosen.staffID}` : chosen.staffID;
                chosen.assigned.push({ slot, location: loc });
                shortfalls.push(`Emergency assignment: ${chosen.staffID} to ${loc} at ${slot}`);
              } else {
                shortfalls.push(`CRITICAL: Could not fill mandatory ${loc} at ${slot}`);
              }
            }
          }
        }
      },

      validateRoster: function(roster, gapThreshold = 120) {
        // ... (original validation logic with enhanced gap checking) ...
        
        // New gap calculation based on corrected timeToMinutes
        for (const staffID in staffAssignments) {
          const assignments = staffAssignments[staffID].sort((a, b) => 
            this.timeToMinutes(a.slot) - this.timeToMinutes(b.slot)
          );
          
          for (let i = 0; i < assignments.length - 1; i++) {
            const currTime = this.timeToMinutes(assignments[i].slot);
            const nextTime = this.timeToMinutes(assignments[i+1].slot);
            
            if (Math.abs(nextTime - currTime) < gapThreshold) {
              // Flag violation
            }
          }
        }
        return { issues, conflicts };
      },

      // ... (rest of the original functions with minor adjustments) ...
    };

    // Initialize the system
    window.RosterApp = rosterSystem;
    document.addEventListener('DOMContentLoaded', () => rosterSystem.init());
  </script>
</body>
</html>