<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Roster System v9.2 (Standalone)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

```
<style>
    body { 
        font-family: 'Inter', sans-serif;
        background-color: #f8fafc;
    }
    .card { 
        background-color: white;
        border-radius: 0.75rem; 
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        border: 1px solid #e2e8f0;
    }
    .btn:hover { 
        transform: translateY(-2px);
        box-shadow: 0 7px 14px rgba(50,50,93,.1), 0 3px 6px rgba(0,0,0,.08);
    }
    .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .modal-content { background-color: #fefefe; margin: 5% auto; padding: 24px; border: 1px solid #e5e7eb; width: 90%; max-width: 1000px; border-radius: 0.5rem; }
    
    .table-container {
         overflow-x: auto;
         -webkit-overflow-scrolling: touch;
    }
    .styled-table {
        border-collapse: separate;
        border-spacing: 0;
        min-width: 100%;
    }
    .styled-table thead th {
         background-color: #f1f5f9;
         font-weight: 600;
         color: #334155;
         font-size: 0.8rem;
    }
    .styled-table th, .styled-table td {
        white-space: nowrap;
        padding: 0;
        border-bottom: 1px solid #e2e8f0;
        vertical-align: middle;
        text-align: center;
    }
    .styled-table thead th:first-child, .styled-table tbody td:first-child {
        position: sticky;
        left: 0;
        z-index: 10;
        text-align: left;
    }
    .styled-table tbody td:first-child {
        background-color: #f8fafc;
        font-weight: 500;
        border-right: 1px solid #e2e8f0;
    }
    .styled-table tbody tr:last-child td {
        border-bottom: none;
    }
    .styled-table tbody tr:hover td, .styled-table tbody tr:hover td:first-child {
         background-color: #f0f9ff;
    }
    
    .location-cell-content { padding: 10px 12px; }
    
    .roster-cell-wrapper {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 6px;
        padding: 6px 4px;
        min-height: 50px;
    }

    .roster-input { 
        background-color: transparent;
        border: none;
        width: 100%;
        min-width: 60px;
        height: 24px;
        text-align: center;
        font-size: 0.8rem;
        font-weight: 500;
        color: #1e293b;
        padding: 0 4px;
    }
    .roster-input::placeholder { color: #94a3b8; }
    .roster-input:focus {
        outline: 2px solid #3b82f6;
        border-radius: 4px;
        background-color: #eff6ff;
    }
    
    .not-applicable { background-color: #f1f5f9; }
    .empty-assignable-cell { 
        background-image: repeating-linear-gradient(-45deg, #fdfdff, #fdfdff 5px, #f1f5f9 5px, #f1f5f9 10px);
    }
    .conflict-cell { 
        background-color: #fef2f2 !important;
        box-shadow: inset 0 0 0 2px #ef4444; 
    }

    .padlock {
        font-size: 16px;
        cursor: pointer;
        margin-left: 4px;
        vertical-align: middle;
        user-select: none;
    }
    .locked {
        color: #dc2626;
    }
    .unlocked {
        color: #16a34a;
    }
</style>
```

</head>
<body class="bg-slate-100 text-slate-800">

```
<div class="container mx-auto p-2 sm:p-4 md:p-6 lg:p-8">
    <datalist id="staff-id-list"></datalist>

    <header class="text-center my-8">
        <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-500">Staff Roster System</h1>
        <p class="text-lg text-slate-500 mt-2">v9.2 (Standalone)</p>
    </header>

    <div class="card p-4 md:p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 items-center">
            <div><label for="rosterDate" class="font-semibold text-slate-700 text-sm">Roster Date:</label><input type="date" id="rosterDate" class="mt-1 w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
            <div><label for="rosterDay" class="font-semibold text-slate-700 text-sm">Day:</label><select id="rosterDay" class="mt-1 w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option></select></div>
            <div class="text-center md:text-right"><span class="text-base font-semibold">Working Staff:</span><span id="staffCount" class="text-2xl font-bold text-indigo-600 ml-2">0</span></div>
        </div>
    </div>
    <div class="card p-4 md:p-6 mb-8">
        <h2 class="text-xl md:text-2xl font-bold text-slate-800 mb-4 border-b border-slate-200 pb-3">Staff Management</h2>
        <div class="table-container">
            <table id="staffTable" class="styled-table"><thead><tr><th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ID</th><th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th><th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Break</th><th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">HHMD</th><th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Present</th><th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Lock</th><th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th></tr></thead><tbody class="bg-white"></tbody></table>
        </div>
        <div class="mt-6 flex flex-wrap gap-4 justify-center"><button id="addStaffBtn" class="btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-indigo-700">Add New Staff</button><button id="shuffleBreaksBtn" class="btn bg-purple-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-purple-700">Shuffle Breaks</button></div>
    </div>
    <div class="card p-6">
        <div class="flex flex-col items-center">
             <h2 class="text-2xl font-bold text-slate-800 mb-4">Generate Roster</h2>
             <button id="generateRosterBtn" class="btn bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-green-700 text-lg">Generate</button>
        </div>

        <div id="notification-container" class="mt-4 space-y-2"></div>
        <div id="rosterContainerWrapper" class="mt-4 opacity-0 transition-opacity duration-500">
            <div id="rosterContainer" class="table-container rounded-lg border border-slate-200 shadow-sm"></div>
        </div>
    </div>
</div>
<div id="pdfModal" class="modal"><div class="modal-content"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">PDF Preview</h3><div><a id="pdfDownloadLink" href="#" download="roster.pdf" class="btn bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-blue-700 mr-4">Download Now</a><button id="closePdfBtn" class="text-slate-500 hover:text-slate-800 text-3xl font-bold">&times;</button></div></div><iframe id="pdfPreview" class="w-full h-[75vh] border border-slate-300 rounded"></iframe></div></div>
```

<script>
// Lock management
const lockedCells = JSON.parse(localStorage.getItem("lockedCells") || "{}");

function toggleLock(cellKey, iconEl) {
    const isLocked = !!lockedCells[cellKey];
    if (isLocked) {
        delete lockedCells[cellKey];
    } else {
        lockedCells[cellKey] = true;
    }
    localStorage.setItem("lockedCells", JSON.stringify(lockedCells));
    updatePadlockIcon(iconEl, !isLocked);
}

function updatePadlockIcon(iconEl, locked) {
    iconEl.textContent = locked ? "ðŸ”’" : "ðŸ”“";
    iconEl.className = "padlock " + (locked ? "locked" : "unlocked");
}

function applyPadlocks() {
    const padlockSlots = ["20:00", "23:00", "01:00", "04:00", "06:00"];
    
    // Find all Vertical Patrol cells
    document.querySelectorAll("td[data-location='Vertical Patrol']").forEach(td => {
        const time = td.getAttribute("data-time");
        if (!padlockSlots.includes(time)) return;
        
        const key = `Vertical Patrol-${time}`;
        
        // Remove existing padlock if any
        const existingPadlock = td.querySelector('.padlock');
        if (existingPadlock) {
            existingPadlock.remove();
        }
        
        // Create new padlock
        const icon = document.createElement("span");
        icon.className = "padlock";
        icon.onclick = () => toggleLock(key, icon);
        
        // Add padlock to the cell wrapper
        const wrapper = td.querySelector('.roster-cell-wrapper');
        if (wrapper) {
            wrapper.appendChild(icon);
        } else {
            td.appendChild(icon);
        }
        
        updatePadlockIcon(icon, !!lockedCells[key]);
    });
}

// Main application object definition.
const rosterSystem = {
    // --- CONFIG & STATE ---
    ROSTER_TIMES: ["20:00", "21:00", "22:00", "23:00", "00:00", "01:00", "02:00", "03:00", "04:00", "05:00", "06:00", "07:00"],
    LOCATIONS: [ 
        { name: "Pass Counter", needed: 2, isMultiStaff: true }, 
        { name: "HHMD", needed: 1 }, 
        { name: "Lobby", needed: 2, isMultiStaff: true }, 
        { name: "Guard House", needed: 1 }, 
        { name: "Vertical Patrol", needed: 1 }, 
        { name: "Report Room", needed: 1 }, 
        { name: "Tango Papa", needed: 1 } 
    ],
    OUTPUT_ORDER: ["Pass Counter", "HHMD", "Guard House", "Lobby", "Report Room", "Vertical Patrol", "Tango Papa"],
    CRITICAL_DUTIES: { 
        "Vertical Patrol": ["20:00", "23:00", "01:00", "04:00", "06:00"], 
        "Report Room": ["20:00", "21:00"], 
        "Tango Papa": ["07:00"] 
    },
    
    generatedRoster: null, 
    staffDataCache: [],
    
    // --- INITIALIZATION ---
    init() {
        console.log("Roster System v9.2 Initialized");
        this.setupEventListeners(); 
        this.initializeDate(); 
        this.loadSampleStaff();
    },
    
    loadSampleStaff() {
        // Sample staff data for demonstration
        this.staffDataCache = [
            { id: "4270", name: "John Doe", breakStart: "22:00", breakEnd: "00:00", hhmd: "Yes", attendance: "Yes", locked: false },
            { id: "8421", name: "Jane Smith", breakStart: "23:00", breakEnd: "01:00", hhmd: "No", attendance: "Yes", locked: false },
            { id: "6347", name: "Mike Johnson", breakStart: "00:00", breakEnd: "02:00", hhmd: "Yes", attendance: "Yes", locked: false },
            { id: "8244", name: "Sarah Wilson", breakStart: "01:00", breakEnd: "03:00", hhmd: "No", attendance: "Yes", locked: false },
            { id: "8494", name: "David Brown", breakStart: "02:00", breakEnd: "04:00", hhmd: "Yes", attendance: "Yes", locked: false },
            { id: "6399", name: "Lisa Davis", breakStart: "03:00", breakEnd: "05:00", hhmd: "No", attendance: "Yes", locked: false }
        ];
        this.renderStaffTable(this.staffDataCache);
        this.updateStaffCount();
        this.updateStaffDatalist();
    },

    updateStaffCount() {
        document.getElementById("staffCount").textContent = this.staffDataCache.filter(s => s.attendance === 'Yes').length;
    },

    updateStaffDatalist() {
        const datalist = document.getElementById('staff-id-list');
        if (!datalist) return;
        const presentStaff = this.staffDataCache.filter(s => s.attendance === 'Yes');
        datalist.innerHTML = presentStaff.map(s => `<option value="${s.id}"></option>`).join('');
    },
    
    // --- MAIN SCHEDULING LOGIC ---
    runRosterGeneration: function() {
        this.clearNotifications();
        document.getElementById('rosterContainerWrapper').classList.add('opacity-0');
        
        const presentStaff = this.staffDataCache.filter(s => s.attendance === 'Yes');
        if (presentStaff.length === 0) return this.showNotification("No staff marked as present. Cannot generate roster.", 'error');

        // Store locked values before regenerating
        const lockedValues = this.preserveLockedValues();

        const roster = Object.fromEntries(this.LOCATIONS.map(loc => [loc.name, Object.fromEntries(this.ROSTER_TIMES.map(t => [t, new Array(loc.needed).fill('')]))]));
        const assignmentsByStaff = Object.fromEntries(presentStaff.map(s => [s.id, []]));
        const staffMap = Object.fromEntries(presentStaff.map(s => [s.id, s]));
        const shortfalls = [];
        const isWeekend = ['Saturday', 'Sunday'].includes(document.getElementById('rosterDay').value);
        const verticalPatrolTracker = new Set();

        const assignStaffToSlot = (time, locName, positionIndex) => {
            // Check if this slot is locked
            const lockKey = `${locName}-${time}`;
            if (lockedValues[lockKey]) {
                roster[locName][time][positionIndex] = lockedValues[lockKey];
                const staffId = lockedValues[lockKey];
                if (staffId && assignmentsByStaff[staffId]) {
                    assignmentsByStaff[staffId].push(time);
                    if (locName === 'Vertical Patrol' || locName === 'Tango Papa') verticalPatrolTracker.add(staffId);
                }
                return;
            }

            const staffPool = presentStaff.map(s => s.id).sort(() => Math.random() - 0.5);
            for (const staffId of staffPool) {
                const staffMember = staffMap[staffId];
                const isAlreadyAssigned = assignmentsByStaff[staffId].includes(time);
                const isonBreak = this.isOnBreak(staffMember, time);
                const isHhmdMismatch = (locName === 'HHMD' && staffMember.hhmd !== 'Yes');
                const isPatrolDuplicate = ((locName === 'Vertical Patrol' || locName === 'Tango Papa') && verticalPatrolTracker.has(staffId));

                if (isAlreadyAssigned || isonBreak || isHhmdMismatch || isPatrolDuplicate) continue;
                
                roster[locName][time][positionIndex] = staffId;
                assignmentsByStaff[staffId].push(time);
                if (locName === 'Vertical Patrol' || locName === 'Tango Papa') verticalPatrolTracker.add(staffId);
                return; 
            }
            shortfalls.push(`Shortfall: ${locName} at ${time}.`);
        };

        this.ROSTER_TIMES.forEach(time => {
            this.OUTPUT_ORDER.forEach(locName => {
                if (this.CRITICAL_DUTIES[locName] && !this.CRITICAL_DUTIES[locName].includes(time)) return;
                if (locName === "Report Room" && isWeekend) return;

                const needed = this.LOCATIONS.find(l => l.name === locName).needed;
                for (let i = 0; i < needed; i++) {
                    if (roster[locName][time][i] === '') assignStaffToSlot(time, locName, i);
                }
            });
        });

        this.generatedRoster = roster;
        this.displayRoster(roster);
        
        // Apply padlocks after roster is displayed
        setTimeout(() => {
            applyPadlocks();
        }, 100);
        
        if (shortfalls.length > 0) [...new Set(shortfalls)].forEach(msg => this.showNotification(msg, 'warning'));
        
        this.addRosterActionButtons();
    },

    preserveLockedValues() {
        const lockedValues = {};
        const locked = JSON.parse(localStorage.getItem("lockedCells") || "{}");
        
        document.querySelectorAll("td[data-location='Vertical Patrol']").forEach(td => {
            const time = td.getAttribute("data-time");
            const key = `Vertical Patrol-${time}`;
            if (locked[key]) {
                const input = td.querySelector('.roster-input');
                if (input && input.value.trim()) {
                    lockedValues[key] = input.value.trim();
                }
            }
        });
        
        return lockedValues;
    },
    
    isOnBreak: (staff, timeSlot) => {
        if (!staff || !staff.breakStart || !staff.breakEnd) return false;
        const timeToMins = t => { let [h,m] = t.split(':').map(Number); return (h<12?h+24:h)*60+m; };
        const start = timeToMins(staff.breakStart), end = timeToMins(staff.breakEnd), slot = timeToMins(timeSlot);
        return start >= end ? false : (slot >= start && slot < end);
    },
    
    // --- DISPLAY & EXPORT ---
    displayRoster: function(roster) {
        const container = document.getElementById("rosterContainer");
        const isWeekend = ['Saturday', 'Sunday'].includes(document.getElementById('rosterDay').value);
        const tableHead = `<thead><tr><th class="text-left"><div class="p-3">Location</div></th>${this.ROSTER_TIMES.map(t => `<th class="text-center p-3">${t}</th>`).join('')}</tr></thead>`;
        
        const tableBody = this.OUTPUT_ORDER.map(locName => {
            const locConfig = this.LOCATIONS.find(l => l.name === locName);
            let locationCell = `<td class="text-slate-700"><div class="location-cell-content">${locName}</div></td>`;
            const timeCells = this.ROSTER_TIMES.map(time => {
                let content = '', classes = [], isApplicable = true;
                if ((this.CRITICAL_DUTIES[locName] && !this.CRITICAL_DUTIES[locName].includes(time)) || (locName === "Report Room" && isWeekend)) {
                    isApplicable = false;
                }
                
                if (isApplicable) {
                    for (let i = 0; i < locConfig.needed; i++) {
                        const assignedStaffId = roster[locName]?.[time]?.[i] || '';
                        content += `<input type="text" list="staff-id-list" value="${assignedStaffId}" data-loc="${locName}" data-time="${time}" data-index="${i}" class="roster-input" placeholder="--">`;
                    }
                }
                
                if (!isApplicable) classes.push('not-applicable');
                else if (!content.includes('value=""') && content.includes('value="')) {}
                else classes.push('empty-assignable-cell');

                return `<td class="${classes.join(' ')}" data-location="${locName}" data-time="${time}"><div class="roster-cell-wrapper">${content}</div></td>`;
            }).join('');
            return `<tr>${locationCell}${timeCells}</tr>`;
        }).join('');

        container.innerHTML = `<table id="editableRoster" class="styled-table">${tableHead}<tbody>${tableBody}</tbody></table>`;
        container.querySelectorAll('.roster-input').forEach(input => input.addEventListener('change', (e) => this.handleCellChange(e)));
        
        this.validateAllCells();
        setTimeout(() => document.getElementById('rosterContainerWrapper').classList.remove('opacity-0'), 50);
    },

    downloadPDF: function() {
        if (!this.generatedRoster) return this.showNotification('No roster to download.', 'error');
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: "landscape", unit: "mm", format: "a4" });
            const rosterDate = document.getElementById('rosterDate').value, rosterDay = document.getElementById('rosterDay').value;
            doc.setFontSize(16);
            doc.text(`Staff Roster - ${rosterDate} (${rosterDay})`, 14, 15);
            const specialNotes = { "20:00": "@ 20:30", "01:00": "@ 01:30", "06:00": "@ 06:30" };
            const mainRosterBody = this.OUTPUT_ORDER.map(locName => {
                const rowData = this.ROSTER_TIMES.map(time => {
                    let staffText = (this.generatedRoster[locName]?.[time] || []).filter(Boolean).join(' | ');
                    if (locName === 'Vertical Patrol' && staffText && specialNotes[time]) return `${staffText}\n${specialNotes[time]}`;
                    if (locName === 'Tango Papa' && !this.CRITICAL_DUTIES['Tango Papa'].includes(time)) return '';
                    return staffText;
                });
                return [locName, ...rowData];
            });
            doc.autoTable({
                head: [['Location', ...this.ROSTER_TIMES]], body: mainRosterBody, startY: 22, theme: 'grid',
                styles: { fontSize: 6, cellPadding: 1, halign: 'center', valign: 'middle' },
                headStyles: { fillColor: [45, 55, 72], textColor: 255, fontSize: 7 },
                columnStyles: { 0: { fontStyle: "bold", cellWidth: 28, halign: 'left' } },
                didParseCell: (data) => { if (data.row.raw[0] === 'Vertical Patrol' && data.cell.text.length > 1 && data.cell.text[1].startsWith('@')) data.cell.styles.fontSize = 4.5; }
            });
            doc.setFontSize(10);
            const staffBody = this.staffDataCache.filter(s => s.attendance === 'Yes').map(s => [s.id, s.name, `${s.breakStart || 'N/A'} - ${s.breakEnd || 'N/A'}`]);
            doc.autoTable({ head: [['Staff ID', 'Name', 'Break Time']], body: staffBody, startY: doc.autoTable.previous.finalY + 8, theme: 'striped', styles: { fontSize: 8 }, headStyles: { fillColor: [124, 58, 237] }, columnStyles: { 1: { cellWidth: 40 } }, margin: { left: 14 } });
            
            const blobUrl = doc.output('bloburl');
            document.getElementById('pdfDownloadLink').href = blobUrl;
            document.getElementById('pdfPreview').src = blobUrl;
            document.getElementById('pdfModal').style.display = 'flex';
        } catch (e) { console.error("PDF Generation Error:", e); this.showNotification('Error creating PDF.', 'error'); }
    },
    
    // --- Helper & Event Functions ---
    initializeDate: function() { 
        const today = new Date(); 
        document.getElementById("rosterDate").valueAsDate = today; 
        document.getElementById("rosterDay").value = today.toLocaleDateString('en-US', { weekday: 'long' }); 
    },
    
    setupEventListeners: function() { 
        document.getElementById("addStaffBtn").addEventListener("click", () => this.addStaff()); 
        document.getElementById("generateRosterBtn").addEventListener("click", () => this.runRosterGeneration()); 
        document.getElementById("shuffleBreaksBtn").addEventListener("click", () => this.shuffleBreaks()); 
        document.getElementById("closePdfBtn").addEventListener("click", () => this.closePdfModal()); 
    },
    
    renderStaffTable: function(staffList) { 
        const tableBody = document.getElementById("staffTable").querySelector("tbody"); 
        tableBody.innerHTML = staffList.map((staff, index) => ` 
            <tr data-index="${index}"> 
                <td class="bg-white"><div class="p-2"><input data-field="id" class="w-20 p-1 border rounded" type="text" value="${staff.id || ""}"></div></td> 
                <td><div class="p-2"><input data-field="name" class="w-28 p-1 border rounded" type="text" value="${staff.name || ""}"></div></td> 
                <td><div class="p-2 flex items-center gap-1"><input type="time" data-field="breakStart" value="${staff.breakStart || "22:00"}" step="1800" class="w-24 p-1 border rounded"><input type="time" data-field="breakEnd" value="${staff.breakEnd || "00:00"}" step="1800" class="w-24 p-1 border rounded"></div></td> 
                <td><div class="p-2"><select data-field="hhmd" class="p-1 border rounded bg-white"><option value="Yes" ${"Yes" === staff.hhmd ? "selected" : ""}>Yes</option><option value="No" ${"Yes" !== staff.hhmd ? "selected" : ""}>No</option></select></div></td> 
                <td><div class="p-2"><select data-field="attendance" class="p-1 border rounded bg-white"><option value="Yes" ${"No" !== staff.attendance ? "selected" : ""}>Yes</option><option value="No" ${"No" === staff.attendance ? "selected" : ""}>No</option></select></div></td> 
                <td><div class="p-2"><input type="checkbox" data-field="locked" ${staff.locked ? "checked" : ""} class="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500"></div></td> 
                <td><div class="p-2"><button class="remove-btn text-red-600 hover:text-red-800 font-semibold">Remove
								</button></div></td> 
            </tr> 
        `).join(''); 
        
        tableBody.querySelectorAll("tr").forEach(row => { 
            row.querySelectorAll("input, select").forEach(input => input.addEventListener("change", (e) => this.updateStaff(e))); 
            row.querySelector(".remove-btn").addEventListener("click", (e) => this.deleteStaff(e)); 
        }); 
    },
    
    addStaff: function() { 
        const newStaff = { 
            id: `S${Date.now().toString().slice(-4)}`, 
            name: "New Staff", 
            breakStart: "22:00", 
            breakEnd: "00:00", 
            hhmd: "No", 
            attendance: "Yes", 
            locked: false 
        };
        this.staffDataCache.push(newStaff);
        this.renderStaffTable(this.staffDataCache);
        this.updateStaffCount();
        this.updateStaffDatalist();
        this.showNotification("Added new staff member.", "success"); 
    },
    
    updateStaff: function(event) { 
        const row = event.target.closest("tr"); 
        const index = parseInt(row.dataset.index);
        const field = event.target.dataset.field;
        const value = event.target.type === 'checkbox' ? event.target.checked : event.target.value;
        
        this.staffDataCache[index][field] = value;
        this.updateStaffCount();
        this.updateStaffDatalist();
        if (this.generatedRoster) this.validateAllCells();
    },
    
    deleteStaff: function(event) { 
        const row = event.target.closest("tr"); 
        const index = parseInt(row.dataset.index);
        const staffId = this.staffDataCache[index].id || "this staff member"; 
        
        this.staffDataCache.splice(index, 1);
        this.renderStaffTable(this.staffDataCache);
        this.updateStaffCount();
        this.updateStaffDatalist();
        this.showNotification(`${staffId} has been removed.`, "success"); 
    },
    
    shuffleBreaks: function() { 
        const presentUnlocked = this.staffDataCache.filter(s => s.attendance === 'Yes' && !s.locked); 
        if (presentUnlocked.length < 2) return this.showNotification("Not enough staff to shuffle breaks.", "warning"); 
        
        let breakTimes = presentUnlocked.map(s => ({ start: s.breakStart, end: s.breakEnd })); 
        for (let i = breakTimes.length - 1; i > 0; i--) { 
            const j = Math.floor(Math.random() * (i + 1)); 
            [breakTimes[i], breakTimes[j]] = [breakTimes[j], breakTimes[i]]; 
        } 
        
        presentUnlocked.forEach((staff, index) => {
            staff.breakStart = breakTimes[index].start;
            staff.breakEnd = breakTimes[index].end;
        });
        
        this.renderStaffTable(this.staffDataCache);
        this.showNotification("Break times shuffled.", "success"); 
    },
    
    handleCellChange: function(event) {
        const { loc, time, index } = event.target.dataset;
        this.generatedRoster[loc][time][parseInt(index, 10)] = event.target.value;
        this.validateAllCells();
    },

    validateAllCells: function() {
        document.querySelectorAll('td.conflict-cell').forEach(cell => cell.classList.remove('conflict-cell'));
        const timeSlotUsage = {};
        
        document.querySelectorAll('.roster-input').forEach(input => {
            const time = input.dataset.time;
            const cell = input.closest('td');
            const inputValue = input.value.trim();
            if (!time || !inputValue) return;

            if (!timeSlotUsage[time]) timeSlotUsage[time] = {};
            const staffIds = inputValue.split(/[\s,;\/]+/).filter(id => id);

            staffIds.forEach(staffId => {
                if (!timeSlotUsage[time][staffId]) timeSlotUsage[time][staffId] = [];
                timeSlotUsage[time][staffId].push(cell);
                const staffMember = this.staffDataCache.find(s => s.id === staffId);
                if (staffMember && this.isOnBreak(staffMember, time)) cell.classList.add('conflict-cell');
            });
        });

        for (const time in timeSlotUsage) {
            for (const staffId in timeSlotUsage[time]) {
                if (timeSlotUsage[time][staffId].length > 1) {
                    timeSlotUsage[time][staffId].forEach(cell => cell.classList.add('conflict-cell'));
                }
            }
        }
    },

    addRosterActionButtons: function() { 
        document.getElementById("rosterActions")?.remove(); 
        let buttonsHTML = ` 
            <div id="rosterActions" class="mt-6 flex flex-wrap gap-4 justify-center"> 
                <button id="regenerateRosterBtn" class="btn bg-slate-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-slate-700 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>
                    Regenerate
                </button> 
                <button id="copyTSVBtn" class="btn bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-blue-700 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path></svg>
                    Copy
                </button> 
                <button id="downloadPDFBtn" class="btn bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-red-700 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd"></path></svg>
                    Download PDF
                </button> 
            </div>
        `; 
        document.getElementById("rosterContainerWrapper").insertAdjacentHTML("beforeend", buttonsHTML); 
        document.getElementById("regenerateRosterBtn").addEventListener("click", () => this.runRosterGeneration()); 
        document.getElementById("copyTSVBtn").addEventListener("click", () => this.copyTSV()); 
        document.getElementById("downloadPDFBtn").addEventListener("click", () => this.downloadPDF()); 
    },
    
    copyTSV: function() { 
        if (!this.generatedRoster) return this.showNotification("No roster to copy.", "error"); 
        const tsv = this.OUTPUT_ORDER.map(loc => `${loc}\t${this.ROSTER_TIMES.map(time => (this.generatedRoster[loc]?.[time] || []).join(" | ")).join("\t")}`).join("\n"); 
        navigator.clipboard.writeText(`Location\t${this.ROSTER_TIMES.join("\t")}\n${tsv}`).then(() => this.showNotification("Roster copied!", "success"),() => this.showNotification("Failed to copy.", "error")); 
    },
    
    closePdfModal: function() { 
        const preview = document.getElementById('pdfPreview'); 
        if (preview.src.startsWith('blob:')) URL.revokeObjectURL(preview.src); 
        preview.src = 'about:blank'; 
        document.getElementById('pdfModal').style.display = 'none'; 
    },
    
    showNotification: function(message, type = "info") { 
        const container = document.getElementById("notification-container"); 
        const colors = {success: "green", error: "red", warning: "yellow", info: "blue"}; 
        const alertDiv = document.createElement("div"); 
        alertDiv.className = `border-l-4 p-4 rounded-r-lg bg-${colors[type]}-100 border-${colors[type]}-500 text-${colors[type]}-700 shadow-md`; 
        alertDiv.innerHTML = `<p class="font-bold">${type.charAt(0).toUpperCase() + type.slice(1)}</p><p>${message}</p>`; 
        container.appendChild(alertDiv); 
        setTimeout(() => { 
            alertDiv.style.transition = "opacity 0.5s ease"; 
            alertDiv.style.opacity = "0"; 
            setTimeout(() => alertDiv.remove(), 500); 
        }, 5000); 
    },
    
    clearNotifications: function() { 
        document.getElementById('notification-container').innerHTML = ''; 
    }
};

// Initialize the system when the page loads
document.addEventListener('DOMContentLoaded', function() {
    rosterSystem.init();
});
</script>

</body>
</html>