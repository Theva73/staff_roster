<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Roster System v5.9K - Final Corrected Logic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, addDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAP7b4KcwRYPMZjNc2TWsNqMvC3ywImhOM",
            authDomain: "roster-4a997.firebaseapp.com",
            projectId: "roster-4a997",
            storageBucket: "roster-4a997.appspot.com",
            messagingSenderId: "901381868881",
            appId: "1:901381868881:web:92930481d6c1c85fedd770"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.firebase = {
             collection, getDocs, doc, setDoc, addDoc, deleteDoc, onSnapshot, query
        };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn:hover { transform: translateY(-1px); }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 1000px; border-radius: 0.5rem; }
        #editableRoster th, #editableRoster td, #staffTable th, #staffTable td { white-space: nowrap; }
        #staffTable td:nth-child(2), #staffTable th:nth-child(2) { white-space: normal; }
        #editableRoster thead th:first-child, #editableRoster tbody td:first-child,
        #staffTable thead th:first-child, #staffTable tbody td:first-child { position: sticky; left: 0; z-index: 10; background-color: white; }
        #editableRoster thead th:first-child, #staffTable thead th:first-child { z-index: 20; background-color: #f3f4f6; }
        .not-applicable { background-color: #e5e7eb; }
        .location-cell-multiline { line-height: 1.2; padding-top: 4px; padding-bottom: 4px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-indigo-600">Staff Roster System v5.9K</h1>
            <p class="text-lg text-gray-500 mt-2">Final Corrected Logic</p>
        </header>

        <!-- UI sections (unchanged) -->
        <div class="card p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                <div><label for="rosterDate" class="font-semibold text-gray-700">Roster Date:</label><input type="date" id="rosterDate" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
                <div><label for="rosterDay" class="font-semibold text-gray-700">Day:</label><select id="rosterDay" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option></select></div>
                <div class="text-center md:text-right"><span class="text-lg font-semibold">Working Staff:</span><span id="staffCount" class="text-2xl font-bold text-indigo-600 ml-2">0</span></div>
            </div>
        </div>
        <div class="card p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Staff Management (Live from Cloud)</h2>
            <div class="overflow-x-auto">
                <table id="staffTable" class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"><tr><th class="sticky left-0 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff ID</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Break Time</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HHMD Eligible</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Attendance</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lock</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr></thead><tbody class="bg-white divide-y divide-gray-200"></tbody></table>
            </div>
            <div class="mt-6 flex flex-wrap gap-4 justify-center"><button id="addStaffBtn" class="btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-indigo-700">Add Staff</button><button id="shuffleBreaksBtn" class="btn bg-purple-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-purple-700">Shuffle Breaks</button></div>
        </div>
        <div class="card p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Roster Controls</h2>
            <div class="flex justify-center"><button id="generateRosterBtn" class="btn bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-green-700 text-lg">Generate Roster</button></div>
            <div id="notification-container" class="mt-4 space-y-2"></div>
            <div id="rosterContainer" class="mt-2 overflow-x-auto"></div>
        </div>
    </div>
    <div id="pdfModal" class="modal"><div class="modal-content"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">PDF Preview</h3><div><a id="pdfDownloadLink" href="#" download="roster.pdf" class="btn bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-blue-700 mr-4">Download Now</a><button id="closePdfBtn" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button></div></div><iframe id="pdfPreview" class="w-full h-[75vh]"></iframe></div></div>

<script type="module">
const rosterSystem = {
    // --- CONFIG & STATE (Unchanged) ---
    ROSTER_TIMES: ["20:00", "20:30", "21:00", "22:00", "23:00", "00:00", "01:00", "01:30", "02:00", "03:00", "04:00", "05:00", "06:00", "06:30", "07:00"],
    LOCATIONS: [ { name: "Pass Counter", needed: 2, isMultiStaff: true }, { name: "HHMD", needed: 1 }, { name: "Lobby", needed: 2, isMultiStaff: true }, { name: "Guard House", needed: 1 }, { name: "Vertical Patrol", needed: 1 }, { name: "Report Room", needed: 1 }, { name: "Tango Papa", needed: 1 } ],
    OUTPUT_ORDER: ["Pass Counter", "HHMD", "Guard House", "Lobby", "Report Room", "Vertical Patrol", "Tango Papa"],
    CRITICAL_DUTIES: { "Vertical Patrol": ["20:30", "23:00", "01:30", "04:00", "06:30"], "Report Room": ["20:00", "21:00"], "Tango Papa": ["07:00"] },
    
    generatedRoster: null, staffDataCache: [], db: null, firebase: null,

    // --- INITIALIZATION (Unchanged) ---
    async init() {
        await new Promise(r => { const i = setInterval(() => { if (window.db && window.firebase) { clearInterval(i); this.db = window.db; this.firebase = window.firebase; console.log("Roster System v5.9K Initialized"); r(); } }, 50); });
        this.setupEventListeners(); this.initializeDate(); this.listenForStaffUpdates();
    },
    initializeDate() { const t=new Date(),e=t.toISOString().split("T")[0];document.getElementById("rosterDate").value=e;const s=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];document.getElementById("rosterDay").value=s[t.getDay()]},
    setupEventListeners() { document.getElementById("addStaffBtn").addEventListener("click",()=>this.addStaffToFirestore()),document.getElementById("generateRosterBtn").addEventListener("click",()=>this.runRosterGeneration()),document.getElementById("shuffleBreaksBtn").addEventListener("click",()=>this.shuffleBreaks()),document.getElementById("closePdfBtn").addEventListener("click",()=>this.closePdfModal())},
    
    // --- FIREBASE DATA MANAGEMENT (Unchanged) ---
    listenForStaffUpdates() { const { collection: e, query: t, onSnapshot: s } = this.firebase, o = t(e(this.db, "staff")); s(o, e => { const t = []; e.forEach(e => { t.push({ docId: e.id, ...e.data() }) }), this.staffDataCache = t.sort((e, t) => (e.id || "").localeCompare(t.id || "")), this.renderStaffTable(this.staffDataCache), this.updateStaffCount() }) },
    renderStaffTable(e) { const t = document.getElementById("staffTable").querySelector("tbody"); t.innerHTML = "", e.forEach(e => { const s = t.insertRow(); s.dataset.docId = e.docId, s.innerHTML = ` <td class="sticky left-0 bg-white px-6 py-4"><input data-field="id" class="w-24 p-1 border rounded" type="text" value="${e.id || ""}"></td> <td class="px-6 py-4"><input data-field="name" class="w-36 p-1 border rounded" type="text" value="${e.name || ""}"></td> <td class="px-6 py-4"> <div class="flex items-center gap-1"> <input type="time" data-field="breakStart" value="${e.breakStart || "22:00"}" step="1800" class="p-1 border rounded"> <span>-</span> <input type="time" data-field="breakEnd" value="${e.breakEnd || "00:00"}" step="1800" class="p-1 border rounded"> </div> </td> <td class="px-6 py-4"><select data-field="hhmd" class="p-1 border rounded"><option value="Yes" ${"Yes" === e.hhmd ? "selected" : ""}>Yes</option><option value="No" ${"Yes" !== e.hhmd ? "selected" : ""}>No</option></select></td> <td class="px-6 py-4"><select data-field="attendance" class="p-1 border rounded"><option value="Yes" ${"No" !== e.attendance ? "selected" : ""}>Yes</option><option value="No" ${"No" === e.attendance ? "selected" : ""}>No</option></select></td> <td class="px-6 py-4"><input type="checkbox" data-field="locked" ${e.locked ? "checked" : ""} class="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500"></td> <td class="px-6 py-4"><button class="remove-btn text-red-600 hover:text-red-800 font-semibold">Remove</button></td> `, s.querySelectorAll("input, select").forEach(t => t.addEventListener("change", e => this.updateStaffInFirestore(e))), s.querySelector(".remove-btn").addEventListener("click", e => this.deleteStaffFromFirestore(e)) }) },
    async addStaffToFirestore() { const { collection: e, addDoc: t } = this.firebase; try { await t(e(this.db, "staff"), { id: `S${Date.now().toString().slice(-4)}`, name: "New Staff", breakStart: "22:00", breakEnd: "00:00", hhmd: "No", attendance: "Yes", locked: !1, createdAt: new Date }), this.showNotification("Added new staff member.", "success") } catch (e) { this.showNotification("Error adding staff member.", "error") } },
    async updateStaffInFirestore(e) { const { doc: t, setDoc: s } = this.firebase, o = e.target.closest("tr"), a = o.dataset.docId, n = { id: o.querySelector('[data-field="id"]').value, name: o.querySelector('[data-field="name"]').value, breakStart: o.querySelector('[data-field="breakStart"]').value, breakEnd: o.querySelector('[data-field="breakEnd"]').value, hhmd: o.querySelector('[data-field="hhmd"]').value, attendance: o.querySelector('[data-field="attendance"]').value, locked: o.querySelector('[data-field="locked"]').checked }; try { await s(t(this.db, "staff", a), n, { merge: !0 }) } catch (e) { this.showNotification("Error updating staff member.", "error") } },
    async deleteStaffFromFirestore(e) { const { doc: t, deleteDoc: s } = this.firebase, o = e.target.closest("tr"), a = o.dataset.docId; confirm(`Are you sure you want to remove staff member ${o.querySelector("[data-field=id]").value}?`) && await s(t(this.db, "staff", a)) },
    async saveRosterToFirestore(e) { const { doc: t, setDoc: s } = this.firebase, o = document.getElementById("rosterDate").value; if (o) { const a = { date: o, day: document.getElementById("rosterDay").value, roster: e, createdAt: new Date }; try { await s(t(this.db, "rosters", o), a), this.showNotification(`Roster for ${o} saved to cloud successfully!`, "success") } catch (e) { this.showNotification("Could not save roster to the cloud.", "error") } } else this.showNotification("Please select a valid date before saving.", "error") },
    updateStaffCount() { const e = this.staffDataCache.filter(e => "Yes" === e.attendance).length; document.getElementById("staffCount").textContent = e },
    async shuffleBreaks() { const e = this.staffDataCache.filter(e => "Yes" === e.attendance && !e.locked); if (e.length < 2) return void this.showNotification("Not enough unlocked, present staff to shuffle breaks.", "warning"); let t = e.map(e => ({ start: e.breakStart, end: e.breakEnd })); for (let e = t.length - 1; e > 0; e--) { const s = Math.floor(Math.random() * (e + 1));[t[e], t[s]] = [t[s], t[e]] } const { doc: s, setDoc: o } = this.firebase; let a = 0; const n = []; e.forEach(e => { const i = { breakStart: t[a].start, breakEnd: t[a].end }; n.push(o(s(this.db, "staff", e.docId), i, { merge: !0 })), a++ }); try { await Promise.all(n), this.showNotification("Break times have been shuffled in the cloud.", "success") } catch (e) { this.showNotification("An error occurred while shuffling breaks.", "error") } },
    
    // --- COMPLIANCE LOGIC ---
    /**
     * THE DEFINITIVE FIX: This logic correctly creates a linear timeline from the start of the shift,
     * which makes checking for break conflicts simple and robust. This fixes all previously
     * reported issues related to overnight and boundary-condition breaks.
     */
    timeToMinutes(timeStr) {
        if (!timeStr || typeof timeStr !== 'string' || !timeStr.includes(':')) return -1;
        let [hours, minutes] = timeStr.trim().split(':').map(Number);
        if (isNaN(hours) || isNaN(minutes)) return -1;
        
        // This is the key: normalize the timeline so it's always increasing.
        // A time like 01:00 is treated as the 25th hour, 02:00 as the 26th, etc.,
        // relative to the start of the shift at 20:00.
        if (hours < 20) {
            hours += 24;
        }
        return (hours * 60) + minutes;
    },

    isOnBreak(staff, timeSlot) {
        const startMins = this.timeToMinutes(staff.breakStart);
        const endMins = this.timeToMinutes(staff.breakEnd);
        const slotMins = this.timeToMinutes(timeSlot);

        if (startMins === -1 || endMins === -1 || slotMins === -1) {
            return false; // Invalid time data prevents a break
        }
        
        // If start and end are the same, it's not a break.
        if (startMins === endMins) {
            return false;
        }

        // Because the timeline is now linear, a simple check is all that's needed.
        // The break interval is [start, end), so staff are on break AT the start time
        // and become free AT the end time. This is the correct operational logic.
        return slotMins >= startMins && slotMins < endMins;
    },
    
    // --- GENERATION FLOW (Unchanged) ---
    runRosterGeneration() {
        this.clearNotifications();
        document.getElementById('rosterContainer').innerHTML = '';
        const staff = this.staffDataCache.filter(s => s.attendance === 'Yes');
        if (staff.length === 0) { this.showNotification("Cannot generate roster. No staff marked as present.", 'error'); return; }
        
        const roster = this.initializeRoster();
        const staffAvailability = this.initializeStaffAvailability(staff);
        const shortfalls = [];
        const isWeekend = ['Saturday', 'Sunday'].includes(document.getElementById('rosterDay').value);

        this.assignCriticalDuties(roster, staffAvailability, isWeekend, shortfalls);
        this.assignStandardDuties(roster, staffAvailability, isWeekend, shortfalls);
        
        this.generatedRoster = roster;
        this.displayRoster(this.generatedRoster);
        if (shortfalls.length > 0) { shortfalls.forEach(msg => this.showNotification(msg, 'warning')); }
        this.saveRosterToFirestore(this.generatedRoster);
        this.addRosterActionButtons();
    },
    initializeRoster() { const r={};this.LOCATIONS.forEach(l=>{r[l.name]={};this.ROSTER_TIMES.forEach(t=>r[l.name][t]=[])});return r; },
    initializeStaffAvailability(staffList) { const a={};staffList.forEach(s=>{a[s.id]={data:s,assignedSlots:[]}});return a; },
    findAvailableStaff(staffAvailability, timeSlot, locationName) {
        const availableStaff = Object.values(staffAvailability).filter(staff => {
            const isAlreadyAssigned = staff.assignedSlots.includes(timeSlot);
            const isEligible = locationName !== "HHMD" || staff.data.hhmd === "Yes";
            const onBreak = this.isOnBreak(staff.data, timeSlot);
            return !onBreak && !isAlreadyAssigned && isEligible;
        });
        availableStaff.sort((a, b) => a.assignedSlots.length - b.assignedSlots.length);
        return availableStaff.length > 0 ? availableStaff[0] : null;
    },
    assignStaff(roster, staff, timeSlot, locationName) { roster[locationName][timeSlot].push(staff.data.id); staff.assignedSlots.push(timeSlot); },
    assignCriticalDuties(roster, staffAvailability, isWeekend, shortfalls) { for(const l in this.CRITICAL_DUTIES){if(isWeekend&&"Report Room"===l)continue;this.CRITICAL_DUTIES[l].forEach(t=>{const s=this.findAvailableStaff(staffAvailability,t,l);s?this.assignStaff(roster,s,t,l):shortfalls.push(`CRITICAL SHORTFALL: No staff for ${l} at ${t}.`)})} },
    assignStandardDuties(roster, staffAvailability, isWeekend, shortfalls) { const t=this.OUTPUT_ORDER.filter(l=>!this.CRITICAL_DUTIES.hasOwnProperty(l));t.forEach(l=>{const o=this.LOCATIONS.find(s=>s.name===l);this.ROSTER_TIMES.forEach(s=>{const e=o.needed;for(let a=roster[l][s].length;a<e;a++){const d=this.findAvailableStaff(staffAvailability,s,l);if(d)this.assignStaff(roster,d,s,l);else{shortfalls.push(`Shortfall: ${l} at ${s}.`);break}}})}) },
    
    // --- DISPLAY & EXPORT (Unchanged) ---
    displayRoster(roster) {
        const container = document.getElementById("rosterContainer");
        let tableHTML = `<table id="editableRoster" class="min-w-full divide-y divide-gray-200 mt-4"><thead class="bg-gray-100"><tr><th class="sticky left-0 bg-gray-100 px-4 py-2 text-left text-sm font-semibold text-gray-700">Location</th>`;
        this.ROSTER_TIMES.forEach(time => { tableHTML += `<th class="px-4 py-2 text-center text-sm font-semibold text-gray-700">${time}</th>` });
        tableHTML += "</tr></thead><tbody class=\"bg-white\">";
        const isWeekend = ['Saturday', 'Sunday'].includes(document.getElementById('rosterDay').value);
        this.OUTPUT_ORDER.filter(loc => loc !== "Tango Papa").forEach(locName => {
            let isCombinedRow = locName === "Vertical Patrol";
            const location = this.LOCATIONS.find(l => l.name === locName);
            let locationCellHTML = isCombinedRow ? `Vertical Patrol<br>Tango Papa` : locName;
            tableHTML += `<tr class="border-b"><td class="sticky left-0 bg-white px-4 py-2 font-medium text-gray-900 ${isCombinedRow ? 'location-cell-multiline' : ''}">${locationCellHTML}</td>`;
            this.ROSTER_TIMES.forEach(timeSlot => {
                let cellText = roster[locName][timeSlot].join(location.isMultiStaff ? " | " : ", ");
                let cellClass = "";
                if(isCombinedRow) {
                    const vpStaff = roster['Vertical Patrol'][timeSlot];
                    const tpStaff = roster['Tango Papa'][timeSlot];
                    const isVpCritical = this.CRITICAL_DUTIES['Vertical Patrol'].includes(timeSlot);
                    const isTpCritical = this.CRITICAL_DUTIES['Tango Papa'].includes(timeSlot);
                    let vpText = isVpCritical ? vpStaff.join(', ') : '';
                    let tpText = isTpCritical ? tpStaff.join(', ') : '';
                    cellText = `${vpText}${vpText && tpText ? '<br>' : ''}${tpText}`;
                    if(isVpCritical || isTpCritical) {
                        cellClass = (isVpCritical && !vpStaff.length) || (isTpCritical && !tpStaff.length) ? 'bg-red-100' : 'bg-blue-100 font-bold';
                    } else {
                        cellClass = 'not-applicable';
                    }
                } else {
                    const isCritical = this.CRITICAL_DUTIES.hasOwnProperty(locName) && this.CRITICAL_DUTIES[locName].includes(timeSlot);
                    if (isCritical) { cellClass = roster[locName][timeSlot].length < location.needed ? "bg-red-100" : "bg-blue-100 font-bold"; }
                    else if (this.CRITICAL_DUTIES.hasOwnProperty(locName)) { cellClass = "not-applicable"; cellText = ""; }
                }
                if (locName === "Report Room" && isWeekend) { cellClass = "not-applicable"; cellText = ""; }
                tableHTML += `<td class="text-center px-4 py-2 ${cellClass}">${cellText}</td>`;
            });
            tableHTML += "</tr>";
        });
        tableHTML += "</tbody></table>";
        container.innerHTML = tableHTML;
    },
    addRosterActionButtons() { document.getElementById("rosterActions")?.remove();let e=document.getElementById("rosterContainer"),t=`<div id="rosterActions" class="mt-6 flex flex-wrap gap-4 justify-center"><button id="copyTSVBtn" class="btn bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-blue-700">Copy for Excel</button><button id="downloadPDFBtn" class="btn bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-red-700">Download PDF</button></div>`;e.insertAdjacentHTML("beforeend",t),document.getElementById("copyTSVBtn").addEventListener("click",()=>this.copyTSV()),document.getElementById("downloadPDFBtn").addEventListener("click",()=>this.downloadPDF())},
    copyTSV() { if(!this.generatedRoster)return void this.showNotification("No roster to copy.","error");let e="Location\t"+this.ROSTER_TIMES.join("\t")+"\n";this.OUTPUT_ORDER.forEach(t=>{const s=this.LOCATIONS.find(e=>e.name===t);e+=t+"\t"+this.ROSTER_TIMES.map(e=>this.generatedRoster[t][e].join(s.isMultiStaff?" | ":", ")).join("\t")+"\n"}),navigator.clipboard.writeText(e).then(()=>this.showNotification("Roster copied to clipboard!","success"),()=>this.showNotification("Failed to copy.","error"))},
    downloadPDF() {
        if (!this.generatedRoster) { this.showNotification('No roster to download.', 'error'); return; }
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: "landscape", unit: "mm", format: "a4" });
            const rosterDate = document.getElementById('rosterDate').value; 
            const rosterDay = document.getElementById('rosterDay').value;
            doc.setFontSize(16); doc.text(`Staff Roster - ${rosterDate} (${rosterDay})`, 14, 15);
            const pdfBody = this.OUTPUT_ORDER.filter(loc => loc !== 'Tango Papa').map(locName => {
                let displayName = locName;
                const rowData = this.ROSTER_TIMES.map(time => {
                    let cellContent = this.generatedRoster[locName][time].join(this.LOCATIONS.find(l=>l.name===locName).isMultiStaff ? ' | ' : ', ');
                    if (locName === 'Vertical Patrol') {
                        displayName = 'Vertical Patrol\nTango Papa';
                        const vpStaff = this.generatedRoster['Vertical Patrol'][time];
                        const tpStaff = this.generatedRoster['Tango Papa'][time];
                        const isVpCritical = this.CRITICAL_DUTIES['Vertical Patrol'].includes(time);
                        const isTpCritical = this.CRITICAL_DUTIES['Tango Papa'].includes(time);
                        let vpText = isVpCritical ? vpStaff.join(', ') : '';
                        let tpText = isTpCritical ? tpStaff.join(', ') : '';
                        cellContent = `${vpText}${vpText && tpText ? '\n' : ''}${tpText}`;
                    }
                    return cellContent;
                });
                return [displayName, ...rowData];
            });
            const rosterHead = [['Location', ...this.ROSTER_TIMES]];
            doc.autoTable({ head: rosterHead, body: pdfBody, startY: 22, theme: 'grid', styles: { fontSize: 6, cellPadding: 1, halign: 'center', valign: 'middle' }, headStyles: { fillColor: [45, 55, 72], textColor: 255, fontSize: 7, halign: 'center' }, columnStyles: { 0: { fontStyle: "bold", cellWidth: 28, halign: 'left' } } });
            const presentStaff = this.staffDataCache.filter(s => s.attendance === 'Yes');
            const staffHead = [['Staff ID', 'Name', 'Break Time']];
            const staffBody = presentStaff.map(staff => [ staff.id, staff.name, `${staff.breakStart} - ${staff.breakEnd}` ]);
            doc.autoTable({ head: staffHead, body: staffBody, startY: doc.autoTable.previous.finalY + 8, theme: 'striped', styles: { fontSize: 8, cellPadding: 1.5 }, headStyles: { fillColor: [124, 58, 237], textColor: 255 }, columnStyles: { 1: { cellWidth: 40 } }, margin: { left: 14 } });
            const pdfBlob = doc.output('blob');
            const blobUrl = URL.createObjectURL(pdfBlob);
            document.getElementById('pdfDownloadLink').href = blobUrl;
            document.getElementById('pdfDownloadLink').download = `roster_${rosterDate}.pdf`;
            document.getElementById('pdfPreview').src = blobUrl;
            document.getElementById('pdfModal').style.display = 'flex';
            this.showNotification('PDF generated. Preview is ready.', 'success');
        } catch (e) { console.error("PDF Generation/Download Error:", e); this.showNotification('An error occurred while creating the PDF.', 'error'); }
    },
    closePdfModal() {
        const downloadLink = document.getElementById('pdfDownloadLink');
        const previewFrame = document.getElementById('pdfPreview');
        if (downloadLink.href.startsWith('blob:')) { URL.revokeObjectURL(downloadLink.href); }
        downloadLink.href = '#';
        previewFrame.src = 'about:blank';
        document.getElementById('pdfModal').style.display = 'none';
    },
    clearNotifications() { document.getElementById("notification-container").innerHTML=""},
    showNotification(e,t="info") { const s=document.getElementById("notification-container"),o={success:"green",error:"red",warning:"yellow",info:"blue"},a=document.createElement("div");a.className=`border-l-4 p-4 bg-${o[t]}-100 border-${o[t]}-500 text-${o[t]}-700`,a.innerHTML=`<p class="font-bold">${t.charAt(0).toUpperCase()+t.slice(1)}</p><p>${e}</p>`,s.appendChild(a),setTimeout(()=>{a.style.transition="opacity 0.5s ease",a.style.opacity="0",setTimeout(()=>a.remove(),500)},5e3)}
};

rosterSystem.init();

</script>
</body>
</html>