<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staff Roster Management System</title>
  
  <!-- External libraries for Excel and PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 20px; 
      text-align: center;
      font-size: 14px;
      background-color: #f3f4f6;
      margin: 0; 
    }
    h2 { color: #1a1a1a; margin-bottom: 25px; }
    .date-container, .gap-policy-container {
      margin: 20px 0;
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    .date-container > div, .gap-policy-container > div {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin: 20px 0;
      background: white;
    }
    th, td { 
      border: 1px solid #ddd; 
      padding: 8px; 
      text-align: center; 
    }
    th { background-color: #f4f4f4; }
    input, select { padding: 4px; text-align: center; font-size: 12px; }
    .button-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 12px 0;
      align-items: center;
    }
    .button-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .roster-btn {
      background-color: #6B7280;
      color: white;
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }
    .roster-btn:hover { background-color: #4B5563; }
    .remove-btn {
      background-color: #6B7280;
      color: white;
      padding: 1px 6px;
      font-size: 11px;
      border-radius: 3px;
      border: none;
      cursor: pointer;
    }
    .break-time-container { display: flex; align-items: center; gap: 5px; }
    .shortfall-note { color: red; font-weight: bold; font-size: 12px; }
    #importFile { display: none; }
    #rosterContainer { overflow-x: auto; }
    .staff-input, .time-input, .staff-select { font-size: 12px; }
    #breakListContainer {
      position: fixed;
      bottom: 10px;
      left: 10px;
      width: 180px;
      max-height: 300px;
      overflow: auto;
      background-color: #fff;
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 12px;
      text-align: left;
      cursor: move;
    }
  </style>
</head>

<body>
  <h2>Staff Roster Management System</h2>

  <!-- Date, Day, Staff Count -->
  <div class="date-container">
    <div>
      <label for="rosterDate">Roster Date:</label>
      <input type="date" id="rosterDate">
    </div>
    <div>
      <label for="rosterDay">Day:</label>
      <select id="rosterDay">
        <option value="Monday">Monday</option>
        <option value="Tuesday">Tuesday</option>
        <option value="Wednesday">Wednesday</option>
        <option value="Thursday">Thursday</option>
        <option value="Friday">Friday</option>
        <option value="Saturday">Saturday</option>
        <option value="Sunday">Sunday</option>
      </select>
    </div>
    <div>
      <label>Working Staff:</label>
      <span id="staffCount">0</span>
    </div>
  </div>

  <!-- Gap Policy: Slider from 30 to 120 minutes -->
  <div class="gap-policy-container">
    <div>
      <label for="gapThreshold">Gap Threshold (minutes): </label>
      <input type="range" id="gapThreshold" min="30" max="120" step="15" value="120">
      <span id="gapThresholdValue">120</span>
    </div>
  </div>

  <!-- Staff Table -->
  <table id="staffTable">
    <thead>
      <tr>
        <th>Staff ID</th>
        <th>Name</th>
        <th>Break Time</th>
        <th>HHMD Eligible</th>
        <th>Attendance</th>
        <th>Lock</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Action Buttons -->
  <div class="button-container">
    <div class="button-row">
      <button class="roster-btn" id="addStaffBtn">Add Staff</button>
      <button class="roster-btn" id="importDataBtn">Import Data</button>
      <button class="roster-btn" id="exportDataBtn">Export Data</button>
    </div>
    <div class="button-row">
      <button class="roster-btn" id="shuffleBreaksBtn">Shuffle Breaks</button>
      <button class="roster-btn" id="generateRosterBtn">Generate Roster</button>
      <button class="roster-btn" id="copyTSVBtn">Copy Roster</button>
    </div>
    <div class="button-row">
      <button class="roster-btn" id="downloadExcelBtn">Excel</button>
      <button class="roster-btn" id="downloadCSVBtn">CSV</button>
      <button class="roster-btn" id="downloadPDFBtn">PDF</button>
      <button class="roster-btn" id="toggleBreakNoteBtn">Toggle Break Note</button>
    </div>
  </div>

  <!-- Hidden file input for importData() -->
  <input type="file" id="importFile" accept=".json" />

  <!-- Generated Roster Display -->
  <h3>Generated Roster</h3>
  <div id="rosterContainer"></div>

  <!-- Roster Health Summary -->
  <h4>Roster Health</h4>
  <div id="notesContainer"></div>

  <!-- Floating Break Time Note (draggable) -->
  <div id="breakListContainer">
    <strong>Staff Break Times</strong><br><br>
  </div>

  <script>
    /************************************************************
     * Updated Roster System with Fixes:
     * - Enhanced break time enforcement across all functions.
     * - Retained slider for gap threshold flexibility (30-120 minutes), but prioritized predefined rules (breaks, critical slots).
     * - Strengthened gap threshold checks with proactive enforcement.
     * - Robust critical location assignment with expanded Vertical Patrol slots.
     * - Standardized time format handling for robustness.
     ************************************************************/

    // Core constants
    const STORAGE_KEY = 'staffListData';
    const ROSTER_TIMES = [
      "20:00", "20:30", "21:00", "22:00", "23:00",
      "00:00", "01:00", "01:30", "02:00", "03:00",
      "04:00", "05:00", "06:00", "07:00", "07:30"
    ];
    const PRIORITY = [
      { location: "Pass Counter", needed: 2 },
      { location: "HHMD", needed: 1 },
      { location: "Lobby", needed: 2 },
      { location: "Guard House", needed: 1 },
      { location: "Vertical Patrol", needed: 1 },
      { location: "Report Room", needed: 1 },
      { location: "Tango Papa", needed: 1 }
    ];
    const OUTPUT_ORDER = [
      "Pass Counter", "HHMD", "Lobby", "Guard House",
      "Vertical Patrol", "Report Room", "Tango Papa"
    ];
    const BREAK_TIME_POOL = [
      "20:00-21:30", "21:30-23:30", "22:00-00:00",
      "23:00-01:00", "00:00-02:00", "01:30-03:30",
      "02:00-04:00", "03:00-05:00", "04:00-06:00",
      "05:00-07:00", "06:00-08:00"
    ];
    const CRITICAL_LOCATIONS = {
      "Vertical Patrol": ["20:30", "23:00", "01:30", "06:00"],
      "Report Room": ["20:00", "21:00"],
      "Tango Papa": ["07:30"]
    };

    // Roster system object
    const rosterSystem = {
      init: function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('rosterDate').value = today;
        const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        document.getElementById('rosterDay').value = days[new Date().getDay()];
        document.getElementById('rosterDate').addEventListener('change', () => {
          const dateValue = document.getElementById('rosterDate').value;
          const dateObj = new Date(dateValue + 'T00:00:00');
          if (!isNaN(dateObj.getTime())) {
            document.getElementById('rosterDay').value = days[dateObj.getDay()];
          }
        });
        const gapSlider = document.getElementById("gapThreshold");
        const gapDisplay = document.getElementById("gapThresholdValue");
        gapSlider.addEventListener("input", function() {
          gapDisplay.innerText = this.value;
        });
        gapSlider.addEventListener("change", function() {
          rosterSystem.generateRoster();
        });
        document.getElementById('addStaffBtn').addEventListener('click', () => this.addStaff());
        document.getElementById('importDataBtn').addEventListener('click', () => this.importData());
        document.getElementById('exportDataBtn').addEventListener('click', () => this.exportData());
        document.getElementById('shuffleBreaksBtn').addEventListener('click', () => this.shuffleBreakTimes());
        document.getElementById('generateRosterBtn').addEventListener('click', () => this.generateRoster());
        document.getElementById('copyTSVBtn').addEventListener('click', () => this.copyTSV());
        document.getElementById('downloadExcelBtn').addEventListener('click', () => this.downloadRoster('excel'));
        document.getElementById('downloadCSVBtn').addEventListener('click', () => this.downloadRoster('csv'));
        document.getElementById('downloadPDFBtn').addEventListener('click', () => this.downloadRoster('pdf'));
        document.getElementById('toggleBreakNoteBtn').addEventListener('click', this.toggleBreakNote);
        this.makeDraggable(document.getElementById('breakListContainer'));
        this.loadStaffList();
      },

      loadStaffList: function() {
        const stored = localStorage.getItem(STORAGE_KEY);
        const tbody = document.getElementById("staffTable").querySelector("tbody");
        if (stored) {
          const staffList = JSON.parse(stored);
          tbody.innerHTML = "";
          staffList.forEach(staff => {
            tbody.innerHTML += this.getStaffRowHTML(staff);
          });
        } else {
          this.addStaff();
        }
        this.addListenersToAllRows();
        this.updateStaffCount();
      },

      saveStaffList: function() {
        const staffList = this.getCurrentStaffList();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(staffList));
      },

      getCurrentStaffList: function() {
        const rows = document.getElementById("staffTable").querySelector("tbody").rows;
        const staffList = [];
        for (let row of rows) {
          const startTime = row.cells[2].querySelectorAll("input[type='time']")[0].value;
          const endTime = row.cells[2].querySelectorAll("input[type='time']")[1].value;
          const formatTime = (time) => {
            if (!time) return "00:00";
            const [hours, minutes] = time.split(":").map(Number);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
          };
          const breakTime = `${formatTime(startTime)}-${formatTime(endTime)}`;
          const staffData = {
            staffID: row.cells[0].querySelector("input").value.trim(),
            name: row.cells[1].querySelector("input").value.trim(),
            breakTime: breakTime,
            hhmdEligible: row.cells[3].querySelector("select").value,
            attendance: row.cells[4].querySelector("select").value,
            locked: row.cells[5].querySelector("input[type='checkbox']").checked,
            assigned: row.dataset.assigned ? JSON.parse(row.dataset.assigned) : []
          };
          staffList.push(staffData);
        }
        return staffList;
      },

      getStaffRowHTML: function(staff = {}) {
        let [startVal, endVal] = ["21:30", "23:30"];
        if (staff.breakTime && staff.breakTime.includes("-")) {
          [startVal, endVal] = staff.breakTime.split("-");
        }
        return `
          <tr data-assigned='${JSON.stringify(staff.assigned || [])}'>
            <td><input type="text" value="${staff.staffID || ''}" class="staff-input"></td>
            <td><input type="text" value="${staff.name || ''}" class="staff-input"></td>
            <td>
              <div class="break-time-container">
                <input type="time" value="${startVal}" step="1800" class="time-input">
                <span>-</span>
                <input type="time" value="${endVal}" step="1800" class="time-input">
              </div>
            </td>
            <td>
              <select class="staff-select">
                <option value="Yes" ${staff.hhmdEligible==="Yes"?"selected":""}>Yes</option>
                <option value="No" ${staff.hhmdEligible==="No"?"selected":""}>No</option>
              </select>
            </td>
            <td>
              <select class="staff-select">
                <option value="Yes" ${staff.attendance==="Yes"?"selected":""}>Yes</option>
                <option value="No" ${staff.attendance==="No"?"selected":""}>No</option>
              </select>
            </td>
            <td>
              <input type="checkbox" ${staff.locked ? "checked" : ""}>
            </td>
            <td><button class="remove-btn" data-staff-id="${staff.staffID || ''}">Remove</button></td>
          </tr>
        `;
      },

      addStaff: function() {
        const tbody = document.getElementById("staffTable").querySelector("tbody");
        const newStaff = {
          staffID: "",
          name: "",
          breakTime: "21:30-23:30",
          hhmdEligible: "No",
          attendance: "Yes",
          locked: false,
          assigned: []
        };
        tbody.insertAdjacentHTML("beforeend", this.getStaffRowHTML(newStaff));
        this.addListenersToAllRows();
        this.saveStaffList();
        this.updateStaffCount();
      },

      removeRow: function(button) {
        button.closest("tr").remove();
        this.saveStaffList();
        this.updateStaffCount();
      },

      addListenersToAllRows: function() {
        const tbody = document.getElementById("staffTable").querySelector("tbody");
        const self = this;
        const inputs = tbody.querySelectorAll("input, select");
        inputs.forEach(inp => {
          inp.addEventListener("change", () => {
            self.saveStaffList();
            self.updateStaffCount();
          });
        });
        const removeButtons = tbody.querySelectorAll(".remove-btn");
        removeButtons.forEach(btn => {
          btn.removeEventListener("click", btn._clickHandler);
          btn._clickHandler = function() {
            self.removeRow(this);
          };
          btn.addEventListener("click", btn._clickHandler);
        });
      },

      updateStaffCount: function() {
        const staffList = this.getCurrentStaffList();
        const workingCount = staffList.filter(st => st.attendance === "Yes").length;
        document.getElementById("staffCount").textContent = workingCount;
      },

      shuffleBreakTimes: function() {
        const staffList = this.getCurrentStaffList();
        staffList.forEach(st => {
          if (st.attendance === "Yes" && !st.locked) {
            const randomIndex = Math.floor(Math.random() * BREAK_TIME_POOL.length);
            st.breakTime = BREAK_TIME_POOL[randomIndex];
          }
        });
        this.applyStaffListToTable(staffList);
        this.saveStaffList();
        this.displayBreakList();
        alert("Break times shuffled!");
      },

      applyStaffListToTable: function(staffList) {
        const tbody = document.getElementById("staffTable").querySelector("tbody");
        tbody.innerHTML = "";
        staffList.forEach(staff => {
          tbody.innerHTML += this.getStaffRowHTML(staff);
        });
        this.addListenersToAllRows();
        this.updateStaffCount();
      },

      findEmergencyStaff: function(staffList, slot) {
        for (let st of staffList) {
          if (
            st.attendance === " adult" && 
            !this.isOnBreak(st, slot) && 
            !this.isDoubleBooked(st, slot)
          ) {
            return st;
          }
        }
        return null;
      },

      findAvailableStaff: function(staffList, slot, loc) {
        for (let st of staffList) {
          if (
            st.attendance === "Yes" && 
            !this.isOnBreak(st, slot) &&
            !this.isDoubleBooked(st, slot) &&
            !(loc === "HHMD" && st.hhmdEligible !== "Yes")
          ) {
            return st;
          }
        }
        return null;
      },

      autoCorrectRoster: function(roster, staffList, conflicts) {
        let correctionsMade = false;
        for (let loc in conflicts) {
          for (let slot in conflicts[loc]) {
            let staffObj = conflicts[loc][slot];
            for (let staffID in staffObj) {
              let staff = staffList.find(s => s.staffID === staffID);
              if (staff) {
                this.removeAssignment(roster, staff, slot, loc);
                let currentAssignments = roster[loc][slot].split(",").map(s => s.trim()).filter(Boolean);
                let uniqueAssignments = [...new Set(currentAssignments)];
                roster[loc][slot] = uniqueAssignments.join(", ");
                
                if (slot !== "07:30" || loc === "Tango Papa") {
                  let newStaff = this.findEmergencyStaff(staffList.filter(s => s.staffID !== staffID), slot);
                  if (newStaff && !this.wouldCauseConflict(roster, newStaff, slot, loc) && !this.isOnBreak(newStaff, slot)) {
                    roster[loc][slot] = roster[loc][slot] ? `${roster[loc][slot]}, ${newStaff.staffID}` : newStaff.staffID;
                    newStaff.assigned.push({ slot, location: loc });
                    correctionsMade = true;
                  } else {
                    correctionsMade = true; // Removal counts as correction
                  }
                } else {
                  correctionsMade = true; // Removal for 07:30 non-Tango Papa
                }
              }
            }
          }
        }
        return correctionsMade;
      },

      wouldCauseConflict: function(roster, staff, slot, loc) {
        if (this.isOnBreak(staff, slot) || this.isDoubleBooked(staff, slot)) return true;
        
        const assignments = staff.assigned.concat({ slot, location: loc });
        assignments.sort((a, b) => ROSTER_TIMES.indexOf(a.slot) - ROSTER_TIMES.indexOf(b.slot));
        const gapThreshold = parseInt(document.getElementById("gapThreshold").value, 10);
        for (let i = 0; i < assignments.length - 1; i++) {
          const currTime = this.timeToMinutes(assignments[i].slot);
          const nextTime = this.timeToMinutes(assignments[i + 1].slot);
          if (assignments[i].location === loc || assignments[i + 1].location === loc) {
            if (Math.abs(nextTime - currTime) < gapThreshold) {
              return true;
            }
          }
        }
        return false;
      },

      removeAssignment: function(roster, staff, slot, loc) {
        staff.assigned = staff.assigned.filter(a => !(a.slot === slot && a.location === loc));
        if (roster[loc] && roster[loc][slot]) {
          let ids = roster[loc][slot].split(",").map(s => s.trim()).filter(Boolean);
          ids = ids.filter(id => id !== staff.staffID);
          roster[loc][slot] = ids.join(", ");
        }
      },

      timeToMinutes: function(timeStr) {
        if (!timeStr || typeof timeStr !== "string" || !timeStr.match(/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/)) {
          console.warn​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​