<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Roster System v8.0 - Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

```
<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc, addDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyAP7b4KcwRYPMZjNc2TWsNqMvC3ywImhOM",
        authDomain: "roster-4a997.firebaseapp.com",
        projectId: "roster-4a997",
        storageBucket: "roster-4a997.appspot.com",
        messagingSenderId: "901381868881",
        appId: "1:901381868881:web:92930481d6c1c85fedd770"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.db = db;
    window.firebase = { collection, getDocs, doc, setDoc, addDoc, deleteDoc, onSnapshot, query };
</script>

<style>
    body { 
        font-family: 'Inter', sans-serif; 
        background-color: #f8fafc;
    }
    .card { 
        background-color: white; 
        border-radius: 0.75rem; 
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        border: 1px solid #e2e8f0;
    }
    .btn:hover { 
        transform: translateY(-2px); 
        box-shadow: 0 7px 14px rgba(50,50,93,.1), 0 3px 6px rgba(0,0,0,.08);
    }
    .modal { 
        display: none; 
        position: fixed; 
        z-index: 50; 
        left: 0; 
        top: 0; 
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.6); 
        align-items: center; 
        justify-content: center; 
        backdrop-filter: blur(4px); 
    }
    .modal-content { 
        background-color: #fefefe; 
        margin: 5% auto; 
        padding: 24px; 
        border: 1px solid #e5e7eb; 
        width: 90%; 
        max-width: 1000px; 
        border-radius: 0.5rem; 
    }
    
    .table-container {
         overflow-x: auto;
         -webkit-overflow-scrolling: touch;
    }
    .styled-table {
        border-collapse: separate;
        border-spacing: 0;
        min-width: 100%;
    }
    .styled-table thead th {
         background-color: #f1f5f9;
         font-weight: 600;
         color: #334155;
         font-size: 0.8rem;
    }
    .styled-table th, .styled-table td {
        white-space: nowrap;
        padding: 0;
        border-bottom: 1px solid #e2e8f0;
        vertical-align: middle;
        text-align: center;
    }
    .styled-table thead th:first-child, .styled-table tbody td:first-child {
        position: sticky;
        left: 0;
        z-index: 10;
        text-align: left;
    }
    .styled-table tbody td:first-child {
        background-color: #f8fafc;
        font-weight: 500;
        border-right: 1px solid #e2e8f0;
    }
    .styled-table tbody tr:last-child td {
        border-bottom: none;
    }
    .styled-table tbody tr:hover td, .styled-table tbody tr:hover td:first-child {
         background-color: #f0f9ff;
    }
    
    .location-cell-content { padding: 10px 12px; }
    .location-cell-multiline { line-height: 1.3; font-size: 0.9rem; }

    .roster-cell-wrapper {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 6px;
        padding: 6px 4px;
        min-height: 50px;
    }

    .roster-cell select { 
        -webkit-appearance: none; 
        -moz-appearance: none; 
        appearance: none; 
        background-color: transparent; 
        border: none; 
        width: 100%;
        height: 24px; 
        text-align: center; 
        font-size: 0.8rem; 
        font-weight: 500; 
        color: #1e293b;
    }
    .roster-cell select:focus { outline: 2px solid #3b82f6; border-radius: 4px; }
    
    .not-applicable { background-color: #f1f5f9; }
    .empty-assignable-cell { 
        background-image: repeating-linear-gradient(-45deg, #fdfdff, #fdfdff 5px, #f1f5f9 5px, #f1f5f9 10px);
    }
    .conflict-cell { 
        background-color: #fef2f2 !important; 
        box-shadow: inset 0 0 0 2px #ef4444; 
    }
    .break-conflict { 
        background-color: #fef3c7 !important; 
        box-shadow: inset 0 0 0 2px #f59e0b; 
    }
</style>
```

</head>
<body class="bg-slate-100 text-slate-800">

```
<div class="container mx-auto p-2 sm:p-4 md:p-6 lg:p-8">
    <header class="text-center my-8">
        <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-500">Staff Roster System</h1>
        <p class="text-lg text-slate-500 mt-2">v8.0 - Conflict-Free Edition</p>
    </header>

    <div class="card p-4 md:p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 items-center">
            <div>
                <label for="rosterDate" class="font-semibold text-slate-700 text-sm">Roster Date:</label>
                <input type="date" id="rosterDate" class="mt-1 w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="rosterDay" class="font-semibold text-slate-700 text-sm">Day:</label>
                <select id="rosterDay" class="mt-1 w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option>
                </select>
            </div>
            <div class="text-center md:text-right">
                <span class="text-base font-semibold">Working Staff:</span>
                <span id="staffCount" class="text-2xl font-bold text-indigo-600 ml-2">0</span>
            </div>
        </div>
    </div>

    <div class="card p-4 md:p-6 mb-8">
        <h2 class="text-xl md:text-2xl font-bold text-slate-800 mb-4 border-b border-slate-200 pb-3">Staff Management (Live)</h2>
        <div class="table-container">
            <table id="staffTable" class="styled-table">
                <thead>
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Break</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">HHMD</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Present</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Lock</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white"></tbody>
            </table>
        </div>
        <div class="mt-6 flex flex-wrap gap-4 justify-center">
            <button id="addStaffBtn" class="btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-indigo-700">Add New Staff</button>
            <button id="shuffleBreaksBtn" class="btn bg-purple-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-purple-700">Shuffle Breaks</button>
        </div>
    </div>

    <div class="card p-6">
        <div class="flex flex-col items-center">
             <h2 class="text-2xl font-bold text-slate-800 mb-4">Generate Roster</h2>
             <button id="generateRosterBtn" class="btn bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-green-700 text-lg">Generate</button>
        </div>
        <div id="notification-container" class="mt-4 space-y-2"></div>
        <div id="rosterContainerWrapper" class="mt-4 opacity-0 transition-opacity duration-500">
            <div id="rosterContainer" class="table-container rounded-lg border border-slate-200 shadow-sm"></div>
        </div>
    </div>
</div>

<div id="pdfModal" class="modal">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">PDF Preview</h3>
            <div>
                <a id="pdfDownloadLink" href="#" download="roster.pdf" class="btn bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-blue-700 mr-4">Download Now</a>
                <button id="closePdfBtn" class="text-slate-500 hover:text-slate-800 text-3xl font-bold">&times;</button>
            </div>
        </div>
        <iframe id="pdfPreview" class="w-full h-[75vh] border border-slate-300 rounded"></iframe>
    </div>
</div>
```

<script type="module">
const rosterSystem = {
    ROSTER_TIMES: ["20:00", "21:00", "22:00", "23:00", "00:00", "01:00", "02:00", "03:00", "04:00", "05:00", "06:00", "07:00"],
    LOCATIONS: [ 
        { name: "Pass Counter", needed: 2, isMultiStaff: true }, 
        { name: "HHMD", needed: 1 }, 
        { name: "Lobby", needed: 2, isMultiStaff: true }, 
        { name: "Guard House", needed: 1 }, 
        { name: "Vertical Patrol", needed: 1 }, 
        { name: "Report Room", needed: 1 }, 
        { name: "Tango Papa", needed: 1 } 
    ],
    OUTPUT_ORDER: ["Pass Counter", "HHMD", "Guard House", "Lobby", "Report Room", "Vertical Patrol", "Tango Papa"],
    CRITICAL_DUTIES: { 
        "Vertical Patrol": ["20:00", "23:00", "01:00", "04:00", "06:00"], 
        "Report Room": ["20:00", "21:00"], 
        "Tango Papa": ["07:00"] 
    },
    
    generatedRoster: null, 
    staffDataCache: [], 
    db: null, 
    firebase: null,

    async init() {
        await new Promise(resolve => { 
            const interval = setInterval(() => { 
                if (window.db && window.firebase) { 
                    clearInterval(interval); 
                    this.db = window.db; 
                    this.firebase = window.firebase; 
                    console.log("Roster System v8.0 - Conflict-Free Edition Initialized"); 
                    resolve(); 
                } 
            }, 50); 
        });
        this.setupEventListeners(); 
        this.initializeDate(); 
        this.listenForStaffUpdates();
    },

    initializeDate() { 
        const today = new Date(); 
        const year = today.getFullYear(); 
        const mm = String(today.getMonth() + 1).padStart(2, '0'); 
        const dd = String(today.getDate()).padStart(2, '0'); 
        document.getElementById("rosterDate").value = `${year}-${mm}-${dd}`; 
        document.getElementById("rosterDay").value = today.toLocaleDateString('en-US', { weekday: 'long' }); 
    },

    setupEventListeners() { 
        document.getElementById("addStaffBtn").addEventListener("click", () => this.addStaffToFirestore()); 
        document.getElementById("generateRosterBtn").addEventListener("click", () => this.runRosterGeneration()); 
        document.getElementById("shuffleBreaksBtn").addEventListener("click", () => this.shuffleBreaks()); 
        document.getElementById("closePdfBtn").addEventListener("click", () => this.closePdfModal()); 
    },
    
    listenForStaffUpdates() {
        const { collection, query, onSnapshot } = this.firebase;
        onSnapshot(query(collection(this.db, "staff")), (querySnapshot) => {
            this.staffDataCache = querySnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() })).sort((a, b) => (a.id || "").localeCompare(b.id || ""));
            this.renderStaffTable(this.staffDataCache);
            this.updateStaffCount();
            if (this.generatedRoster) this.validateAllCells();
        });
    },

    updateStaffCount() {
        document.getElementById("staffCount").textContent = this.staffDataCache.filter(s => s.attendance === 'Yes').length;
    },

    timeToMinutes(timeStr) { 
        if (typeof timeStr !== 'string' || !timeStr.includes(':')) return -1; 
        let [hours, minutes] = timeStr.trim().split(':').map(Number); 
        if (isNaN(hours) || isNaN(minutes)) return -1; 
        if (hours < 8) hours += 24;
        return (hours * 60) + minutes; 
    },

    isOnBreak(staff, timeSlot) { 
        if (!staff || !staff.breakStart || !staff.breakEnd) return false; 
        const start = this.timeToMinutes(staff.breakStart); 
        const end = this.timeToMinutes(staff.breakEnd); 
        const slot = this.timeToMinutes(timeSlot); 
        if (start === -1 || end === -1 || slot === -1) return false; 
        
        if (start > end) {
            return slot >= start || slot < end;
        } else {
            return slot >= start && slot < end;
        }
    },

    getStaffAssignmentsAtTime(roster, timeSlot) {
        const assignments = {};
        for (const location of this.OUTPUT_ORDER) {
            if (roster[location] && roster[location][timeSlot]) {
                for (let i = 0; i < roster[location][timeSlot].length; i++) {
                    const staffId = roster[location][timeSlot][i];
                    if (staffId) {
                        if (!assignments[staffId]) assignments[staffId] = [];
                        assignments[staffId].push({location, position: i});
                    }
                }
            }
        }
        return assignments;
    },

    hasConflict(roster, staffId, timeSlot, targetLocation, targetPosition) {
        const staff = this.staffDataCache.find(s => s.id === staffId);
        if (staff && this.isOnBreak(staff, timeSlot)) {
            return { type: 'break', message: `${staffId} is on break at ${timeSlot}` };
        }

        const assignments = this.getStaffAssignmentsAtTime(roster, timeSlot);
        if (assignments[staffId]) {
            for (const assignment of assignments[staffId]) {
                if (assignment.location === targetLocation && assignment.position === targetPosition) {
                    continue;
                }
                return { 
                    type: 'double', 
                    message: `${staffId} already assigned to ${assignment.location} at ${timeSlot}` 
                };
            }
        }

        if (targetLocation === 'HHMD' && staff && staff.hhmd !== 'Yes') {
            return { type: 'qualification', message: `${staffId} not qualified for HHMD` };
        }

        return null;
    },

    async runRosterGeneration() { 
        this.clearNotifications(); 
        document.getElementById('rosterContainerWrapper').classList.add('opacity-0'); 
        
        let currentStaffData; 
        try { 
            const staffSnapshot = await this.firebase.getDocs(this.firebase.collection(this.db, "staff")); 
            currentStaffData = staffSnapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() })); 
        } catch (error) { 
            console.error("Failed to fetch latest staff data:", error); 
            this.showNotification("Could not fetch latest staff data. Roster may be incorrect.", "error"); 
            return; 
        } 
        
        const presentStaff = currentStaffData.filter(s => s.attendance === 'Yes'); 
        if (presentStaff.length === 0) return this.showNotification("No staff marked as present.", 'error'); 
        
        const roster = Object.fromEntries(
            this.LOCATIONS.map(loc => [
                loc.name, 
                Object.fromEntries(this.ROSTER_TIMES.map(t => [t, new Array(loc.needed).fill('')]))
            ])
        );
        
        const staffMap = Object.fromEntries(presentStaff.map(s => [s.id, s])); 
        const shortfalls = []; 
        const isWeekend = ['Saturday', 'Sunday'].includes(document.getElementById('rosterDay').value); 

        const assignStaffToSlot = (time, locName, positionIndex, priorityStaff = null) => { 
            let staffPool = priorityStaff ? [priorityStaff] : presentStaff.map(s => s.id);
            
            if (!priorityStaff) {
                staffPool = staffPool.sort(() => Math.random() - 0.5);
            }
            
            for (const staffId of staffPool) { 
                const conflict = this.hasConflict(roster, staffId, time, locName, positionIndex);
                
                if (!conflict) {
                    roster[locName][time][positionIndex] = staffId; 
                    return true;
                }
            } 
            
            shortfalls.push(`Shortfall: ${locName} at ${time} - No available staff.`); 
            return false;
        }; 

        for (const locName in this.CRITICAL_DUTIES) { 
            if (isWeekend && locName === "Report Room") continue; 
            const needed = this.LOCATIONS.find(l => l.name === locName).needed; 
            this.CRITICAL_DUTIES[locName].forEach(time => { 
                for (let i = 0; i < needed; i++) { 
                    assignStaffToSlot(time, locName, i); 
                } 
            }); 
        } 

        this.OUTPUT_ORDER.forEach(locName => { 
            const needed = this.LOCATIONS.find(l => l.name === locName).needed; 
            this.ROSTER_TIMES.forEach(time => { 
                for (let i = 0; i < needed; i++) { 
                    if (roster[locName][time][i] === '') { 
                        assignStaffToSlot(time, locName, i); 
                    } 
                } 
            }); 
        }); 

        this.generatedRoster = roster; 
        this.displayRoster(roster); 
        
        if (shortfalls.length > 0) { 
            [...new Set(shortfalls)].forEach(msg => this.showNotification(msg, 'warning')); 
        } else {
            this.showNotification("Roster generated successfully with no conflicts!", "success");
        }
        
        this.saveRosterToFirestore(roster); 
        this.addRosterActionButtons(); 
    },

    displayRoster(roster) { 
        const container = document.getElementById("rosterContainer"); 
        const staffOpts = '<option value="">--</option>' + this.staffDataCache.filter(s => s.attendance === 'Yes').map(s => `<option value="${s.id}">${s.id}</option>`).join(''); 
        const isWeekend = ['Saturday', 'Sunday'].includes(document.getElementById('rosterDay').value); 
        
        const tableHead = `<thead><tr><th class="text-left"><div class="p-3">Location</div></th>${this.ROSTER_TIMES.map(t => `<th class="text-center p-3">${t}</th>`).join('')}</tr></thead>`; 
        
        const tableBody = this.OUTPUT_ORDER.filter(loc => loc !== "Tango Papa").map(locName => { 
            const locConfig = this.LOCATIONS.find(l => l.name === locName); 
            const isCombined = locName === "Vertical Patrol"; 
            let locationCell = `<td class="text-slate-700"><div class="location-cell-content ${isCombined ? 'location-cell-multiline' : ''}">${isCombined ? 'Vertical Patrol<br>Tango Papa' : locName}</div></td>`; 
            
            const timeCells = this.ROSTER_TIMES.map(time => { 
                let content = '', classes = [], isApplicable = true; 
                
                if (this.CRITICAL_DUTIES[locName] && !this.CRITICAL_DUTIES[locName].includes(time)) isApplicable = false; 
                if (locName === "Report Room" && isWeekend) isApplicable = false; 
                
                if (isCombined) { 
                    const vpCrit = this.CRITICAL_DUTIES['Vertical Patrol'].includes(time); 
                    const tpCrit = this.CRITICAL_DUTIES['Tango Papa'].includes(time); 
                    if(vpCrit || tpCrit) { 
                        if(vpCrit) content += `<select data-loc="Vertical Patrol" data-time="${time}" data-index="0" class="roster-select">${staffOpts.replace(`value="${roster['Vertical Patrol'][time][0] || ''}"`, `value="${roster['Vertical Patrol'][time][0] || ''}" selected`)}</select>`; 
                        if(tpCrit) content += `<select data-loc="Tango Papa" data-time="${time}" data-index="0" class="roster-select">${staffOpts.replace(`value="${roster['Tango Papa'][time][0] || ''}"`, `value="${roster['Tango Papa'][time][0] || ''}" selected`)}</select>`; 
                    } else isApplicable = false; 
                } else if (isApplicable) { 
                    for (let i = 0; i < locConfig.needed; i++) {
                        content += `<select data-loc="${locName}" data-time="${time}" data-index="${i}" class="roster-select">${staffOpts.replace(`value="${roster[locName][time][i] || ''}"`, `value="${roster[locName][time][i] || ''}" selected`)}</select>`; 
                    }
                } 
                
                if (!isApplicable) classes.push('not-applicable'); 
                else if (content.includes('value="" selected')) classes.push('empty-assignable-cell'); 
                
                return `<td class="${classes.join(' ')}"><div class="roster-cell-wrapper">${content}</div></td>`; 
            }).join(''); 
            
            return `<tr>${locationCell}${timeCells}</tr>`; 
        }).join(''); 
        
        container.innerHTML = `<table id="editableRoster" class="styled-table">${tableHead}<tbody>${tableBody}</tbody></table>`; 
        container.querySelectorAll('.roster-select').forEach(sel => sel.addEventListener('change', (e) => this.handleCellChange(e))); 
        this.validateAllCells(); 
        setTimeout(() => document.getElementById('rosterContainerWrapper').classList.remove('opacity-0'), 50); 
    },

    handleCellChange(event) { 
        const { loc, time, index } = event.target.dataset; 
        const newStaffId = event.target.value;
        const oldStaffId = this.generatedRoster[loc][time][parseInt(index, 10)];
        
        if (newStaffId) {
            const conflict = this.hasConflict(this.generatedRoster, newStaffId, time, loc, parseInt(index, 10));
            if (conflict) {
                this.showNotification(conflict.message, 'error');
                event.target.value = oldStaffId;
                return;
            }
        }
        
        this.generatedRoster[loc][time][parseInt(index, 10)] = newStaffId; 
        this.validateAllCells(); 
        this.saveRosterToFirestore(this.generatedRoster); 
    },

    validateAllCells() { 
        document.querySelectorAll('td.conflict-cell, td.break-conflict').forEach(cell => {
            cell.classList.remove('conflict-cell', 'break-conflict');
        });
        
        this.ROSTER_TIMES.forEach(time => {
            const assignments = this.getStaffAssignmentsAtTime(this.generatedRoster, time);
            
            Object.keys(assignments).forEach(staffId => {
                const staffAssignments = assignments[staffId];
                const staff = this.staffDataCache.find(s => s.id === staffId);
                
                if (staff && this.isOnBreak(staff, time)) {
                    staffAssignments.forEach(assignment => {
                        const selector = `.roster-select[data-loc="${assignment.location}"][data-time="${time}"][data-index="${assignment.position}"]`;
                        const select = document.querySelector(selector);
                        if (select) select.closest('td').classList.add('break-conflict');
                    });
                }
                
                if (staffAssignments.length > 1) {
                    staffAssignments.forEach(assignment => {
                        const selector = `.roster-select[data-loc="${assignment.location}"][data-time="${time}"][data-index="${assignment.position}"]`;
                        const select = document.querySelector(selector);
                        if (select) select.closest('td').classList.add('conflict-cell');
                    });
                }
            });
        });
    },

    renderStaffTable(staffList) { 
        const tableBody = document.getElementById("staffTable").querySelector("tbody"); 
        tableBody.innerHTML = staffList.map(staff => `
            <tr data-doc-id="${staff.docId}"> 
                <td class="bg-white"><div class="p-2"><input data-field="id" class="w-20 p-1 border rounded" type="text" value="${staff.id || ""}"></div></td> 
                <td><div class="p-2"><input data-field="name" class="w-28 p-1 border rounded" type="text" value="${staff.name || ""}"></div></td> 
                <td><div class="p-2 flex items-center gap-1"><input type="time" data-field="breakStart" value="${staff.breakStart || "22:00"}" step="1800" class="w-24 p-1 border rounded"><input type="time" data-field="breakEnd" value="${staff.breakEnd || "00:00"}" step="1800" class="w-24 p-1 border rounded"></div></td> 
                <td><div class="p-2"><select data-field="hhmd" class="p-